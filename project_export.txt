======================================================================
== FILE: config.py
======================================================================

# config.py

class Config:
    """
    Configuration class for the Flask application.
    Stores database connection details and other settings.
    """
    SECRET_KEY = 'nishant'  # Change this to your own random string
    # --- DATABASE CONFIGURATION ---

    # The name of your SQL Server instance.
    # This is the value you use to connect in SQL Server Management Studio.
    SERVER = 'DESKTOP-29MHU7D\\MSSQLSERVER01'

    # The name of the specific database you want to connect to.
    DATABASE = 'ELGI_Dash'

    # The ODBC driver for SQL Server.
    # 'ODBC Driver 17 for SQL Server' is a common modern choice.
    # Ensure this driver is installed on the machine running the application.
    DRIVER = '{ODBC Driver 17 for SQL Server}'

    # Since we are using Windows Authentication (Integrated Security),
    # a username and password are not required in this file.
    # The connection string will specify 'Trusted_Connection=yes'.



======================================================================
== FILE: requirements.txt
======================================================================

Flask==3.0.3
pyodbc==5.1.0
pandas==2.2.2
openpyxl==3.1.2
gunicorn==21.2.0
flask-login==0.6.3

======================================================================
== FILE: app\__init__.py
======================================================================


import os
from flask import Flask
from config import Config

# Define base directory
basedir = os.path.abspath(os.path.dirname(__file__))

# Initialize Flask App
app = Flask(__name__,
            template_folder=os.path.join(os.path.dirname(basedir), 'templates'),
            static_folder=os.path.join(os.path.dirname(basedir), 'static')
            )

# Load Config
app.config.from_object(Config)

# --- Import Routes ---
# This must be at the bottom to avoid circular import errors.
# It reads the 'routes.py' file inside the 'app' folder.
from app import routes

======================================================================
== FILE: app\database.py
======================================================================


import pyodbc
from config import Config
from datetime import datetime, date

def get_db_connection():
    try:
        connection_string = (
            f"DRIVER={Config.DRIVER};"
            f"SERVER={Config.SERVER};"
            f"DATABASE={Config.DATABASE};"
            f"Trusted_Connection=yes;"
        )
        conn = pyodbc.connect(connection_string)
        return conn
    except pyodbc.Error as ex:
        sqlstate = ex.args[0]
        print(f"ERROR: Database connection failed.")
        print(f"SQLSTATE: {sqlstate}")
        print(ex)
        return None


def row_to_dict(cursor, row):
    result_dict = {}
    for i, column_description in enumerate(cursor.description):
        column_name = column_description[0]
        value = row[i]
        if column_name.upper() in ('DOJ', 'TODAY'):
            if not isinstance(value, (datetime, date)):
                value = None
        is_numeric = column_description[1] in (
            pyodbc.SQL_INTEGER, pyodbc.SQL_BIGINT, pyodbc.SQL_SMALLINT,
            pyodbc.SQL_TINYINT, pyodbc.SQL_DECIMAL, pyodbc.SQL_NUMERIC,
            pyodbc.SQL_FLOAT, pyodbc.SQL_REAL
        )

        if value is None and is_numeric:
            result_dict[column_name] = 0
        else:
            result_dict[column_name] = value

    return result_dict

======================================================================
== FILE: app\main.py
======================================================================

--- FILE NOT FOUND: app/main.py ---


======================================================================
== FILE: app\routes.py
======================================================================

import os
import pandas as pd
import numpy as np
import pyodbc
import traceback
from datetime import datetime, date, timedelta
from flask import render_template, request, jsonify, redirect, url_for, flash, send_file, session
from werkzeug.utils import secure_filename
from collections import defaultdict
import calendar
import io
from math import ceil
from app import app
from app.database import get_db_connection, row_to_dict

# --- NEW IMPORTS FOR LOGIN ---
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
from app import login_manager


class User(UserMixin):
    def __init__(self, user_id, username, name):
        self.id = user_id      # Primary Key (int)
        self.username = username
        self.name = name

    def __repr__(self):
        return f"{self.id}/{self.username}"

# --- HELPER: INITIALIZE USER TABLE (Structure Only) ---
def init_user_db():
    """Creates the users table if missing. Does NOT create default users."""
    conn = get_db_connection()
    if not conn: return
    try:
        cursor = conn.cursor()
        # Create Table Only
        cursor.execute("""
            IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='app_users' and xtype='U')
            CREATE TABLE app_users (
                user_id INT IDENTITY(1,1) PRIMARY KEY,
                username NVARCHAR(50) NOT NULL UNIQUE,
                password NVARCHAR(255) NOT NULL,
                full_name NVARCHAR(100)
            );
        """)
        conn.commit()
    except Exception as e:
        print(f"Error initializing user DB: {e}")
    finally:
        conn.close()
# --- USER LOADER (For Session) ---
@login_manager.user_loader
def load_user(user_id):
    conn = get_db_connection()
    if not conn: return None
    try:
        cursor = conn.cursor()
        # Ensure user_id is safe (int)
        cursor.execute("SELECT user_id, username, full_name FROM app_users WHERE user_id = ?", user_id)
        row = cursor.fetchone()
        if row:
            return User(row[0], row[1], row[2])
    except Exception:
        return None
    finally:
        conn.close()
    return None

# --- LOGIN ROUTES ---


@app.route('/logout')
@login_required
def logout():
    logout_user()
    flash('You have been logged out.', 'info')
    return redirect(url_for('login'))


# --- LOGIN ROUTES ---
@app.route('/login', methods=['GET', 'POST'])
def login():
    # Ensure DB table exists when visiting login
    if request.method == 'GET':
        init_user_db()

    if current_user.is_authenticated:
        return redirect(url_for('production_planning'))

    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')

        conn = get_db_connection()
        user_found = None
        
        if conn:
            try:
                cursor = conn.cursor()
                # Check credentials
                cursor.execute("SELECT user_id, username, full_name FROM app_users WHERE username = ? AND password = ?", (username, password))
                row = cursor.fetchone()
                
                if row:
                    user_found = User(row[0], row[1], row[2])
            finally:
                conn.close()

        if user_found:
            login_user(user_found)
            return redirect(request.args.get('next') or url_for('production_planning'))
        else:
            flash('Invalid username or password', 'error')

    return render_template('login.html')



UPLOAD_FOLDER = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'uploads')
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)



STAGES = [
    "Long seam", "Dish fit up", "Cirseam welding", "Part assembly",
    "Full welding", "Hydro Testing", "Powder coating", "PDI", "FG" # REVERTED to actual DB column name
]
DEFAULT_AHP_WEIGHTS = {'type': 0.5396, 'rpl': 0.2583, 'category': 0.1387, 'modified_plan': 0.0634}


FAILURE_REASONS = [
    "Machine breakdown",
    "Man power not avialable (Absentism )",
    "Dispatch stopped at HO (Excess stock at HO)",
    "Parts shortages",
    "Quality issue",
    "Planning delay",
    "Inspection delay(ASME/SPVD)",
    "RT delay",
    "Capacity issue",
    "Rejected at PDI",
    "Excess Trigger / Short Lead time btn Triggers",
    "Design / ECR Changes (R&D)",
    "Frequent Changes in Bin Qty / RPL",
    "System Issue (PO, ASN, NVC Trigger Can, etc.,)",
    "Transportation Issue (Logistics)",
    "Non-lean Trigger Short Lead Time",
    "Space Constrain at HO",
    "Trolley shortage",
    "Outsourcing delay"
]

def check_and_clear_daily_tables():
    conn = get_db_connection()
    if not conn: return

    try:
        cursor = conn.cursor()
        # ... (keep existing table check logic) ...

        # --- Determine Current Production Date (adjusting for 2 AM cutoff) ---
        now = datetime.now()
        if now.hour < 2:
            current_production_date = (now - timedelta(days=1)).date()
        else:
            current_production_date = now.date()

        current_production_date_str = current_production_date.strftime('%Y-%m-%d')

        # Check last upload date
        cursor.execute("SELECT status_value FROM app_status WHERE status_key = 'last_triggers_upload_date'")
        row_triggers = cursor.fetchone()
        last_triggers_date_str = row_triggers[0] if row_triggers and row_triggers[0] else None

        needs_trigger_reset = True
        if last_triggers_date_str:
            try:
                last_triggers_date = datetime.strptime(last_triggers_date_str, '%Y-%m-%d').date()
                if last_triggers_date >= current_production_date:
                    needs_trigger_reset = False
            except ValueError:
                pass

        if needs_trigger_reset:
            print("Performing automatic daily trigger reset...")
            # 1. Clear raw triggers table for the new day
            cursor.execute("IF OBJECT_ID('dbo.pending_triggers', 'U') IS NOT NULL DELETE FROM pending_triggers")
            
            # 2. Reset master table columns
            cursor.execute("IF OBJECT_ID('dbo.master', 'U') IS NOT NULL UPDATE master SET [Pending] = 0, [Next Pending] = 0")
            
            # NOTE: We DO NOT delete from trigger_history here. 
            # This preserves the record of the day that just finished.

            # 3. Clear timestamp and update status date
            cursor.execute("DELETE FROM app_status WHERE status_key = 'last_triggers_upload_timestamp'")
            
            upsert_sql_triggers = """
                MERGE app_status AS target
                USING (SELECT 'last_triggers_upload_date' AS status_key, ? AS status_value) AS source
                ON (target.status_key = source.status_key)
                WHEN MATCHED THEN UPDATE SET status_value = source.status_value
                WHEN NOT MATCHED THEN INSERT (status_key, status_value) VALUES (source.status_key, source.status_value);
            """
            cursor.execute(upsert_sql_triggers, current_production_date_str)
            conn.commit()
            print("Automatic reset complete. History preserved.")

    except Exception as e:
        print(f"Error during daily check/reset: {e}")
        if conn: conn.rollback()
    finally:
        if conn: conn.close()


def replace_table_with_df(df, table_name, cursor):
    cursor.execute(f"IF OBJECT_ID('dbo.{table_name}', 'U') IS NOT NULL DROP TABLE dbo.{table_name}")
    df.columns = [f"[{col.strip()}]" for col in df.columns]
    for col in df.columns:
        if 'item code' in col.lower():
            df[col] = df[col].astype(str).str.strip().str.lstrip("'")
            break
    numeric_cols = df.select_dtypes(include=np.number).columns.tolist()
    df[numeric_cols] = df[numeric_cols].fillna(0)
    df = df.replace({pd.NaT: None})
    dtype_mapping = {'int64': 'INT', 'float64': 'FLOAT', 'datetime64[ns]': 'DATETIME', 'object': 'NVARCHAR(MAX)'}
    col_definitions = []
    for col, dtype in df.dtypes.items():
        sql_type = dtype_mapping.get(str(dtype), 'NVARCHAR(MAX)')
        col_definitions.append(f"{col} {sql_type}")
    create_table_sql = f"CREATE TABLE {table_name} ({', '.join(col_definitions)})"
    cursor.execute(create_table_sql)
    if df.empty: return
    insert_sql = f"INSERT INTO {table_name} ({', '.join(df.columns)}) VALUES ({', '.join(['?' for _ in df.columns])})"
    params = [tuple(row) for row in df.itertuples(index=False, name=None)]
    cursor.executemany(insert_sql, params)


def prioritize_plan_with_ahp(df_plan, weights):
    def score_type(x):
        return 1 if str(x).strip().lower() == "lean" else 0

    def score_rpl(x):
        return 1 / (1 + float(x)) if pd.notnull(x) and x > 0 else 0

    def score_category(x):
        val = str(x).strip().lower()
        if val == "milk run":
            return 1.0
        elif val == "runner":
            return 0.75
        elif val == "repeater":
            return 0.5
        elif val == "stranger":
            return 0.25
        else:
            return 0

    plan_col = 'Modified Release plan'
    if plan_col not in df_plan.columns: plan_col = 'Daily Suggested Release Plan'

    if df_plan.empty:
        df_plan["priority_weight"] = 0
        return df_plan

    max_qty = df_plan[plan_col].max()
    df_plan["qty_score"] = df_plan[plan_col] / max_qty if max_qty > 0 else 0
    df_plan["type_score"] = df_plan["Type"].apply(score_type)
    df_plan["rpl_score"] = df_plan["RPL days to Delivery"].apply(score_rpl)
    df_plan["category_score"] = df_plan["Category"].apply(score_category)
    df_plan["priority_weight"] = (
            df_plan["type_score"] * weights.get("type", 0) +
            df_plan["rpl_score"] * weights.get("rpl", 0) +
            df_plan["category_score"] * weights.get("category", 0) +
            df_plan["qty_score"] * weights.get("modified_plan", 0)
    )

    # This final line ensures any item with a plan of 0 gets a priority of 0
    df_plan.loc[df_plan[plan_col] <= 0, 'priority_weight'] = 0

    return df_plan

# In app/routes.py

# In app/routes.py

# In app/routes.py

@app.route('/', endpoint='production_planning')
@login_required
def production_planning():
    check_and_clear_daily_tables()
    ahp_weights = session.get('ahp_weights', DEFAULT_AHP_WEIGHTS.copy())

    # --- FILTERS ---
    filter_search = request.args.get('search', '')
    filter_vertical = request.args.get('vertical', '')
    filter_category = request.args.get('category', '')
    
    # Check if this is an AJAX request for real-time filtering
    ajax_request = request.args.get('ajax')

    # Overdue View filters
    filter_trigger_type = request.args.get('trigger_type', 'All')
    filter_item_code = request.args.get('item_code', '')
    
    current_view = request.args.get('view', 'production')

    # Pagination
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    offset = (page - 1) * per_page

    conn = get_db_connection()
    plans, overdue_items = [], []
    trigger_type_list, item_code_list = [], []
    all_verticals, all_categories = [], []

    master_has_data = False
    triggers_uploaded_today = False
    plan_generated_today = False
    pagination = None
    total_pages = 1

    if conn:
        try:
            cursor = conn.cursor()

            # 1. Check Master Data & Status
            try:
                cursor.execute("SELECT COUNT(*) FROM master")
                if cursor.fetchone()[0] > 0: master_has_data = True
            except: master_has_data = False

            cursor.execute("SELECT status_value FROM app_status WHERE status_key = 'last_triggers_upload_timestamp'")
            row = cursor.fetchone()
            if row and row[0]:
                if pd.to_datetime(row[0]).date() >= datetime.now().date():
                    triggers_uploaded_today = True

            # 2. Fetch Dropdowns (Ensures RCB and others appear)
            try:
                cursor.execute("SELECT DISTINCT [Vertical] FROM Production_pl WHERE [Vertical] IS NOT NULL ORDER BY [Vertical]")
                all_verticals = [row[0] for row in cursor.fetchall()]
                
                cursor.execute("SELECT DISTINCT [Category] FROM Production_pl WHERE [Category] IS NOT NULL ORDER BY [Category]")
                all_categories = [row[0] for row in cursor.fetchall()]
            except: pass

            # 3. Fetch Production Plan (With Filters & WIP)
            try:
                base_where = " WHERE 1=1 "
                params = []

                if filter_search:
                    base_where += " AND (p.[Item code ] LIKE ? OR p.[Description] LIKE ?) "
                    params.extend([f'%{filter_search}%', f'%{filter_search}%'])
                if filter_vertical:
                    base_where += " AND p.[Vertical] = ? "
                    params.append(filter_vertical)
                if filter_category:
                    base_where += " AND p.[Category] = ? "
                    params.append(filter_category)

                # Count Total
                cursor.execute(f"SELECT COUNT(*) FROM Production_pl p {base_where}", params)
                total_items = cursor.fetchone()[0]
                
                # Check generation flag
                cursor.execute("IF OBJECT_ID('dbo.Production_pl', 'U') IS NOT NULL SELECT 1 ELSE SELECT 0")
                if cursor.fetchone()[0] == 1: plan_generated_today = True

                if total_items > 0:
                    total_pages = ceil(total_items / per_page)
                    
                    # WIP Logic
                    try:
                        all_stages = get_dynamic_stages(cursor)
                    except: all_stages = []
                    if not all_stages: all_stages = STAGES
                    wip_stages = [s for s in all_stages if s not in ['FG', 'Not Started']]
                    wip_sum_sql = " + ".join([f"ISNULL(m.[{s}], 0)" for s in wip_stages]) if wip_stages else "0"

                    sql_select_plans = f"""
                        SELECT p.*, ({wip_sum_sql}) as [WIP]
                        FROM Production_pl p
                        LEFT JOIN master m ON p.[Item code ] = m.[Item code]
                        {base_where}
                        ORDER BY p.[priority_weight] DESC
                        OFFSET ? ROWS FETCH NEXT ? ROWS ONLY
                    """
                    cursor.execute(sql_select_plans, params + [offset, per_page])
                    plans = [row_to_dict(cursor, row) for row in cursor.fetchall()]

                    pagination = {
                        'page': page, 'per_page': per_page, 'total': total_items,
                        'total_pages': total_pages, 'has_prev': page > 1, 'has_next': page < total_pages,
                        'prev_num': page - 1, 'next_num': page + 1
                    }
            except Exception as e:
                print(f"Plan Query Error: {e}")

            # 4. Fetch Overdue (Only if View is Overdue)
            if current_view == 'overdue':
                try:
                    cursor.execute("SELECT DISTINCT [TRIGGER TYPE] FROM pending_triggers WHERE [TRIGGER TYPE] IS NOT NULL")
                    trigger_type_list = [row[0] for row in cursor.fetchall()]
                    
                    sql_overdue = "SELECT * FROM pending_triggers WHERE CAST([DUE DT] AS DATE) < ?"
                    ov_params = [date.today()]
                    if filter_trigger_type != 'All':
                        sql_overdue += " AND [TRIGGER TYPE] = ?"
                        ov_params.append(filter_trigger_type)
                    if filter_item_code:
                        sql_overdue += " AND [ITEM CODE] LIKE ?"
                        ov_params.append(f"%{filter_item_code}%")
                    sql_overdue += " ORDER BY [DUE DT] ASC"
                    cursor.execute(sql_overdue, ov_params)
                    overdue_items = [row_to_dict(cursor, row) for row in cursor.fetchall()]
                except: pass

        finally:
            conn.close()

    # --- AJAX RESPONSE (JSON for JS Rendering) ---
    if ajax_request:
        return jsonify({
            'status': 'success',
            'plans': plans, 
            'total_pages': total_pages,
            'current_page': page,
            'per_page': per_page
        })

    # --- FULL PAGE RESPONSE ---
    return render_template('productionpl.html',
                           plans=plans,
                           weights=ahp_weights,
                           overdue_items=overdue_items,
                           table_exists=master_has_data,
                           triggers_uploaded_today=triggers_uploaded_today,
                           plan_generated_today=plan_generated_today,
                           all_verticals=all_verticals,
                           all_categories=all_categories,
                           filter_search=filter_search,
                           filter_vertical=filter_vertical,
                           filter_category=filter_category,
                           trigger_type_list=trigger_type_list,
                           selected_trigger_type=filter_trigger_type,
                           selected_item_code=filter_item_code,
                           pagination=pagination,
                           current_per_page=per_page)


@app.route('/wip_tracking', endpoint='wip_tracking')
@login_required
def wip_tracking():
    # 1. Get Per Page from URL
    per_page = request.args.get('per_page', 20, type=int)
    page = request.args.get('page', 1, type=int)
    offset = (page - 1) * per_page
    
    search_query = request.args.get('search', '')
    selected_type = request.args.get('type', '')
    selected_category = request.args.get('category', '')

    type_options = ['Lean', 'Non Lean']
    category_options = ['Stranger', 'Runner', 'Repeater', 'Milk Run']

    # --- GROUP DEFINITION (Ordered) ---
    BEFORE_HYDRO_GROUP = ["Long seam", "Dish fit up", "Cirseam welding", "Part assembly", "Full welding"]

    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('dashboard'))

    master_items = []
    display_stages = [] # Stages to show in table
    pagination = None

    try:
        cursor = conn.cursor()

        # 1. FETCH ALL DB STAGES
        cursor.execute("SELECT stage_name FROM manufacturing_stages ORDER BY display_order ASC")
        all_db_stages = [row[0] for row in cursor.fetchall()]

        # 2. Define Display Stages (Grouped View)
        display_stages = ['Before Hydro']
        for s in all_db_stages:
            if s not in BEFORE_HYDRO_GROUP and s != 'Not Started':
                display_stages.append(s)

        # 3. Build Query
        base_query = "SELECT * FROM master WHERE 1=1"
        count_query = "SELECT COUNT(*) FROM master WHERE 1=1"
        params = []

        if search_query:
            base_query += " AND ([Item code] LIKE ? OR [Description] LIKE ?)"
            count_query += " AND ([Item code] LIKE ? OR [Description] LIKE ?)"
            params.extend([f'%{search_query}%', f'%{search_query}%'])

        if selected_type:
            base_query += " AND [Type] = ?"
            count_query += " AND [Type] = ?"
            params.append(selected_type)

        if selected_category:
            base_query += " AND [Category] = ?"
            count_query += " AND [Category] = ?"
            params.append(selected_category)

        # 4. Pagination
        cursor.execute(count_query, params)
        total_items = cursor.fetchone()[0]
        total_pages = ceil(total_items / per_page)

        # 5. Fetch Data
        final_query = base_query + " ORDER BY [Item code] OFFSET ? ROWS FETCH NEXT ? ROWS ONLY"
        params.extend([offset, per_page])

        cursor.execute(final_query, params)
        master_items = [row_to_dict(cursor, row) for row in cursor.fetchall()]

        # 6. Process Items
        import json
        for item in master_items:
            # A. Calculate Total Inv
            current_total = 0
            for stage in all_db_stages:
                if stage in ['Not Started', 'FG']: continue
                qty = item.get(stage)
                if qty: current_total += int(qty)
            item['Total Inv'] = current_total

            # B. Calculate "Before Hydro" Group
            group_sum = 0
            breakdown = {}
            for sub in BEFORE_HYDRO_GROUP:
                q = item.get(sub, 0) or 0
                if q > 0:
                    group_sum += int(q)
                    breakdown[sub] = int(q)
            
            item['Before Hydro'] = group_sum
            item['Before_Hydro_Breakdown'] = json.dumps(breakdown)

        pagination = {
            'page': page, 'per_page': per_page, 'total': total_items,
            'total_pages': total_pages, 'has_prev': page > 1, 'has_next': page < total_pages,
            'prev_num': page - 1, 'next_num': page + 1
        }

    except Exception as e:
        flash(f"Error fetching WIP data: {e}", 'error')
        traceback.print_exc()
    finally:
        conn.close()

    return render_template('wip.html',
                           master_items=master_items,
                           stages=display_stages,
                           group_stages=BEFORE_HYDRO_GROUP, # Pass group order to frontend
                           type_options=type_options,
                           category_options=category_options,
                           selected_type=selected_type,
                           selected_category=selected_category,
                           search_query=search_query,
                           pagination=pagination,
                           current_per_page=per_page)

@app.route('/release_plan', methods=['POST'], endpoint='release_plan')
def release_plan():
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('production_planning'))

    try:
        cursor = conn.cursor()

        # 1. Sync 'Modified Release plan' from Production_pl TO 'Not Started' in master
        # FIX: Changed logic to REPLACE (=) instead of ADD (+)
        sync_sql = """
            IF EXISTS (SELECT * FROM sys.columns WHERE Name = N'Not Started' AND Object_ID = Object_ID(N'master'))
            BEGIN
                UPDATE m
                SET m.[Not Started] = p.[Modified Release plan]
                FROM master m
                INNER JOIN Production_pl p ON m.[Item code] = p.[Item code ]
                -- We update even if plan is 0, to effectively 'clear' the order if the plan changed to 0
            END
        """
        cursor.execute(sync_sql)

        # 2. Update 'Today Triggered' in Production_pl to match what was just released
        # This locks in the "Released Qty" for the day
        cursor.execute("UPDATE Production_pl SET [Today Triggered] = [Modified Release plan]")

        conn.commit()
        flash('Plan Released successfully! "Not Started" quantities have been updated (replaced).', 'success')

    except Exception as e:
        if conn: conn.rollback()
        flash(f'Error releasing plan: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()

    return redirect(url_for('production_planning'))

@app.route('/dashboard', endpoint='dashboard')
@login_required
def dashboard():
    current_view = request.args.get('view', 'overview')
    filter_type = request.args.get('type')
    filter_value = request.args.get('value')

    page = 1
    per_page = 17
    offset = (page - 1) * per_page
    pagination = None

    conn = get_db_connection()

    # --- 1. INITIALIZE DEFAULTS (Vital for preventing UndefinedError) ---
    stage_totals = {}
    top_plans = []
    vertical_overview = []
    category_overview = []
    total_wip_inventory = 0
    all_verticals_list = []
    daily_adherence = 0
    monthly_adherence = 0
    total_monthly_dispatch = 0
    monthly_trigger_adherence = 0  # <--- INITIALIZE HERE
    failure_reasons = FAILURE_REASONS
    show_failure_button = True
    current_stages = []

    # Handle DB Connection Failure
    if not conn:
        flash('Database connection failed.', 'error')
        # We must pass the default 'monthly_trigger_adherence=0' here too
        return render_template('dashboard.html', current_view='overview', stages=[], show_failure_button=False,
                               stage_totals={}, top_plans=[], pagination=None, vertical_overview=[],
                               category_overview=[],
                               total_monthly_dispatch=0, daily_adherence=0, monthly_adherence=0, 
                               monthly_trigger_adherence=0, # <--- PASS IT HERE
                               failure_reasons=[], all_verticals=[])

    try:
        cursor = conn.cursor()
        
        # --- FIX: Ensure 'Next Pending' column exists before querying ---
        cursor.execute("""
            IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'Next Pending' AND Object_ID = Object_ID(N'master'))
            ALTER TABLE master ADD [Next Pending] INT DEFAULT 0 WITH VALUES;
        """)
        conn.commit()

        current_stages = get_dynamic_stages(cursor, dashboard_only=True)

        # 1. ENSURE TABLES EXIST
        cursor.execute("""
            IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='failure_log' and xtype='U')
            CREATE TABLE failure_log (
                log_id INT IDENTITY(1,1) PRIMARY KEY,
                item_code NVARCHAR(255), failure_date DATE, failed_quantity INT, reason NVARCHAR(MAX), 
                logged_at DATETIME DEFAULT GETDATE(), CONSTRAINT UQ_failure_log UNIQUE (item_code, failure_date) 
            );
        """)
        conn.commit()

        # 2. Basic Totals
        cursor.execute("SELECT SUM(ISNULL([Total Inv], 0)) FROM master")
        total_wip_inventory = cursor.fetchone()[0] or 0

        cursor.execute("IF OBJECT_ID('dbo.Production_pl', 'U') IS NOT NULL SELECT 1 ELSE SELECT 0")
        if cursor.fetchone()[0] == 1:
            cursor.execute(
                "SELECT DISTINCT [Vertical] FROM Production_pl WHERE [Vertical] IS NOT NULL ORDER BY [Vertical]")
            all_verticals_list = [row[0] for row in cursor.fetchall()]
        else:
            all_verticals_list = []

        # 3. DAILY ADHERENCE & DISPATCH
        if all_verticals_list:
            cursor.execute("SELECT SUM(ISNULL([Pending], 0)) FROM master")
            total_daily_target = cursor.fetchone()[0] or 0
        else:
            total_daily_target = 0

        # Calculate Actual Dispatch from LOGS (2 AM Cutoff) - FROM FG TO DISPATCH
        sql_daily_actual = """
                    DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
                    DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
                    DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

                    SELECT SUM(quantity) FROM production_log 
                    WHERE from_stage = 'FG' AND to_stage = 'Dispatch' 
                    AND moved_at >= @ProductionDayStart AND moved_at < @ProductionDayEnd
                """
        cursor.execute(sql_daily_actual)
        total_daily_dispatched = cursor.fetchone()[0] or 0

        daily_adherence = (total_daily_dispatched / total_daily_target * 100) if total_daily_target > 0 else 0

        # 4. MONTHLY DISPATCH
        sql_monthly_dispatch = """
            SELECT SUM(pl.quantity) 
            FROM production_log pl
            INNER JOIN master m ON pl.item_code = m.[Item code]
            WHERE pl.to_stage IN ('Dispatch', 'Delivered') 
            AND MONTH(pl.moved_at) = MONTH(GETDATE()) 
            AND YEAR(pl.moved_at) = YEAR(GETDATE())
        """
        cursor.execute(sql_monthly_dispatch)
        total_monthly_dispatch = cursor.fetchone()[0] or 0
        
        # --- 5. CALCULATE MONTHLY TRIGGER ADHERENCE ---
        # Call the helper function defined in step 1 of previous solution
        monthly_trigger_adherence = calculate_monthly_trigger_adherence(conn)

        # --- VIEW LOGIC ---
        if current_view == 'details' and filter_type and filter_value:
            column_map = {'vertical': '[Vertical]', 'category': '[Category]'}
            target_column = column_map.get(filter_type)

            if not target_column:
                return redirect(url_for('dashboard'))

            sql_details = f"""
                DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
                DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
                DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

                WITH TodayDispatch AS (
                    SELECT item_code, SUM(quantity) as QtyDispatched
                    FROM production_log
                    WHERE from_stage = 'FG' AND to_stage = 'Dispatch'
                    AND moved_at >= @ProductionDayStart AND moved_at < @ProductionDayEnd
                    GROUP BY item_code
                )
                SELECT
                    ROW_NUMBER() OVER (ORDER BY p.[priority_weight] DESC, p.[S.No.] ASC) AS [S.No.],
                    p.[Item code ], p.[Type], p.[Category], p.[Model],

                    ISNULL(m.[Pending], 0) AS [Opening Trigger],
                    ISNULL(m.[PDI], 0) as [PDI], 
                    ISNULL(m.[Powder coating], 0) as [Powder coating], 
                    ISNULL(m.[Hydro Testing], 0) as [Hydro Testing],

                    ISNULL(td.QtyDispatched, 0) AS [Dispatched]
                FROM Production_pl p
                LEFT JOIN master m ON p.[Item code ] = m.[Item code]
                LEFT JOIN TodayDispatch td ON p.[Item code ] = td.item_code
                WHERE p.{target_column} = ?
                ORDER BY p.[priority_weight] DESC, p.[S.No.] ASC
            """
            cursor.execute(sql_details, filter_value)
            details_data = [row_to_dict(cursor, row) for row in cursor.fetchall()]

            return render_template('dashboard.html',
                                   current_view=current_view,
                                   filter_type=filter_type,
                                   filter_value=filter_value,
                                   details_data=details_data,
                                   stages=current_stages,
                                   all_verticals=all_verticals_list,
                                   daily_adherence=daily_adherence,
                                   total_monthly_dispatch=total_monthly_dispatch,
                                   monthly_trigger_adherence=monthly_trigger_adherence, # <--- PASS HERE
                                   show_failure_button=show_failure_button)

        else:
            # Overview
            if current_stages:
                sum_clauses = [f"SUM(ISNULL([{stage}], 0)) as [{stage}]" for stage in current_stages]
                cursor.execute(f"SELECT {', '.join(sum_clauses)} FROM master")
                stage_totals = row_to_dict(cursor, cursor.fetchone() or [])

            cursor.execute("SELECT COUNT(*) FROM Production_pl")
            total = cursor.fetchone()[0]

            if total > 0:
                total_pages = ceil(total / per_page)
                pagination = {'page': page, 'per_page': per_page, 'total': total, 'total_pages': total_pages,
                              'has_prev': page > 1, 'has_next': page < total_pages, 'prev_num': page - 1,
                              'next_num': page + 1}

                # --- TOP PLANS QUERY ---
                sql_top_plans = """
                                DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
                                DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
                                DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

                                WITH CurrentFailureReasons AS (
                                    SELECT item_code, MAX(reason) as reason 
                                    FROM failure_log WHERE failure_date = @CurrentProductionDate GROUP BY item_code
                                ),
                                ItemsReachedFG AS (
                                    SELECT item_code, SUM(quantity) as QtyReachedFG
                                    FROM production_log
                                    WHERE to_stage = 'FG' AND moved_at >= @ProductionDayStart AND moved_at < @ProductionDayEnd
                                    GROUP BY item_code
                                ),
                                TodayDispatch AS (
                                    SELECT item_code, SUM(quantity) as QtyDispatched
                                    FROM production_log
                                    WHERE from_stage = 'FG' AND to_stage = 'Dispatch'
                                    AND moved_at >= @ProductionDayStart AND moved_at < @ProductionDayEnd
                                    GROUP BY item_code
                                )
                                SELECT
                                    p.[S.No.], p.[Item code ], p.[Description], 

                                    ISNULL(m.[Pending], 0) AS [Opening Trigger],
                                    ISNULL(m.[Next Pending], 0) AS [Next Pending], 

                                    CASE 
                                        WHEN (ISNULL(m.[Pending], 0) - ISNULL(td.QtyDispatched, 0)) < 0 THEN 0
                                        ELSE (ISNULL(m.[Pending], 0) - ISNULL(td.QtyDispatched, 0))
                                    END AS [Pending],

                                    ISNULL(td.QtyDispatched, 0) AS [Dispatch],
                                    m.[FG],
                                    ISNULL(m.[Powder coating], 0) AS [Powder coating],
                                    ISNULL(m.[Hydro Testing], 0) AS [Hydro Testing],

                                    CASE WHEN ISNULL(m.[Pending], 0) > 0
                                        THEN (CAST(ISNULL(td.QtyDispatched, 0) AS FLOAT) * 100.0 / CAST(m.[Pending] AS FLOAT))
                                        ELSE 100.0 END AS ItemAdherencePercent,

                                    CASE 
                                        WHEN (ISNULL(m.[Pending], 0) - ISNULL(td.QtyDispatched, 0)) < 0 THEN 0
                                        ELSE (ISNULL(m.[Pending], 0) - ISNULL(td.QtyDispatched, 0))
                                    END AS FailureInTrigger,

                                    cfr.reason AS SavedReason
                                FROM Production_pl p
                                LEFT JOIN master m ON p.[Item code ] = m.[Item code]
                                LEFT JOIN CurrentFailureReasons cfr ON p.[Item code ] = cfr.item_code
                                LEFT JOIN ItemsReachedFG fg ON p.[Item code ] = fg.item_code
                                LEFT JOIN TodayDispatch td ON p.[Item code ] = td.item_code

                                ORDER BY 
                                    CASE WHEN ISNULL(m.[Pending], 0) > 0 THEN 1 ELSE 0 END DESC,
                                    p.[priority_weight] DESC, 
                                    p.[S.No.] ASC
                                OFFSET ? ROWS FETCH NEXT ? ROWS ONLY
                            """
                cursor.execute(sql_top_plans, (offset, per_page))
                top_plans = [row_to_dict(cursor, row) for row in cursor.fetchall()]

                # --- VERTICAL OVERVIEW ---
                sql_vertical = """
                    DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
                    DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
                    DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

                    WITH VerticalFG AS (
                        SELECT m.[Vertical], SUM(pl.quantity) as QtyReachedFG
                        FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                        WHERE pl.to_stage = 'FG' AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                        GROUP BY m.[Vertical]
                    ),
                    VerticalDispatch AS (
                        SELECT m.[Vertical], SUM(pl.quantity) as QtyDispatched
                        FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                        WHERE pl.from_stage = 'FG' AND pl.to_stage = 'Dispatch'
                        AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                        GROUP BY m.[Vertical]
                    )
                    SELECT 
                        p.[Vertical], 
                        SUM(ISNULL(m.[Pending], 0)) as [Opening Trigger],
                        
                        CASE 
                            WHEN (SUM(ISNULL(m.[Pending], 0)) - ISNULL(vd.QtyDispatched, 0)) < 0 THEN 0
                            ELSE (SUM(ISNULL(m.[Pending], 0)) - ISNULL(vd.QtyDispatched, 0))
                        END as [Pending],

                        ISNULL(vd.QtyDispatched, 0) as [Dispatch],
                        ISNULL(vfg.QtyReachedFG, 0) as [Achieved]
                    FROM Production_pl p 
                    LEFT JOIN master m ON p.[Item code ] = m.[Item code]
                    LEFT JOIN VerticalFG vfg ON p.[Vertical] = vfg.[Vertical]
                    LEFT JOIN VerticalDispatch vd ON p.[Vertical] = vd.[Vertical]
                    WHERE p.[Vertical] IS NOT NULL 
                    GROUP BY p.[Vertical], vfg.QtyReachedFG, vd.QtyDispatched 
                    ORDER BY p.[Vertical]
                """
                cursor.execute(sql_vertical)
                vertical_overview = [row_to_dict(cursor, row) for row in cursor.fetchall()]
                for item in vertical_overview:
                    trig = item.get('Opening Trigger', 0)
                    ach = item.get('Achieved', 0)
                    item['AdherencePercent'] = (ach * 100.0 / trig) if trig > 0 else 100.0

                # --- CATEGORY OVERVIEW ---
                sql_category = """
                    DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
                    DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
                    DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

                    WITH CategoryFG AS (
                        SELECT m.[Category], SUM(pl.quantity) as QtyReachedFG
                        FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                        WHERE pl.to_stage = 'FG' AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                        GROUP BY m.[Category]
                    ),
                    CategoryDispatch AS (
                        SELECT m.[Category], SUM(pl.quantity) as QtyDispatched
                        FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                        WHERE pl.from_stage = 'FG' AND pl.to_stage = 'Dispatch'
                        AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                        GROUP BY m.[Category]
                    )
                    SELECT 
                        p.[Category], 
                        SUM(ISNULL(m.[Pending], 0)) as [Opening Trigger],
                        
                        CASE 
                            WHEN (SUM(ISNULL(m.[Pending], 0)) - ISNULL(cd.QtyDispatched, 0)) < 0 THEN 0
                            ELSE (SUM(ISNULL(m.[Pending], 0)) - ISNULL(cd.QtyDispatched, 0))
                        END as [Pending],

                        ISNULL(cd.QtyDispatched, 0) as [Dispatch],
                        ISNULL(cfg.QtyReachedFG, 0) as [Achieved]
                    FROM Production_pl p 
                    LEFT JOIN master m ON p.[Item code ] = m.[Item code]
                    LEFT JOIN CategoryFG cfg ON p.[Category] = cfg.[Category]
                    LEFT JOIN CategoryDispatch cd ON p.[Category] = cd.[Category]
                    WHERE p.[Category] IS NOT NULL 
                    GROUP BY p.[Category], cfg.QtyReachedFG, cd.QtyDispatched 
                    ORDER BY p.[Category]
                """
                cursor.execute(sql_category)
                category_overview = [row_to_dict(cursor, row) for row in cursor.fetchall()]
                for item in category_overview:
                    trig = item.get('Opening Trigger', 0)
                    ach = item.get('Achieved', 0)
                    item['AdherencePercent'] = (ach * 100.0 / trig) if trig > 0 else 100.0

            return render_template('dashboard.html',
                                   current_view='overview',
                                   stage_totals=stage_totals, stages=current_stages,
                                   top_plans=top_plans,
                                   pagination=pagination,
                                   vertical_overview=vertical_overview,
                                   category_overview=category_overview,
                                   total_wip_inventory=total_wip_inventory,
                                   all_verticals=all_verticals_list,
                                   daily_adherence=daily_adherence,
                                   total_monthly_dispatch=total_monthly_dispatch,
                                   monthly_trigger_adherence=monthly_trigger_adherence, # <--- PASS HERE
                                   failure_reasons=failure_reasons,
                                   show_failure_button=show_failure_button)

    except Exception as e:
        flash(f"An error occurred: {e}", "error")
        traceback.print_exc()
        # FALLBACK RENDER: Must include 'monthly_trigger_adherence'
        return render_template('dashboard.html', current_view='overview', stages=[], show_failure_button=False,
                               stage_totals={}, top_plans=[], pagination=None, vertical_overview=[],
                               category_overview=[],
                               total_monthly_dispatch=0, daily_adherence=0, monthly_adherence=0, 
                               monthly_trigger_adherence=0, # <--- PASS HERE TO FIX THE ERROR
                               failure_reasons=[],
                               all_verticals=[])
    finally:
        if conn: conn.close()

def calculate_monthly_trigger_adherence(conn, item_codes=None, verticals=None, categories=None, types=None):
    """
    Calculates Monthly Adherence as the AVERAGE of individual item adherences.
    1. For each item, calculate Monthly Adherence = Total Dispatch / Total Target
       (Where Daily Target = Prev Day's Carryover)
    2. Cap each item's adherence at 100%.
    3. Return the average of all active items.
    """
    try:
        cursor = conn.cursor()
        
        today = date.today()
        start_of_month = today.replace(day=1)
        lookback_date = start_of_month - timedelta(days=7) 

        # --- 1. Build Filter SQL ---
        join_master = " INNER JOIN master m ON t.item_code = m.[Item code] "
        log_join_master = " INNER JOIN master m ON pl.item_code = m.[Item code] "
        
        where_clause = ""
        params = []

        if item_codes:
            seq = ','.join(['?'] * len(item_codes))
            where_clause += f" AND m.[Item code] IN ({seq})"
            params.extend(item_codes)
        if verticals:
            seq = ','.join(['?'] * len(verticals))
            where_clause += f" AND m.[Vertical] IN ({seq})"
            params.extend(verticals)
        if categories:
            seq = ','.join(['?'] * len(categories))
            where_clause += f" AND m.[Category] IN ({seq})"
            params.extend(categories)
        if types:
            seq = ','.join(['?'] * len(types))
            where_clause += f" AND m.[Type] IN ({seq})"
            params.extend(types)

        # --- 2. Fetch Data ---
        sql_history = f"""
            SELECT t.upload_date, t.item_code, t.pending_quantity
            FROM trigger_history t
            {join_master}
            WHERE t.upload_date >= ? {where_clause}
        """
        history_params = [lookback_date] + params
        cursor.execute(sql_history, history_params)
        
        history_data = defaultdict(dict)
        for row in cursor.fetchall():
            history_data[row.upload_date][row.item_code] = row.pending_quantity

        sql_log = f"""
            SELECT CAST(pl.moved_at AS DATE) as move_date, pl.item_code, SUM(pl.quantity) as qty
            FROM production_log pl
            {log_join_master}
            WHERE pl.moved_at >= ? AND pl.to_stage IN ('Dispatch', 'Delivered')
            {where_clause}
            GROUP BY CAST(pl.moved_at AS DATE), pl.item_code
        """
        log_params = [lookback_date] + params
        cursor.execute(sql_log, log_params)
        
        dispatch_data = defaultdict(dict)
        for row in cursor.fetchall():
            dispatch_data[row.move_date][row.item_code] = row.qty

        all_dates = sorted(set(history_data.keys()) | set(dispatch_data.keys()))
        all_items = set()
        for d in history_data: all_items.update(history_data[d].keys())
        for d in dispatch_data: all_items.update(dispatch_data[d].keys())

        if not all_dates or not all_items: return 0

        # --- 3. Calculate Per-Item Adherence ---
        item_adherence_percentages = []

        for item in all_items:
            # Build timeline for this specific item
            timeline = []
            for d in all_dates:
                timeline.append({
                    'date': d,
                    'ot': history_data.get(d, {}).get(item, 0),
                    'dispatch': dispatch_data.get(d, {}).get(item, 0)
                })

            item_total_dispatch = 0
            item_total_target = 0

            for i, current_day in enumerate(timeline):
                if current_day['date'] < start_of_month: continue

                item_total_dispatch += current_day['dispatch']

                # Target Calculation:
                # Target = Prev_OT - Prev_Dispatch (Carryover)
                # If we produce everything (Carryover <= 0), Target for today is 0.
                day_target = 0
                if i > 0:
                    prev = timeline[i-1]
                    carryover = prev['ot'] - prev['dispatch']
                    day_target = max(0, carryover)
                else:
                    day_target = current_day['ot']

                item_total_target += day_target

            # Calculate Item %
            if item_total_target > 0:
                p = (item_total_dispatch / item_total_target) * 100.0
                item_adherence_percentages.append(min(100.0, p)) # Cap at 100%
            elif item_total_dispatch > 0:
                # Target was 0 (clean slate), but we produced items (New triggers arrived & cleared same day)
                # This counts as 100% adherence to demand
                item_adherence_percentages.append(100.0)
            # Else: Target 0, Dispatch 0 -> Inactive item, ignore from average

        # --- 4. Average of Percentages ---
        if not item_adherence_percentages:
            return 0

        avg_adherence = sum(item_adherence_percentages) / len(item_adherence_percentages)
        return avg_adherence

    except Exception as e:
        print(f"Error calculating monthly adherence: {e}")
        traceback.print_exc()
        return 0

@app.route('/api/adherence/filtered', methods=['POST'])
def api_adherence_filtered():
    data = request.get_json()
    item_codes = data.get('item_code', [])
    verticals = data.get('vertical', [])
    categories = data.get('category', [])
    types = data.get('type', [])

    conn = get_db_connection()
    result_data = {
        'daily_adherence': 0,
        'monthly_trigger_adherence': 0 
    }
    
    if conn:
        try:
            # 1. Calculate Daily Adherence
            daily_data = calculate_adherence(
                conn, 
                item_codes=item_codes, 
                verticals=verticals, 
                categories=categories,
                types=types
            )
            result_data['daily_adherence'] = daily_data.get('daily_adherence', 0)

            # 2. Calculate Monthly Trigger Adherence (Filtered)
            monthly_val = calculate_monthly_trigger_adherence(
                conn,
                item_codes=item_codes,
                verticals=verticals,
                categories=categories,
                types=types
            )
            result_data['monthly_trigger_adherence'] = monthly_val

        finally:
            conn.close()
    
    return jsonify(result_data)

def calculate_adherence(conn, item_codes=None, verticals=None, categories=None, types=None):
    """
    Helper function: Calculates ONLY Daily Adherence.
    Monthly Adherence logic has been removed.
    """
    daily_adherence = 0

    # 1. Build Filter Logic
    filter_clause_master = ""  
    params = []

    if item_codes:
        seq = ','.join(['?'] * len(item_codes))
        filter_clause_master += f" AND m.[Item code] IN ({seq})"
        params.extend(item_codes)
    if verticals:
        seq = ','.join(['?'] * len(verticals))
        filter_clause_master += f" AND m.[Vertical] IN ({seq})"
        params.extend(verticals)
    if categories:
        seq = ','.join(['?'] * len(categories))
        filter_clause_master += f" AND m.[Category] IN ({seq})"
        params.extend(categories)
    if types:
        seq = ','.join(['?'] * len(types))
        filter_clause_master += f" AND m.[Type] IN ({seq})"
        params.extend(types)

    try:
        cursor = conn.cursor()

        # --- DAILY ADHERENCE CALCULATION ---
        sql_daily_target = f"SELECT SUM(ISNULL(m.[Pending], 0)) FROM master m WHERE 1=1 {filter_clause_master}"
        cursor.execute(sql_daily_target, params)
        total_daily_target = cursor.fetchone()[0] or 0

        sql_daily_actual = f"""
            DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
            DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
            DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

            SELECT SUM(pl.quantity) FROM production_log pl
            INNER JOIN master m ON pl.item_code = m.[Item code]
            WHERE pl.to_stage IN ('Dispatch', 'Delivered') 
            AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
            {filter_clause_master}
        """
        cursor.execute(sql_daily_actual, params)
        total_daily_dispatched = cursor.fetchone()[0] or 0

        if total_daily_target > 0:
            daily_adherence = (total_daily_dispatched / total_daily_target) * 100

    except Exception:
        traceback.print_exc()

    # Only return daily adherence
    return {'daily_adherence': daily_adherence}


@app.route('/dispatch_item', methods=['POST'])
def dispatch_item():
    # Support both JSON (from Dashboard Drag & Drop) and Form Data (from WIP Modal)
    if request.is_json:
        data = request.get_json()
        item_code = data.get('item_code')
        quantity = data.get('quantity')
    else:
        item_code = request.form.get('item_code')
        quantity = request.form.get('quantity')

    # Validate inputs
    try:
        quantity = int(quantity)
        if quantity <= 0:
            return jsonify({'status': 'error', 'message': "Quantity must be greater than 0."}), 400
    except (ValueError, TypeError):
        return jsonify({'status': 'error', 'message': "Invalid quantity."}), 400

    conn = get_db_connection()
    if not conn:
        return jsonify({'status': 'error', 'message': "Database connection failed."}), 500

    try:
        cursor = conn.cursor()

        # 1. CHECK STOCK in FG
        cursor.execute("SELECT ISNULL([FG], 0) FROM master WHERE [Item code] = ?", (item_code,))
        row = cursor.fetchone()

        if not row:
            return jsonify({'status': 'error', 'message': f"Item {item_code} not found."}), 404

        current_fg_stock = row[0]

        if current_fg_stock < quantity:
            return jsonify({'status': 'error', 'message': f"Insufficient stock in FG. Available: {current_fg_stock}"}), 400

        # 2. UPDATE MASTER (Deduct FG)
        cursor.execute("UPDATE master SET [FG] = ISNULL([FG], 0) - ? WHERE [Item code] = ?", (quantity, item_code))

        # 3. UPDATE PRODUCTION_PL (Add to Dispatch)
        cursor.execute("UPDATE Production_pl SET [Dispatch] = ISNULL([Dispatch], 0) + ? WHERE [Item code ] = ?", (quantity, item_code))

        # 4. LOG THE DISPATCH
        cursor.execute("""
            INSERT INTO production_log (item_code, from_stage, to_stage, quantity, moved_at)
            VALUES (?, 'FG', 'Dispatch', ?, GETDATE())
        """, (item_code, quantity))

        conn.commit()
        return jsonify({'status': 'success', 'message': f"Successfully dispatched {quantity} of {item_code}."})

    except Exception as e:
        conn.rollback()
        print(f"Error in /dispatch_item: {e}")
        return jsonify({'status': 'error', 'message': str(e)}), 500
    finally:
        conn.close()

@app.route('/api/plan_page', endpoint='api_plan_page')
def api_plan_page():
    page = request.args.get('page', 1, type=int)
    per_page = 17
    offset = (page - 1) * per_page
    
    # --- NEW: Get Type Filter ---
    filter_type = request.args.get('type') 
    
    conn = get_db_connection()
    if not conn: return jsonify({'status': 'error', 'message': 'Database connection failed.'}), 500

    try:
        cursor = conn.cursor()
        
        # Build Filter Clause
        where_clause = ""
        params = []
        if filter_type:
            where_clause = " WHERE m.[Type] = ?"
            params.append(filter_type)

        # Count Total
        count_sql = f"SELECT COUNT(*) FROM Production_pl p LEFT JOIN master m ON p.[Item code ] = m.[Item code] {where_clause}"
        cursor.execute(count_sql, params)
        total = cursor.fetchone()[0]
        total_pages = ceil(total / per_page) if total > 0 else 1

        sql_top_plans = f"""
            DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
            DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
            DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

            WITH CurrentFailureReasons AS (
                SELECT item_code, MAX(reason) as reason 
                FROM failure_log WHERE failure_date = @CurrentProductionDate GROUP BY item_code
            ),
            TodayDispatch AS (
                SELECT item_code, SUM(quantity) as QtyDispatched
                FROM production_log
                WHERE to_stage IN ('Dispatch', 'Delivered') 
                AND moved_at >= @ProductionDayStart AND moved_at < @ProductionDayEnd
                GROUP BY item_code
            )
            SELECT
                p.[S.No.], p.[Item code ], p.[Description], 
                ISNULL(m.[Pending], 0) AS [Opening Trigger],
                ISNULL(m.[Next Pending], 0) AS [Next Pending],
                (ISNULL(m.[Pending], 0) - ISNULL(td.QtyDispatched, 0)) AS [Pending],
                p.[Today Triggered] AS [Released Qty], 
                m.[FG], 
                ISNULL(td.QtyDispatched, 0) as [Dispatch],
                ISNULL(m.[Powder coating], 0) AS [Powder coating],
                ISNULL(m.[Hydro Testing], 0) AS [Hydro Testing],
                CASE WHEN ISNULL(m.[Pending], 0) > 0
                    THEN (CAST(ISNULL(td.QtyDispatched, 0) AS FLOAT) * 100.0 / CAST(m.[Pending] AS FLOAT))
                    ELSE 100.0 END AS ItemAdherencePercent,
                (ISNULL(m.[Pending], 0) - ISNULL(td.QtyDispatched, 0)) AS FailureInTrigger,
                cfr.reason AS SavedReason
            FROM Production_pl p
            LEFT JOIN master m ON p.[Item code ] = m.[Item code]
            LEFT JOIN CurrentFailureReasons cfr ON p.[Item code ] = cfr.item_code
            LEFT JOIN TodayDispatch td ON p.[Item code ] = td.item_code
            {where_clause} -- Apply Filter
            ORDER BY 
                CASE WHEN ISNULL(m.[Pending], 0) > 0 THEN 1 ELSE 0 END DESC,
                p.[priority_weight] DESC, 
                p.[S.No.] ASC
            OFFSET ? ROWS FETCH NEXT ? ROWS ONLY
        """
        # Add pagination params to the end
        params.extend([offset, per_page])
        
        cursor.execute(sql_top_plans, params)
        plans = [row_to_dict(cursor, row) for row in cursor.fetchall()]

        return jsonify({'status': 'success', 'plans': plans, 'total_pages': total_pages, 'current_page': page, 'per_page': per_page, 'show_failure_button': True})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500
    finally:
        if conn: conn.close()


@app.route('/api/log_failure_reason', methods=['POST'])
def log_failure_reason():
    data = request.get_json()
    item_code = data.get('item_code')
    failed_quantity = data.get('failed_quantity')
    reason = data.get('reason')

    if not item_code or failed_quantity is None: # Allow empty reason to clear it
        return jsonify({'status': 'error', 'message': 'Missing item code or failed quantity.'}), 400

    conn = get_db_connection()
    if not conn:
        return jsonify({'status': 'error', 'message': 'Database connection failed.'}), 500

    try:
        cursor = conn.cursor()

        # Get current production date (using 2 AM cutoff)
        cursor.execute("SELECT CAST(DATEADD(hour, -2, GETDATE()) AS DATE)")
        current_production_date = cursor.fetchone()[0]

        # Use MERGE for UPSERT logic
        merge_sql = """
        MERGE failure_log AS target
        USING (SELECT ? AS item_code, ? AS failure_date, ? AS failed_quantity, ? AS reason) AS source
        ON (target.item_code = source.item_code AND target.failure_date = source.failure_date)
        WHEN MATCHED THEN
            UPDATE SET
                reason = source.reason,
                failed_quantity = source.failed_quantity, -- Update qty in case plan changes
                logged_at = GETDATE()
        WHEN NOT MATCHED THEN
            INSERT (item_code, failure_date, failed_quantity, reason)
            VALUES (source.item_code, source.failure_date, source.failed_quantity, source.reason);
        """
        cursor.execute(merge_sql, item_code, current_production_date, failed_quantity, reason if reason else None) # Store NULL if reason is empty string
        conn.commit()

        return jsonify({'status': 'success', 'message': 'Reason logged.'})

    except Exception as e:
        if conn: conn.rollback()
        traceback.print_exc()
        return jsonify({'status': 'error', 'message': f'Error logging reason: {str(e)}'}), 500
    finally:
        if conn: conn.close()



# In app/routes.py
# REPLACE your existing 'attendance' function with this one

# In app/routes.py
# REPLACE your existing 'attendance' function with this one

@app.route('/attendance', methods=['GET'], endpoint='attendance')
@login_required  
def attendance():
    start_date_str = request.args.get('start_date')
    selected_stage = request.args.get('stage', 'All')

    # Use selected date or today's date
    if start_date_str:
        today = datetime.strptime(start_date_str, '%Y-%m-%d').date()
    else:
        today = date.today()

    start_of_week = today - timedelta(days=today.weekday())
    week_days = [start_of_week + timedelta(days=i) for i in range(7)]
    prev_week_start, next_week_start = start_of_week - timedelta(days=7), start_of_week + timedelta(days=7)

    conn = get_db_connection()
    employees_list, attendance_data, calendar_exceptions, stage_filter_list = [], {}, {}, []
    manage_employees_list = []  # List for the manage employees tab
    roster_dict = {}  # NEW: To store temporary assignments

    if conn:
        try:
            cursor = conn.cursor()

            # --- Create daily_roster table if it doesn't exist ---
            cursor.execute("""
            IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='daily_roster' and xtype='U')
            CREATE TABLE daily_roster (
                roster_date DATE NOT NULL,
                employee_code NVARCHAR(50) NOT NULL,
                employee_name NVARCHAR(255),
                default_stage NVARCHAR(255),
                assigned_stage NVARCHAR(255),
                transfer_reason NVARCHAR(MAX),
                PRIMARY KEY (roster_date, employee_code)
            );
            """)
            conn.commit()

            # Get stage list for filters (from main employees table)
            cursor.execute("SELECT DISTINCT [Stage] FROM employees WHERE [Stage] IS NOT NULL ORDER BY [Stage]")
            stage_filter_list = [row[0] for row in cursor.fetchall()]

            # --- NEW: Get full employee list for "Manage Employees" tab ---
            cursor.execute("SELECT * FROM employees ORDER BY [Name of the Employee]")
            manage_employees_list = [row_to_dict(cursor, row) for row in cursor.fetchall()]

            # --- MODIFIED: Get full employee list for "Attendance View" tab, with filtering ---
            sql_employees = "SELECT * FROM employees"
            params = []
            if selected_stage != 'All':
                sql_employees += " WHERE [Stage] = ?"  # Filter by default stage
                params.append(selected_stage)
            sql_employees += " ORDER BY [Name of the Employee]"

            cursor.execute(sql_employees, params)
            employees_list = [row_to_dict(cursor, row) for row in cursor.fetchall()]  # This is the full list

            # Get calendar exceptions
            cursor.execute("SELECT holiday_date, day_type FROM holidays WHERE holiday_date BETWEEN ? AND ?",
                           week_days[0], week_days[-1])
            calendar_exceptions = {row.holiday_date: row.day_type for row in cursor.fetchall()}

            # Get attendance data for the week
            cursor.execute(
                "SELECT employee_code, attendance_date, status, shift FROM attendance_log WHERE attendance_date BETWEEN ? AND ?",
                week_days[0], week_days[-1])
            for row in cursor.fetchall():
                e_code, att_date, status, shift = row
                if e_code not in attendance_data: attendance_data[e_code] = {}
                if status == 'Present' and shift:
                    attendance_data[e_code][att_date] = f"Present-{shift}"
                else:
                    attendance_data[e_code][att_date] = status

            # --- NEW: Get this week's roster data ---
            cursor.execute("SELECT * FROM daily_roster WHERE roster_date BETWEEN ? AND ?",
                           (week_days[0], week_days[-1]))
            roster_data_raw = cursor.fetchall()
            roster_dict = {}  # Format: { ecode: { date: {assigned_stage: '...'} } }
            for row in roster_data_raw:
                row_dict = row_to_dict(cursor, row)
                ecode = row_dict['employee_code']
                r_date = row_dict['roster_date']
                if ecode not in roster_dict:
                    roster_dict[ecode] = {}
                roster_dict[ecode][r_date] = {
                    'assigned_stage': row_dict['assigned_stage'],
                    'default_stage': row_dict['default_stage']
                }
            # --- END NEW ---

        except Exception as e:
            flash(f'An error occurred: {e}', 'error')
            traceback.print_exc()
        finally:
            if conn: conn.close()

    return render_template('attendance.html',
                           employees=employees_list,  # Full employee list
                           manage_employees=manage_employees_list,  # Full employee list for manage tab
                           week_days=week_days,
                           attendance_data=attendance_data,
                           roster_dict=roster_dict,  # Pass the roster data
                           holidays=calendar_exceptions,
                           prev_week_start=prev_week_start.strftime('%Y-%m-%d'),
                           next_week_start=next_week_start.strftime('%Y-%m-%d'),
                           current_week_str=f"{start_of_week.strftime('%b %d')} - {week_days[-1].strftime('%b %d, %Y')}",
                           stage_filter_list=stage_filter_list,
                           selected_stage=selected_stage,
                           today=today,  # Pass the 'today' (viewed date) variable
                           date=date  # Pass the date module for comparison
                           )




# In app/routes.py

@app.route('/generate_plan', methods=['POST'], endpoint='generate_plan')
def generate_plan():
    # --- 1. SECURITY CHECK: Verify Triggers Uploaded ---
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('production_planning'))

    try:
        cursor = conn.cursor()
        cursor.execute("SELECT status_value FROM app_status WHERE status_key = 'last_triggers_upload_timestamp'")
        row = cursor.fetchone()

        triggers_valid = False
        if row and row[0]:
            upload_time = pd.to_datetime(row[0])
            now = datetime.now()
            if now.hour < 2:
                current_prod_date = (now - timedelta(days=1)).date()
            else:
                current_prod_date = now.date()
            if upload_time.date() >= current_prod_date:
                triggers_valid = True

        if not triggers_valid:
            flash('Error: You must upload the Pending Triggers file for today before generating the plan.', 'error')
            return redirect(url_for('production_planning'))

        # --- 2. PROCEED WITH GENERATION ---
        ahp_weights = session.get('ahp_weights', DEFAULT_AHP_WEIGHTS.copy())

        # Ensure Columns Exist in Master/Production_pl
        cursor.execute("""
            IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'Daily Max Plan' AND Object_ID = Object_ID(N'master'))
                ALTER TABLE master ADD [Daily Max Plan] INT DEFAULT 0 WITH VALUES;
            IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'Max Inv' AND Object_ID = Object_ID(N'master'))
                ALTER TABLE master ADD [Max Inv] INT DEFAULT 0 WITH VALUES;
            IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'CalculatedTrigger' AND Object_ID = Object_ID(N'Production_pl'))
                ALTER TABLE Production_pl ADD [CalculatedTrigger] INT DEFAULT 0 WITH VALUES;
             -- Ensure Live Dispatch exists in Master
            IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'Live Dispatch' AND Object_ID = Object_ID(N'master'))
                ALTER TABLE master ADD [Live Dispatch] INT DEFAULT 0 WITH VALUES;
        """)
        conn.commit()

        # --- 3. CALCULATE PLAN (New Formula) ---

        # We need to sum up the WIP stages to get "Current WIP".
        # We assume stages are columns in master. We exclude 'Not Started' and 'FG' from WIP usually,
        # but based on your previous 'Calculated_Total_Inv' logic, we sum the active stages.
        # Ensure STAGES list is available or hardcoded for the SQL sum.
        # Default active stages for WIP calculation:
        wip_stages_sql = "ISNULL([Long seam], 0) + ISNULL([Dish fit up], 0) + ISNULL([Cirseam welding], 0) + ISNULL([Part assembly], 0) + ISNULL([Full welding], 0) + ISNULL([Hydro Testing], 0) + ISNULL([Powder coating], 0) + ISNULL([PDI], 0)"

        sql_query = f"""
        WITH CalculatedData AS (
            SELECT 
                [Item code],
                [Description],
                [Vertical],
                [Category],
                [Type],
                [Model],
                [RPL days to Delivery],
                ISNULL([Pending], 0) AS [Pending_Trigger],
                ISNULL([Max Inv], 0) AS [Max_Inventory],
                ISNULL([Daily Max Plan], 0) AS [Max_Daily_Plan],
                ({wip_stages_sql}) AS [Current_WIP],
                ISNULL([Live Dispatch], 0) as [Current_Dispatch]
            FROM dbo.master
        )
        SELECT * FROM CalculatedData
        """

        plan_df = pd.read_sql_query(sql_query, conn)

        # --- APPLY THE FORMULAS ---

        # 1. Available WIP Space = Max Inventory - Current WIP
        plan_df['Available_WIP_Space'] = plan_df['Max_Inventory'] - plan_df['Current_WIP']

        # 2. Total Potential = Available WIP Space + Pending Trigger
        plan_df['Total_Potential'] = plan_df['Available_WIP_Space'] + plan_df['Pending_Trigger']

        # 3. Actual Production = MAX(0, MIN(Total Potential, Available WIP space, Max Daily Plan))
        # We use apply to handle the row-wise MIN logic
        def calculate_actual(row):
            # min() of the three values
            val = min(row['Total_Potential'], row['Available_WIP_Space'], row['Max_Daily_Plan'])
            # max(0, val)
            return max(0, val)

        plan_df['Daily Suggested Release Plan'] = plan_df.apply(calculate_actual, axis=1).astype(int)

        # Note: "New Pending Trigger" is not stored in the DB during generation (that happens on release),
        # but the plan is now derived correctly.

        # --- 4. FINALIZE DATAFRAME FOR SAVING ---

        # Prepare columns for Production_pl table
        plan_df['Item code'] = plan_df['Item code'].astype(str).str.strip()

        # Set Modified Plan default to the Calculated Plan
        plan_df['Modified Release plan'] = plan_df['Daily Suggested Release Plan']

        # For Adherence/Dashboard: Set CalculatedTrigger to the Suggestion
        plan_df['CalculatedTrigger'] = plan_df['Daily Suggested Release Plan']

        # Apply AHP Priority Sorting
        prioritized_df = prioritize_plan_with_ahp(plan_df, ahp_weights)

        final_plan_to_save = prioritized_df.sort_values(by='priority_weight', ascending=False)
        final_plan_to_save.reset_index(drop=True, inplace=True)
        final_plan_to_save.insert(0, 'S.No.', final_plan_to_save.index + 1)

        # Initialize other required columns
        final_plan_to_save['Today Triggered'] = 0
        final_plan_to_save['Failure in Trigger'] = 0
        final_plan_to_save['Dispatch'] = final_plan_to_save['Current_Dispatch']

        # Rename for DB compatibility
        final_plan_to_save.rename(columns={'Item code': 'Item code ', 'Pending_Trigger': 'Pending'}, inplace=True)

        # Drop temp calculation columns
        cols_to_drop = ['Available_WIP_Space', 'Total_Potential', 'Max_Inventory', 'Max_Daily_Plan', 'Current_WIP',
                        'Current_Dispatch', 'type_score', 'rpl_score', 'category_score', 'qty_score']
        final_plan_to_save.drop(columns=cols_to_drop, inplace=True, errors='ignore')

        replace_table_with_df(final_plan_to_save, 'Production_pl', cursor)
        conn.commit()

        flash('Production Plan generated successfully using Capacity Constraints.', 'success')

    except Exception as e:
        if conn: conn.rollback()
        flash(f'Error generating plan: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()

    return redirect(url_for('production_planning'))



@app.route('/delete_triggers', methods=['POST'], endpoint='delete_triggers')
def delete_triggers():
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(request.referrer or url_for('production_planning'))

    try:
        cursor = conn.cursor()
        
        now = datetime.now()
        current_date = (now - timedelta(days=1)).date() if now.hour < 2 else now.date()

        # 1. Clear raw table
        cursor.execute("IF OBJECT_ID('dbo.pending_triggers', 'U') IS NOT NULL DELETE FROM pending_triggers")
        
        # 2. Reset master quantities
        cursor.execute("IF OBJECT_ID('dbo.master', 'U') IS NOT NULL UPDATE master SET [Pending] = 0, [Next Pending] = 0")
        
        # 3. Manual Reset: Remove from history (because the user is manually "undoing" today's upload)
        cursor.execute("DELETE FROM trigger_history WHERE upload_date = ?", current_date)
        
        # 4. Reset status
        cursor.execute("UPDATE app_status SET status_value = NULL WHERE status_key = 'last_triggers_upload_timestamp'")

        conn.commit()
        flash("Pending triggers removed and today's history entry cleared.", "success")
    except Exception as e:
        flash(f'Error: {e}', 'error')
        if conn: conn.rollback()
    finally:
        if conn: conn.close()

    return redirect(request.referrer or url_for('production_planning'))


@app.route('/update_single_plan', methods=['POST'])
def update_single_plan():
    data = request.get_json()
    item_code = data.get('item_code')

    try:
        new_plan_value = int(data.get('new_plan_value') or 0)
    except ValueError:
        return jsonify({'status': 'error', 'message': 'Invalid number'}), 400

    if not item_code:
        return jsonify({'status': 'error', 'message': 'Item code is missing.'}), 400

    conn = get_db_connection()
    if not conn:
        return jsonify({'status': 'error', 'message': 'Database connection failed.'}), 500

    try:
        cursor = conn.cursor()

        # 1. Update Production Plan Table
        # Note: Production_pl usually has "[Item code ]" with a space
        sql_plan = "UPDATE Production_pl SET [Modified Release plan] = ? WHERE [Item code ] LIKE ?"
        cursor.execute(sql_plan, (new_plan_value, item_code))

        # 2. Update Master Table (Not Started)
        # Note: master usually has "[Item code]" without a space
        # We only update if the "Not Started" column exists
        sql_master = """
            IF EXISTS (SELECT * FROM sys.columns WHERE Name = N'Not Started' AND Object_ID = Object_ID(N'master'))
            BEGIN
                UPDATE master 
                SET [Not Started] = ? 
                WHERE [Item code] LIKE ?
            END
        """
        cursor.execute(sql_master, (new_plan_value, item_code))

        # 3. Recalculate Priorities (AHP)
        # Read table back
        updated_plan_df = pd.read_sql("SELECT * FROM Production_pl", conn)

        # Helper to normalize column names for pandas
        if 'Item code' in updated_plan_df.columns:
            updated_plan_df.rename(columns={'Item code': 'Item code '}, inplace=True)

        ahp_weights = session.get('ahp_weights', DEFAULT_AHP_WEIGHTS.copy())
        re_prioritized_df = prioritize_plan_with_ahp(updated_plan_df, ahp_weights)

        # Update weights in DB
        for index, row in re_prioritized_df.iterrows():
            code = row['Item code ']
            new_weight = row['priority_weight']
            update_sql = "UPDATE Production_pl SET [priority_weight] = ? WHERE [Item code ] = ?"
            cursor.execute(update_sql, new_weight, code)

        conn.commit()
        return jsonify({'status': 'success'})

    except Exception as e:
        if conn: conn.rollback()
        traceback.print_exc()
        return jsonify({'status': 'error', 'message': str(e)}), 500
    finally:
        if conn: conn.close()

@app.route('/move_item', methods=['POST'])
def move_item():
    # Get form data
    if request.is_json:
        data = request.get_json()
        item_code = data.get('item_code')
        from_stage = data.get('source_stage')
        to_stage = data.get('dest_stage')
        quantity = data.get('quantity')
    else:
        item_code = request.form.get('item_code')
        from_stage = request.form.get('from_stage') or request.form.get('source_stage')
        to_stage = request.form.get('to_stage') or request.form.get('dest_stage')
        quantity = request.form.get('quantity')

    # Validate inputs
    if not all([item_code, from_stage, to_stage, quantity]):
        return jsonify({'status': 'error', 'message': 'Missing required fields.'}), 400

    # --- HANDLE VIRTUAL GROUP DESTINATION ---
    # If moving items BACK to "Before Hydro", place them in the last stage of that group ("Full welding")
    if to_stage == 'Before Hydro':
        to_stage = 'Full welding'

    # --- SAFETY CHECK FOR VIRTUAL GROUP SOURCE ---
    # We cannot deduct from "Before Hydro" directly; the frontend must resolve this to a concrete sub-stage.
    if from_stage == 'Before Hydro':
        return jsonify({
            'status': 'error', 
            'message': 'System Error: Cannot move directly from "Before Hydro" group without a resolved sub-stage. Please refresh the page and try again.'
        }), 400

    try:
        quantity = int(quantity)
        if quantity <= 0:
            return jsonify({'status': 'error', 'message': 'Quantity must be greater than 0.'}), 400
    except (ValueError, TypeError):
        return jsonify({'status': 'error', 'message': 'Invalid quantity.'}), 400

    conn = get_db_connection()
    if not conn:
        return jsonify({'status': 'error', 'message': 'Database connection failed.'}), 500

    try:
        cursor = conn.cursor()

        # 1. CHECK STOCK
        # We wrap stage names in brackets to handle spaces safely
        cursor.execute(f"SELECT [{from_stage}] FROM master WHERE [Item code] = ?", (item_code,))
        row = cursor.fetchone()

        if not row:
            return jsonify({'status': 'error', 'message': f'Item {item_code} not found.'}), 404

        current_stock = row[0] or 0

        if current_stock < quantity:
            return jsonify(
                {'status': 'error', 'message': f'Insufficient stock in {from_stage}. Available: {current_stock}'}), 400

        # 2. PERFORM THE MOVE

        # A. Subtract from Source
        cursor.execute(f"UPDATE master SET [{from_stage}] = ISNULL([{from_stage}], 0) - ? WHERE [Item code] = ?",
                       (quantity, item_code))

        # B. Add to Destination (Update Inventory)
        # We update the master table for ANY stage except 'Dispatch' (which is an exit action)
        if to_stage != 'Dispatch':
            cursor.execute(f"UPDATE master SET [{to_stage}] = ISNULL([{to_stage}], 0) + ? WHERE [Item code] = ?",
                           (quantity, item_code))

        # 3. HANDLE DISPATCH COUNT
        if to_stage == 'Dispatch':
            cursor.execute("""
                UPDATE Production_pl 
                SET [Dispatch] = ISNULL([Dispatch], 0) + ? 
                WHERE [Item code ] = ?
            """, (quantity, item_code))

        # 4. LOG THE MOVEMENT
        cursor.execute("""
            INSERT INTO production_log (item_code, from_stage, to_stage, quantity, moved_at)
            VALUES (?, ?, ?, ?, GETDATE())
        """, (item_code, from_stage, to_stage, quantity))

        conn.commit()

        return jsonify({'status': 'success', 'message': f'Moved {quantity} items successfully.'})

    except Exception as e:
        if conn: conn.rollback()
        print(f"Error in /move_item: {e}")
        traceback.print_exc()
        return jsonify({'status': 'error', 'message': str(e)}), 500
    finally:
        if conn: conn.close()


@app.route('/deliver_item', methods=['POST'], endpoint='deliver_item')
def deliver_item():
    data = request.get_json()
    item_code, quantity = data.get('item_code'), int(data.get('quantity', 0))
    if not all([item_code, quantity > 0]): return jsonify(
        {'status': 'error', 'message': 'Missing or invalid data.'}), 400

    conn = get_db_connection()
    if not conn: return jsonify({'status': 'error', 'message': 'DB connection failed.'}), 500

    try:
        cursor = conn.cursor()

        # Step 1: Update master table (FG and Live Dispatch)
        cursor.execute(
            "UPDATE master SET [FG] = [FG] - ?, [Live Dispatch] = [Live Dispatch] + ? WHERE [Item code ] = ? AND [FG] >= ?",
            quantity, quantity, item_code, quantity)

        # Check if the update was successful
        if cursor.rowcount == 0:
            conn.rollback()
            return jsonify({'status': 'error', 'message': 'Not enough quantity in FG to deliver.'}), 400

        # --- NEW: Step 2: Log the delivery in production_log ---
        # Using 'Delivered' as the to_stage to clearly mark it
        cursor.execute(
            "INSERT INTO production_log (item_code, quantity, from_stage, to_stage) VALUES (?, ?, ?, ?)",
            item_code, quantity, 'FG', 'Delivered'
        )
        # --- END NEW ---

        conn.commit()  # Commit both the update and the insert

        return jsonify({'status': 'success', 'redirect_url': url_for('wip_tracking')})

    except Exception as e:
        if conn: conn.rollback()
        traceback.print_exc()
        # Changed error message slightly for clarity
        return jsonify({'status': 'error', 'message': f'Error during delivery: {str(e)}'}), 500
    finally:
        if conn: conn.close()


@app.context_processor
def inject_upload_status():
    """
    Injects upload status variables into all templates
    for use in the settings modal.
    """
    conn = get_db_connection()
    table_exists = False
    last_triggers_upload = None
    if conn:
        try:
            cursor = conn.cursor()
            cursor.execute("SELECT COUNT(*) FROM master")
            if cursor.fetchone()[0] > 0:
                table_exists = True

            cursor.execute("SELECT status_value FROM app_status WHERE status_key = 'last_triggers_upload_timestamp'")
            row = cursor.fetchone()
            if row and row[0]:
                last_triggers_upload = pd.to_datetime(row[0])
        except pyodbc.ProgrammingError:
            table_exists = False  # master table doesn't exist
        except Exception as e:
            print(f"Error in context processor: {e}")
        finally:
            conn.close()

    return dict(
        master_table_exists=table_exists,
        last_triggers_upload_time=last_triggers_upload
    )


@app.route('/flag_item', methods=['POST'], endpoint='flag_item')
def flag_item():
    conn = None
    try:
        data = request.get_json()
        print(f"DEBUG: Received Flag Request: {data}")  # DEBUG PRINT 1

        item_code = data.get('item_code')
        stage = data.get('stage')
        quantity = int(data.get('quantity', 0))
        remark = data.get('remark')

        if quantity <= 0:
            return jsonify({'status': 'error', 'message': 'Quantity must be > 0'}), 400

        conn = get_db_connection()
        cursor = conn.cursor()

        # 1. Check Stock
        # NOTE: We wrap stage in brackets [] to handle spaces in names like 'Long seam'
        check_sql = f"SELECT [{stage}] FROM master WHERE [Item code] = ?"
        print(f"DEBUG: Checking stock with SQL: {check_sql} for {item_code}")  # DEBUG PRINT 2

        cursor.execute(check_sql, item_code)
        row = cursor.fetchone()

        if not row:
            print("DEBUG: Item not found in Master table")
            return jsonify({'status': 'error', 'message': 'Item not found in Master.'}), 404

        current_qty = row[0] or 0
        print(f"DEBUG: Current Stock: {current_qty}, Requesting: {quantity}")  # DEBUG PRINT 3

        if current_qty < quantity:
            return jsonify(
                {'status': 'error', 'message': f'Cannot flag {quantity}. Only {current_qty} available.'}), 400

        # 2. Update Master (Deduct Qty)
        update_sql = f"UPDATE master SET [{stage}] = [{stage}] - ? WHERE [Item code] = ?"
        cursor.execute(update_sql, (quantity, item_code))
        print("DEBUG: Master table updated (Deduction)")  # DEBUG PRINT 4

        # 3. Insert into flagged_items
        insert_sql = """
            INSERT INTO flagged_items (item_code, stage, quantity, reason, flagged_at)
            VALUES (?, ?, ?, ?, GETDATE())
        """
        cursor.execute(insert_sql, (item_code, stage, quantity, remark))
        print("DEBUG: Inserted into flagged_items")  # DEBUG PRINT 5

        conn.commit()
        print("DEBUG: Transaction Committed Successfully")  # DEBUG PRINT 6

        return jsonify({'status': 'success', 'message': f'Flagged {quantity} items.'})

    except Exception as e:
        if conn: conn.rollback()
        print(f"CRITICAL ERROR in flag_item: {e}")  # LOOK FOR THIS IN TERMINAL
        # Return the actual error to the frontend alert so you can see it
        return jsonify({'status': 'error', 'message': f"Server Error: {str(e)}"}), 500
    finally:
        if conn: conn.close()

@app.route('/update_weights', methods=['POST'], endpoint='update_weights')
def update_weights():
    try:
        raw_weights = {'type': float(request.form.get('weight_type', 0)),
                       'rpl': float(request.form.get('weight_rpl', 0)),
                       'category': float(request.form.get('weight_category', 0)),
                       'modified_plan': float(request.form.get('weight_modified_plan', 0))}
        total_weight = sum(raw_weights.values())
        if total_weight == 0:
            flash('All weights cannot be zero. Please enter at least one positive value.', 'error')
            return redirect(url_for('production_planning'))
        session['ahp_weights'] = {key: value / total_weight for key, value in raw_weights.items()}
        flash('AHP weights have been updated and normalized successfully!', 'success')
    except ValueError:
        flash('Invalid input. Please enter valid numbers for all weight fields.', 'error')
    except Exception as e:
        flash(f'An unexpected error occurred: {e}', 'error')
        traceback.print_exc()
    return redirect(url_for('production_planning'))

@app.route('/transfer_worker', methods=['POST'], endpoint='transfer_worker')
def transfer_worker():
    pass

@app.route('/attendance/mark_single', methods=['POST'])
def mark_single_attendance():
    data = request.get_json()
    e_code = data.get('employee_code')
    date_str = data.get('date')
    value = data.get('status')  # e.g., "Present-1", "Absent", ""

    if not all([e_code, date_str]):
        return jsonify({'status': 'error', 'message': 'Missing data'}), 400

    conn = get_db_connection()
    if not conn:
        return jsonify({'status': 'error', 'message': 'Database connection failed'}), 500

    try:
        cursor = conn.cursor()
        attendance_date = datetime.strptime(date_str, '%Y-%m-%d').date()

        # CASE 1: Value is empty (User selected "--") -> CLEAR RECORD
        if not value:
            # Delete from attendance_log
            cursor.execute("DELETE FROM attendance_log WHERE employee_code = ? AND attendance_date = ?", e_code, attendance_date)
            # Delete from daily_roster (not working)
            cursor.execute("DELETE FROM daily_roster WHERE employee_code = ? AND roster_date = ?", e_code, attendance_date)

        # CASE 2: Value is "Absent" -> SAVE ABSENT, REMOVE FROM ROSTER
        elif value == 'Absent':
            # UPSERT into attendance_log as 'Absent'
            upsert_log_sql = """
            MERGE attendance_log AS target
            USING (SELECT ? AS employee_code, ? AS attendance_date, 'Absent' AS status, NULL AS shift) AS source
            ON (target.employee_code = source.employee_code AND target.attendance_date = source.attendance_date)
            WHEN MATCHED THEN UPDATE SET status = source.status, shift = source.shift
            WHEN NOT MATCHED THEN INSERT (employee_code, attendance_date, status, shift)
            VALUES (source.employee_code, source.attendance_date, source.status, source.shift);"""
            cursor.execute(upsert_log_sql, e_code, attendance_date)

            # Remove from daily_roster since they are absent
            cursor.execute("DELETE FROM daily_roster WHERE employee_code = ? AND roster_date = ?", e_code, attendance_date)

        # CASE 3: Value is "Present" (e.g., "Present-1") -> SAVE PRESENT, ADD TO ROSTER
        else:
            status_val = None
            shift_val = None
            if '-' in value:
                parts = value.split('-')
                status_val = parts[0]  # "Present"
                shift_val = int(parts[1]) if len(parts) > 1 and parts[1].isdigit() else None
            else:
                status_val = value  # Should be "Present"

            # 1. UPSERT into attendance_log
            upsert_log_sql = """
            MERGE attendance_log AS target
            USING (SELECT ? AS employee_code, ? AS attendance_date, ? AS status, ? AS shift) AS source
            ON (target.employee_code = source.employee_code AND target.attendance_date = source.attendance_date)
            WHEN MATCHED THEN UPDATE SET status = source.status, shift = source.shift
            WHEN NOT MATCHED THEN INSERT (employee_code, attendance_date, status, shift)
            VALUES (source.employee_code, source.attendance_date, source.status, source.shift);"""
            cursor.execute(upsert_log_sql, e_code, attendance_date, status_val, shift_val)

            # 2. MERGE into daily_roster (Add them to roster if they aren't there yet)
            # We assume if they are present, they are working their default stage unless transferred
            merge_roster_sql = """
            MERGE daily_roster AS target
            USING (
                SELECT [E.code], [Name of the Employee], [Stage]
                FROM employees
                WHERE [E.code] = ?
            ) AS source
            ON (target.employee_code = source.[E.code] AND target.roster_date = ?)
            WHEN NOT MATCHED BY TARGET THEN
                INSERT (roster_date, employee_code, employee_name, default_stage, assigned_stage)
                VALUES (?, source.[E.code], source.[Name of the Employee], source.[Stage], source.[Stage]);
            """
            cursor.execute(merge_roster_sql, e_code, attendance_date, attendance_date)

        conn.commit()
        return jsonify({'status': 'success'})

    except Exception as e:
        if conn: conn.rollback()
        traceback.print_exc()
        return jsonify({'status': 'error', 'message': str(e)}), 500
    finally:
        if conn: conn.close()


@app.route('/attendance/working_day', methods=['POST'], endpoint='mark_working_day')
def mark_working_day():
    work_date_str = request.form.get('work_date')
    description = request.form.get('description', 'Working Day')
    start_date = request.form.get('start_date')
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('attendance', start_date=start_date))
    try:
        cursor = conn.cursor()
        # Use MERGE to insert a new record or update an existing one
        sql = """
        MERGE holidays AS target
        USING (SELECT ? AS holiday_date, ? AS description, 'Working Day' AS day_type) AS source
        ON (target.holiday_date = source.holiday_date)
        WHEN MATCHED THEN
            UPDATE SET day_type = source.day_type, description = source.description
        WHEN NOT MATCHED THEN
            INSERT (holiday_date, description, day_type) VALUES (source.holiday_date, source.description, source.day_type);
        """
        cursor.execute(sql, work_date_str, description)
        conn.commit()
        flash(f'Date {work_date_str} marked as a Working Day.', 'success')
    except Exception as e:
        flash(f'An error occurred: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()
    return redirect(url_for('attendance', start_date=start_date))

@app.route('/attendance/export', methods=['GET'], endpoint='export_attendance')
def export_attendance():
    conn = get_db_connection()
    year, month = request.args.get('year', datetime.now().year, type=int), request.args.get('month',
                                                                                            datetime.now().month,
                                                                                            type=int)
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('attendance'))
    try:
        df_employees = pd.read_sql(
            "SELECT [E.code], [Name of the Employee] FROM employees ORDER BY [Name of the Employee]", conn)
        df_log = pd.read_sql(
            "SELECT employee_code, attendance_date, status FROM attendance_log WHERE YEAR(attendance_date) = ? AND MONTH(attendance_date) = ?",
            conn, params=(year, month))
        df_report = df_employees if df_log.empty else pd.merge(df_employees, df_log.pivot(index='employee_code',
                                                                                          columns='attendance_date',
                                                                                          values='status').reset_index(),
                                                               left_on='E.code', right_on='employee_code',
                                                               how='left').drop(columns=['employee_code'],
                                                                                errors='ignore')
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df_report.to_excel(writer, index=False, sheet_name='Attendance')
        output.seek(0)
        return send_file(output, mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                         as_attachment=True, download_name=f'attendance_{year}_{month:02d}.xlsx')
    except Exception as e:
        flash(f"Error exporting data: {e}", "error")
        traceback.print_exc()
        return redirect(url_for('attendance'))
    finally:
        if conn: conn.close()

@app.route('/add_employee', methods=['POST'], endpoint='add_employee')
def add_employee():
    e_code = request.form.get('e_code')
    name = request.form.get('name')
    company = request.form.get('company')
    doj_str = request.form.get('doj')
    stage = request.form.get('stage')

    # Removed 'default_shift' from check
    if not all([e_code, name, company, doj_str, stage]):
        flash('Error: All fields are required.', 'error')
        return redirect(url_for('attendance'))

    doj_date = datetime.strptime(doj_str, '%Y-%m-%d')
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('attendance'))
    try:
        cursor = conn.cursor()
        cursor.execute("SELECT [E.code] FROM employees WHERE [E.code] = ?", e_code)
        if cursor.fetchone():
            flash(f'Error: Employee with E.code "{e_code}" already exists.', 'error')
            return redirect(url_for('attendance'))

        # Removed [Default Shift] from SQL
        sql_insert = "INSERT INTO employees ([E.code], [Name of the Employee], [Company / Contract], [Stage], [DOJ]) VALUES (?, ?, ?, ?, ?)"
        # Removed default_shift from params
        params = (e_code, name, company, stage, doj_date)
        cursor.execute(sql_insert, params)
        conn.commit()
        flash(f'Successfully added employee: {name}', 'success')
    except Exception as e:
        flash(f'An unexpected error occurred: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()
    # Redirect to the manage view by default
    return redirect(url_for('attendance', view='manage'))

@app.route('/edit_employee', methods=['POST'], endpoint='edit_employee')
def edit_employee():
    # This is the original E.code used to find the record
    original_e_code = request.form.get('original_e_code')

    # These are the new values from the form
    new_e_code = request.form.get('e_code')
    name = request.form.get('name')
    company = request.form.get('company')
    doj_str = request.form.get('doj')
    stage = request.form.get('stage')

    if not all([original_e_code, new_e_code, name, company, doj_str, stage]):
        flash('Error: All fields are required to edit.', 'error')
        return redirect(url_for('attendance', view='manage'))

    doj_date = datetime.strptime(doj_str, '%Y-%m-%d')
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('attendance', view='manage'))
    try:
        cursor = conn.cursor()

        # Check if the new E.code already exists (and isn't the original e.code)
        if original_e_code != new_e_code:
            cursor.execute("SELECT [E.code] FROM employees WHERE [E.code] = ?", new_e_code)
            if cursor.fetchone():
                flash(f'Error: New E.code "{new_e_code}" already exists for another employee.', 'error')
                return redirect(url_for('attendance', view='manage'))

        # Run the UPDATE query
        sql_update = """
            UPDATE employees 
            SET [E.code] = ?, [Name of the Employee] = ?, [Company / Contract] = ?, [Stage] = ?, [DOJ] = ?
            WHERE [E.code] = ?
        """
        params = (new_e_code, name, company, stage, doj_date, original_e_code)
        cursor.execute(sql_update, params)
        conn.commit()

        flash(f'Successfully updated employee: {name}', 'success')
    except Exception as e:
        # --- THIS IS THE CORRECTED LINE ---
        flash(f'An unexpected error occurred during update: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()

    return redirect(url_for('attendance', view='manage'))

@app.route('/attendance/holiday', methods=['POST'], endpoint='add_holiday')
def add_holiday():
    holiday_date_str = request.form.get('holiday_date')
    description = request.form.get('description', 'Holiday')
    start_date = request.form.get('start_date')
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('attendance', start_date=start_date))
    try:
        cursor = conn.cursor()
        sql = """
        MERGE holidays AS target
        USING (SELECT ? AS holiday_date, ? AS description, 'Holiday' AS day_type) AS source
        ON (target.holiday_date = source.holiday_date)
        WHEN MATCHED THEN
            UPDATE SET day_type = source.day_type, description = source.description
        WHEN NOT MATCHED THEN
            INSERT (holiday_date, description, day_type) VALUES (source.holiday_date, source.description, source.day_type);
        """
        cursor.execute(sql, holiday_date_str, description)
        conn.commit()
        flash(f'Holiday on {holiday_date_str} added successfully.', 'success')
    except Exception as e:
        flash(f'An error occurred: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()
    return redirect(url_for('attendance', start_date=start_date))

@app.route('/remove_employee', methods=['POST'], endpoint='remove_employee')
def remove_employee():
    e_code, start_date = request.form.get('e_code'), request.form.get('start_date')
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('attendance'))
    try:
        cursor = conn.cursor()
        cursor.execute("DELETE FROM employees WHERE [E.code] = ?", e_code)
        conn.commit()
        if cursor.rowcount > 0:
            flash(f'Employee with E.code "{e_code}" has been removed.', 'success')
        else:
            flash(f'Could not find employee with E.code "{e_code}".', 'error')
    except Exception as e:
        flash(f'An error occurred while removing the employee: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()
    return redirect(url_for('attendance', start_date=start_date))


def create_and_insert_employee(e_code, name, company, stage, doj_date, default_shift):
    conn = get_db_connection()
    try:
        cursor = conn.cursor()
        create_table_sql = """
        CREATE TABLE employees (
            [E.code] NVARCHAR(50) PRIMARY KEY, [Name of the Employee] NVARCHAR(255),
            [Company / Contract] NVARCHAR(255), [DOJ] DATETIME, [Stage] NVARCHAR(255),
            [Default Shift] INT
        );
        """
        cursor.execute(create_table_sql)
        sql_insert = "INSERT INTO employees ([E.code], [Name of the Employee], [Company / Contract], [Stage], [DOJ], [Default Shift]) VALUES (?, ?, ?, ?, ?, ?)"
        params = (e_code, name, company, stage, doj_date, default_shift)
        cursor.execute(sql_insert, params)
        conn.commit()
        flash(f'Employees table created and first employee ({name}) added!', 'success')
    except Exception as e:
        flash(f'Failed to create table and add employee: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()


# In app/routes.py

@app.route('/upload_triggers', methods=['POST'], endpoint='upload_triggers')
def upload_triggers():
    if 'file' not in request.files or request.files['file'].filename == '':
        flash('No file selected. Please choose a CSV file.', 'error')
        return redirect(request.referrer or url_for('production_planning'))

    file = request.files['file']
    if not file.filename.endswith('.csv'):
        flash('Invalid file type. Please upload a .csv file.', 'error')
        return redirect(request.referrer or url_for('production_planning'))

    filepath, conn = None, None
    try:
        filename = secure_filename(file.filename)
        filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        file.save(filepath)

        df = pd.read_csv(filepath, low_memory=False)

        # 1. Find and standardize column names
        item_code_col_actual = next((col for col in df.columns if str(col).strip().upper() == 'ITEM CODE'), None)
        qty_col_actual = next((col for col in df.columns if str(col).strip().upper() == 'QTY'), None)

        if not item_code_col_actual or not qty_col_actual:
            flash("Upload failed: Required columns 'ITEM CODE' or 'QTY' not found in the CSV file.", 'error')
            return redirect(request.referrer or url_for('production_planning'))

        df.rename(columns={
            item_code_col_actual: 'Item code',
            qty_col_actual: 'Qty'
        }, inplace=True)

        item_code_col = 'Item code'
        qty_col = 'Qty'

        # 2. Clean the data
        df[item_code_col] = df[item_code_col].astype(str).str.strip().str.lstrip("'")
        df[qty_col] = pd.to_numeric(df[qty_col], errors='coerce').fillna(0)
        
        due_dt_col = None
        for col_name in ['TRIGGER DT', 'DUE DT']:
            actual_col = next((c for c in df.columns if str(c).strip().upper() == col_name), None)
            if actual_col:
                # 'dayfirst=True' ensures 05-01-2026 is read as Jan 5th, not May 1st
                df[actual_col] = pd.to_datetime(df[actual_col], dayfirst=True, errors='coerce')
                if str(actual_col).strip().upper() == 'DUE DT':
                    due_dt_col = actual_col

        # --- LOGIC: Define Time Windows ---
        # Using date.today() allows seamless year transition (e.g. Dec 23 -> Jan 23)
        today_date = date.today()
        
        # Calculate 31 days into the future
        cutoff_date = today_date + timedelta(days=31)
        
        # Initialize DataFrames
        df_today = df.copy() 
        df_future = pd.DataFrame(columns=df.columns)

        if due_dt_col:
            # 1. Pending: Due Date is TODAY or Earlier (Overdue)
            df_today = df[df[due_dt_col].dt.date <= today_date]
            
            # 2. Next Pending: Due Date is TOMORROW -> NEXT 31 DAYS
            # Logic: (Date > Today) AND (Date <= Today + 31 Days)
            # This logic works correctly across year boundaries (e.g. Dec 2025 to Jan 2026)
            df_future = df[
                (df[due_dt_col].dt.date > today_date) & 
                (df[due_dt_col].dt.date <= cutoff_date)
            ]

        # Aggregate Quantities per Item
        agg_today = df_today.groupby(item_code_col)[qty_col].sum().reset_index()
        agg_future = df_future.groupby(item_code_col)[qty_col].sum().reset_index()

        conn = get_db_connection()
        if not conn: raise ConnectionError("Database connection failed.")
        cursor = conn.cursor()

        # ---------------------------------------------------------
        # HISTORY LOGGING (Keeps record of "Pending" for today)
        # ---------------------------------------------------------
        
        cursor.execute("""
            IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='trigger_history' and xtype='U')
            CREATE TABLE trigger_history (
                history_id INT IDENTITY(1,1) PRIMARY KEY,
                upload_date DATE NOT NULL,
                item_code NVARCHAR(255) NOT NULL,
                pending_quantity INT NOT NULL,
                created_at DATETIME DEFAULT GETDATE()
            );
        """)
        
        # Clear previous history for TODAY only (allows re-upload fix)
        cursor.execute("DELETE FROM trigger_history WHERE upload_date = ?", today_date)

        # Insert New Snapshot
        history_params = [
            (today_date, str(row[item_code_col]), row[qty_col]) 
            for index, row in agg_today.iterrows() 
            if row[qty_col] > 0
        ]
        
        if history_params:
            cursor.executemany("""
                INSERT INTO trigger_history (upload_date, item_code, pending_quantity) 
                VALUES (?, ?, ?)
            """, history_params)

        # ---------------------------------------------------------
        # UPDATE MASTER TABLE
        # ---------------------------------------------------------

        # Ensure 'Next Pending' column exists
        cursor.execute("""
            IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'Next Pending' AND Object_ID = Object_ID(N'master'))
                ALTER TABLE master ADD [Next Pending] INT DEFAULT 0 WITH VALUES;
        """)
        conn.commit()

        # Save full raw details to 'pending_triggers' table
        replace_table_with_df(df, 'pending_triggers', cursor)

        # Reset Master Columns (Pending & Next Pending) to 0 before update
        cursor.execute("UPDATE master SET [Pending] = 0, [Next Pending] = 0")

        # Update [Pending] (Today/Overdue)
        update_count = 0
        for index, row in agg_today.iterrows():
            cursor.execute("UPDATE master SET [Pending] = ? WHERE [Item code] = ?", row[qty_col], str(row[item_code_col]))
            update_count += cursor.rowcount

        # Update [Next Pending] (Tomorrow to 31 Days)
        for index, row in agg_future.iterrows():
            cursor.execute("UPDATE master SET [Next Pending] = ? WHERE [Item code] = ?", row[qty_col], str(row[item_code_col]))

        # Record Upload Timestamp
        upsert_sql = """
            MERGE app_status AS target
            USING (SELECT 'last_triggers_upload_timestamp' AS src_key, ? AS src_val) AS src 
            ON (target.status_key = src.src_key)
            WHEN MATCHED THEN 
                UPDATE SET status_value = src.src_val
            WHEN NOT MATCHED THEN 
                INSERT (status_key, status_value) VALUES (src.src_key, src.src_val);
        """
        now_timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        cursor.execute(upsert_sql, now_timestamp)

        conn.commit()
        
        flash(f'Triggers uploaded. Updated {update_count} items in Pending. "Next Pending" updated for the next 31 days.', 'success')

    except Exception as e:
        if conn: conn.rollback()
        flash(f'An error occurred during trigger upload: {e}', 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()
        if filepath and os.path.exists(filepath): os.remove(filepath)

    return redirect(request.referrer or url_for('production_planning'))
@app.route('/api/stage_totals')
def api_stage_totals():
    """
    API endpoint to return the current WIP stage totals AND Monthly Data.
    """
    stage_totals = {}
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            
            # 1. Fetch WIP Stage Totals
            current_stages = get_dynamic_stages(cursor, dashboard_only=True)
            if current_stages:
                sum_clauses = [f"SUM(ISNULL([{stage}], 0)) as [{stage}]" for stage in current_stages]
                sql_wip = f"SELECT {', '.join(sum_clauses)} FROM master"
                cursor.execute(sql_wip)
                row = cursor.fetchone()
                if row:
                    stage_totals = row_to_dict(cursor, row)
            
            # 2. Fetch Monthly Dispatch
            sql_monthly = """
                SELECT SUM(quantity) FROM production_log 
                WHERE to_stage IN ('Dispatch', 'Delivered') 
                AND MONTH(moved_at) = MONTH(GETDATE()) 
                AND YEAR(moved_at) = YEAR(GETDATE())
            """
            cursor.execute(sql_monthly)
            monthly_val = cursor.fetchone()[0] or 0
            stage_totals['Dispatch'] = monthly_val

            # 3. Calculate Monthly Trigger Adherence (NEW FORMULA)
            monthly_adherence_val = calculate_monthly_trigger_adherence(conn)
            stage_totals['MonthlyTriggerAdherence'] = monthly_adherence_val

        except Exception as e:
            print(f"API Error fetching stage totals: {e}")
            traceback.print_exc()
        finally:
            conn.close()
    return jsonify(stage_totals)


@app.route('/api/inventory/<item_code>')
def get_inventory_for_item(item_code):
    """
    API endpoint to return the inventory counts for a single item code.
    """
    inventory = {}
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            stage_columns = ', '.join([f"[{stage}]" for stage in STAGES]) + ', [Live Dispatch] as [Dispatch]'
            sql_query = f"SELECT {stage_columns} FROM master WHERE [Item code] = ?"
            cursor.execute(sql_query, item_code)
            row = cursor.fetchone()
            if row:
                inventory = row_to_dict(cursor, row)
        except Exception as e:
            print(f"API Error fetching single item inventory: {e}")
        finally:
            if conn: conn.close()
    return jsonify(inventory)

@app.route('/api/inventory/vertical/<vertical_name>')
def get_inventory_for_vertical(vertical_name):
    """
    API endpoint to return the SUM of inventory for a given Vertical.
    """
    inventory = {}
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            stage_columns_sum = ', '.join([f"SUM(ISNULL([{stage}], 0)) as [{stage}]" for stage in STAGES]) + ', SUM(ISNULL([Live Dispatch], 0)) as [Dispatch]'
            sql_query = f"SELECT {stage_columns_sum} FROM master WHERE [Vertical] = ?"
            cursor.execute(sql_query, vertical_name)
            row = cursor.fetchone()
            if row:
                inventory = row_to_dict(cursor, row)
        except Exception as e:
            print(f"API Error fetching vertical inventory: {e}")
        finally:
            if conn: conn.close()
    return jsonify(inventory)

@app.route('/api/inventory/category/<category_name>')
def get_inventory_for_category(category_name):
    """
    API endpoint to return the SUM of inventory for a given Category.
    """
    inventory = {}
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            stage_columns_sum = ', '.join([f"SUM(ISNULL([{stage}], 0)) as [{stage}]" for stage in STAGES]) + ', SUM(ISNULL([Live Dispatch], 0)) as [Dispatch]'
            sql_query = f"SELECT {stage_columns_sum} FROM master WHERE [Category] = ?"
            cursor.execute(sql_query, category_name)
            row = cursor.fetchone()
            if row:
                inventory = row_to_dict(cursor, row)
        except Exception as e:
            print(f"API Error fetching category inventory: {e}")
        finally:
            if conn: conn.close()
    return jsonify(inventory)

def calculate_adherence(conn, item_codes=None, verticals=None, categories=None, types=None):
    """
    Helper function: Calculates ONLY Daily Adherence.
    Monthly Adherence references removed.
    """
    daily_adherence = 0

    # 1. Build Filter Logic
    filter_clause_master = ""  
    params = []

    if item_codes:
        seq = ','.join(['?'] * len(item_codes))
        filter_clause_master += f" AND m.[Item code] IN ({seq})"
        params.extend(item_codes)
    if verticals:
        seq = ','.join(['?'] * len(verticals))
        filter_clause_master += f" AND m.[Vertical] IN ({seq})"
        params.extend(verticals)
    if categories:
        seq = ','.join(['?'] * len(categories))
        filter_clause_master += f" AND m.[Category] IN ({seq})"
        params.extend(categories)
    if types:
        seq = ','.join(['?'] * len(types))
        filter_clause_master += f" AND m.[Type] IN ({seq})"
        params.extend(types)

    try:
        cursor = conn.cursor()

        # --- DAILY ADHERENCE ---
        sql_daily_target = f"SELECT SUM(ISNULL(m.[Pending], 0)) FROM master m WHERE 1=1 {filter_clause_master}"
        cursor.execute(sql_daily_target, params)
        total_daily_target = cursor.fetchone()[0] or 0

        sql_daily_actual = f"""
            DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
            DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
            DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

            SELECT SUM(pl.quantity) FROM production_log pl
            INNER JOIN master m ON pl.item_code = m.[Item code]
            WHERE pl.to_stage IN ('Dispatch', 'Delivered') 
            AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
            {filter_clause_master}
        """
        cursor.execute(sql_daily_actual, params)
        total_daily_dispatched = cursor.fetchone()[0] or 0

        if total_daily_target > 0:
            daily_adherence = (total_daily_dispatched / total_daily_target) * 100

    except Exception:
        traceback.print_exc()

    # RETURN ONLY DAILY ADHERENCE
    return {'daily_adherence': daily_adherence}

@app.route('/api/adherence/totals')
def api_adherence_totals():
    conn = get_db_connection()
    data = {}
    if conn:
        try:
            data = calculate_adherence(conn)
        finally:
            conn.close()
    return jsonify(data)

@app.route('/api/adherence/item_code/<item_code>')
def api_adherence_item_code(item_code):
    conn = get_db_connection()
    data = {}
    if conn:
        try:
            # MODIFIED: Pass as a list
            data = calculate_adherence(conn, item_codes=[item_code])
        finally:
            conn.close()
    return jsonify(data)

@app.route('/api/adherence/vertical/<vertical_name>')
def api_adherence_vertical(vertical_name):
    conn = get_db_connection()
    data = {}
    if conn:
        try:
            # MODIFIED: Pass as a list
            data = calculate_adherence(conn, verticals=[vertical_name])
        finally:
            conn.close()
    return jsonify(data)

@app.route('/api/adherence/category/<category_name>')
def api_adherence_category(category_name):
    conn = get_db_connection()
    data = {}
    if conn:
        try:
            # MODIFIED: Pass as a list
            data = calculate_adherence(conn, categories=[category_name])
        finally:
            conn.close()
    return jsonify(data)


@app.route('/api/inventory/filtered', methods=['POST'])
def api_inventory_filtered():
    data = request.get_json()
    item_codes = data.get('item_code', [])
    verticals = data.get('vertical', [])
    categories = data.get('category', [])
    # --- NEW: Get Type ---
    types = data.get('type', [])

    inventory = {}
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            
            # --- 1. Build Filter Logic ---
            base_filter = ""
            params = []

            if item_codes:
                seq = ','.join(['?'] * len(item_codes))
                base_filter += f" AND [Item code] IN ({seq})"
                params.extend(item_codes)
            if verticals:
                seq = ','.join(['?'] * len(verticals))
                base_filter += f" AND [Vertical] IN ({seq})"
                params.extend(verticals)
            if categories:
                seq = ','.join(['?'] * len(categories))
                base_filter += f" AND [Category] IN ({seq})"
                params.extend(categories)
            # --- NEW: SQL for Type ---
            if types:
                seq = ','.join(['?'] * len(types))
                base_filter += f" AND [Type] IN ({seq})"
                params.extend(types)

            # --- 2. Get WIP Totals ---
            current_stages = get_dynamic_stages(cursor, dashboard_only=True)
            if not current_stages: current_stages = STAGES 

            stage_columns_sum = ', '.join([f"SUM(ISNULL([{stage}], 0)) as [{stage}]" for stage in current_stages])
            
            sql_wip = f"SELECT {stage_columns_sum} FROM master WHERE 1=1 {base_filter}"
            cursor.execute(sql_wip, params)
            row = cursor.fetchone()
            if row:
                inventory = row_to_dict(cursor, row)

            # --- 3. Get Monthly Dispatch ---
            sql_monthly = f"""
                SELECT SUM(pl.quantity) 
                FROM production_log pl
                JOIN master m ON pl.item_code = m.[Item code]
                WHERE pl.to_stage IN ('Dispatch', 'Delivered') 
                AND MONTH(pl.moved_at) = MONTH(GETDATE()) 
                AND YEAR(pl.moved_at) = YEAR(GETDATE())
                {base_filter.replace('[Item code]', 'm.[Item code]')
                            .replace('[Vertical]', 'm.[Vertical]')
                            .replace('[Category]', 'm.[Category]')
                            .replace('[Type]', 'm.[Type]')} 
            """
            cursor.execute(sql_monthly, params)
            monthly_val = cursor.fetchone()[0] or 0
            
            inventory['Dispatch'] = monthly_val

        except Exception as e:
            print(f"API Error fetching filtered inventory: {e}")
            traceback.print_exc()
        finally:
            if conn: conn.close()
    return jsonify(inventory)




@app.route('/items', endpoint='manage_items')
@login_required
def manage_items():
    page = request.args.get('page', 1, type=int)
    per_page = 20
    offset = (page - 1) * per_page
    search_query = request.args.get('search', '')

    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('dashboard'))

    items = []
    stages = []
    pagination = None

    try:
        cursor = conn.cursor()

        # 1. Fetch Dynamic Stages (to build table headers)
        cursor.execute("SELECT stage_name FROM manufacturing_stages ORDER BY display_order ASC")
        stages = [row[0] for row in cursor.fetchall()]

        # 2. Build Query
        # We use SELECT * to get all columns including dynamic stages
        base_query = "SELECT * FROM master WHERE 1=1"
        count_query = "SELECT COUNT(*) FROM master WHERE 1=1"
        params = []

        if search_query:
            filter_clause = " AND ([Item code] LIKE ? OR [Description] LIKE ?)"
            base_query += filter_clause
            count_query += filter_clause
            params.extend([f'%{search_query}%', f'%{search_query}%'])

        # 3. Pagination
        cursor.execute(count_query, params)
        total_items = cursor.fetchone()[0]
        total_pages = ceil(total_items / per_page)

        # 4. Fetch Data
        final_query = base_query + " ORDER BY [Item code] OFFSET ? ROWS FETCH NEXT ? ROWS ONLY"
        params.extend([offset, per_page])

        cursor.execute(final_query, params)
        items = [row_to_dict(cursor, row) for row in cursor.fetchall()]

        pagination = {
            'page': page,
            'per_page': per_page,
            'total': total_items,
            'total_pages': total_pages,
            'has_prev': page > 1,
            'has_next': page < total_pages,
            'prev_num': page - 1,
            'next_num': page + 1
        }

    except Exception as e:
        flash(f"Error fetching items: {e}", 'error')
        traceback.print_exc()
    finally:
        conn.close()

    return render_template('items.html', items=items, stages=stages, pagination=pagination, search_query=search_query)


@app.route('/add_stage', methods=['POST'], endpoint='add_stage')
def add_stage():
    stage_name = request.form.get('stage_name').strip()
    # Checkbox returns 'on' if checked, None if unchecked
    include_dashboard = 1 if request.form.get('include_dashboard') else 0

    conn = get_db_connection()
    if not conn: return redirect(url_for('manage_stages'))

    try:
        cursor = conn.cursor()

        # 1. Validation: Check duplicate name
        cursor.execute("SELECT 1 FROM manufacturing_stages WHERE stage_name = ?", stage_name)
        if cursor.fetchone():
            flash(f"Stage '{stage_name}' already exists.", 'error')
            return redirect(url_for('manage_stages'))

        # --- LOGIC FIX: Insert BEFORE 'FG' ---

        # A. Find the current order of 'FG'
        cursor.execute("SELECT display_order FROM manufacturing_stages WHERE stage_name = 'FG'")
        fg_row = cursor.fetchone()

        if fg_row:
            target_order = fg_row[0]
            # B. Shift 'FG' (and anything that might be after it) down by 1 to make space
            cursor.execute("UPDATE manufacturing_stages SET display_order = display_order + 1 WHERE display_order >= ?",
                           target_order)
        else:
            # Fallback: If FG is missing for some reason, append to end
            cursor.execute("SELECT ISNULL(MAX(display_order), 0) + 1 FROM manufacturing_stages")
            target_order = cursor.fetchone()[0]

        # 2. Add to List Table at the specific target_order
        cursor.execute(
            "INSERT INTO manufacturing_stages (stage_name, display_order, is_dashboard_stage) VALUES (?, ?, ?)",
            (stage_name, target_order, include_dashboard))

        # 3. SYNC: Add Column to 'master' table
        # We check if column exists first to avoid crashes
        cursor.execute(f"""
            IF NOT EXISTS (SELECT * FROM sys.columns WHERE Name = N'{stage_name}' AND Object_ID = Object_ID(N'master'))
            BEGIN
                ALTER TABLE master ADD [{stage_name}] INT NOT NULL DEFAULT 0 WITH VALUES;
            END
        """)

        conn.commit()
        flash(f"Stage '{stage_name}' added successfully.", 'success')

    except Exception as e:
        if conn: conn.rollback()
        flash(f"Error adding stage: {e}", 'error')
        print(f"Error in add_stage: {e}")  # Print to terminal for debugging
    finally:
        if conn: conn.close()

    return redirect(url_for('manage_stages'))


# In app/routes.py

@app.route('/edit_stage', methods=['POST'], endpoint='edit_stage')
def edit_stage():
    stage_id = request.form.get('stage_id')
    new_name = request.form.get('stage_name').strip()
    original_name = request.form.get('original_name').strip()
    # Checkbox logic: 1 if checked, 0 if not
    include_dashboard = 1 if request.form.get('include_dashboard') else 0

    conn = get_db_connection()
    if not conn: return redirect(url_for('manage_stages'))

    try:
        cursor = conn.cursor()

        # --- 1. PROTECTION CHECK ---
        # Prevent users from renaming system-critical stages
        if original_name in ['Not Started', 'FG']:
            flash(f"System stage '{original_name}' cannot be edited.", 'error')
            return redirect(url_for('manage_stages'))

        # --- 2. UPDATE LIST TABLE ---
        # Update the name and the dashboard preference flag
        cursor.execute("""
            UPDATE manufacturing_stages 
            SET stage_name = ?, is_dashboard_stage = ? 
            WHERE id = ?
        """, (new_name, include_dashboard, stage_id))

        # --- 3. SYNC COLUMN NAMES ---
        # Only perform expensive DB operations if the name actually changed
        if new_name != original_name:
            # We check 'master' and 'Production_pl' to keep them in sync
            for table in ['master', 'Production_pl']:
                # Check if the old column exists before trying to rename
                cursor.execute(
                    f"SELECT 1 FROM sys.columns WHERE Name = N'{original_name}' AND Object_ID = Object_ID(N'{table}')")
                if cursor.fetchone():
                    # Check if the NEW name already exists (to avoid collision errors)
                    cursor.execute(
                        f"SELECT 1 FROM sys.columns WHERE Name = N'{new_name}' AND Object_ID = Object_ID(N'{table}')")
                    if cursor.fetchone():
                        # If new name exists, we can't rename. Rollback logic or skip.
                        # For simplicity, we skip renaming in this edge case to prevent crash.
                        pass
                    else:
                        # Use sp_rename to rename the column safely
                        query = f"EXEC sp_rename '{table}.[{original_name}]', '{new_name}', 'COLUMN';"
                        cursor.execute(query)

        conn.commit()
        flash(f"Stage '{original_name}' updated successfully.", 'success')
    except Exception as e:
        flash(f"Error updating stage: {e}", 'error')
        if conn: conn.rollback()
    finally:
        if conn: conn.close()

    return redirect(url_for('manage_stages'))


@app.route('/delete_stage', methods=['POST'], endpoint='delete_stage')
def delete_stage():
    stage_id = request.form.get('stage_id')
    stage_name = request.form.get('stage_name')

    conn = get_db_connection()
    if not conn: return redirect(url_for('manage_stages'))

    try:
        cursor = conn.cursor()

        # --- 1. PROTECTION CHECK ---
        if stage_name in ['Not Started', 'FG']:
            flash(f"System stage '{stage_name}' cannot be deleted.", 'error')
            return redirect(url_for('manage_stages'))

        # --- 2. REMOVE FROM LIST TABLE ---
        cursor.execute("DELETE FROM manufacturing_stages WHERE id = ?", stage_id)

        # --- 3. DROP COLUMN FROM MASTER ---
        # We must use dynamic SQL to find and drop the Default Constraint first,
        # otherwise the DROP COLUMN command will fail in SQL Server.
        drop_logic = f"""
            DECLARE @ConstraintName nvarchar(200);

            -- A. Find the constraint name for this specific column in 'master'
            SELECT @ConstraintName = Name 
            FROM sys.default_constraints 
            WHERE parent_object_id = OBJECT_ID('master') 
            AND parent_column_id = (SELECT column_id FROM sys.columns WHERE Name = N'{stage_name}' AND object_id = OBJECT_ID('master'));

            -- B. If a constraint exists, delete it
            IF @ConstraintName IS NOT NULL
            BEGIN
                EXEC('ALTER TABLE master DROP CONSTRAINT ' + @ConstraintName);
            END

            -- C. Now safely drop the column
            IF EXISTS (SELECT * FROM sys.columns WHERE Name = N'{stage_name}' AND Object_ID = Object_ID(N'master'))
            BEGIN
                ALTER TABLE master DROP COLUMN [{stage_name}];
            END
        """
        cursor.execute(drop_logic)

        conn.commit()
        flash(f"Stage '{stage_name}' deleted.", 'success')

    except Exception as e:
        flash(f"Error deleting stage: {e}", 'error')
        if conn: conn.rollback()
    finally:
        if conn: conn.close()

    return redirect(url_for('manage_stages'))

# --- STAGE MANAGEMENT ROUTES ---

# --- ADD THESE MISSING FUNCTIONS ---

@app.route('/edit_item', methods=['POST'], endpoint='edit_item')
def edit_item():
    original_item_code = request.form.get('original_item_code')
    if not original_item_code:
        flash("Original Item Code missing.", "error")
        return redirect(url_for('manage_items'))

    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('manage_items'))

    try:
        cursor = conn.cursor()

        # Define mapping for standard fields (Form Name -> DB Column Name)
        field_map = {
            'item_code': 'Item code',
            'description': 'Description',
            'vertical': 'Vertical',
            'category': 'Category',
            'type': 'Type',
            'model': 'Model',
            'monthly_avg': 'MonthlyAvg',
            'daily_max': 'Daily Max Plan',
            'max_inv': 'Max Inv',
            'rpl_days': 'RPL days to Delivery'
        }

        update_clauses = []
        params = []

        # Iterate over all form data submitted
        for key, value in request.form.items():
            if key == 'original_item_code':
                continue

            db_column = None

            # Check if it is a standard field
            if key in field_map:
                db_column = field_map[key]
            else:
                # If not a standard field, assume it is a dynamic Stage Name (e.g., "Long seam")
                # We trust the form data here because the input names are generated from the DB stages
                db_column = key

            # Build the update clause
            if db_column:
                update_clauses.append(f"[{db_column}] = ?")

                # Handle empty strings for numeric fields (default to 0)
                # If it's a text field, keep it as empty string
                text_fields = ['item_code', 'description', 'vertical', 'category', 'type', 'model']

                if value == '' and key not in text_fields:
                    params.append(0)
                else:
                    params.append(value)

        # Add the WHERE clause parameter
        params.append(original_item_code)

        if update_clauses:
            sql = f"UPDATE master SET {', '.join(update_clauses)} WHERE [Item code] = ?"
            cursor.execute(sql, params)
            conn.commit()
            flash(f"Item updated successfully.", 'success')
        else:
            flash("No changes detected.", "info")

    except Exception as e:
        flash(f"Error updating item: {e}", 'error')
        traceback.print_exc()
        if conn: conn.rollback()
    finally:
        if conn: conn.close()

    return redirect(url_for('manage_items'))


@app.route('/delete_item', methods=['POST'], endpoint='delete_item')
def delete_item():
    item_code = request.form.get('item_code')
    conn = get_db_connection()
    if not conn: return redirect(url_for('manage_items'))

    try:
        cursor = conn.cursor()

        # Optional: Delete from child tables first if you want to enforce clean up
        # cursor.execute("DELETE FROM Production_pl WHERE [Item code ] = ?", item_code)

        # Delete from master
        cursor.execute("DELETE FROM master WHERE [Item code] = ?", item_code)
        conn.commit()
        flash(f"Item '{item_code}' deleted.", 'success')
    except Exception as e:
        flash(f"Error deleting item: {e}", 'error')
    finally:
        conn.close()

    return redirect(url_for('manage_items'))

def get_ordered_stages(cursor):
    """Helper to fetch stages in defined order"""
    cursor.execute("SELECT stage_name FROM manufacturing_stages ORDER BY display_order ASC")
    return [row[0] for row in cursor.fetchall()]


@app.route('/add_item', methods=['POST'], endpoint='add_item')
def add_item():
    # Collect basic form data
    item_code = request.form.get('item_code')
    description = request.form.get('description')
    vertical = request.form.get('vertical')
    category = request.form.get('category')
    item_type = request.form.get('type')
    model = request.form.get('model')
    # Default numeric fields to 0 if empty
    monthly_avg = request.form.get('monthly_avg') or 0
    daily_max = request.form.get('daily_max') or 0
    max_inv = request.form.get('max_inv') or 0
    rpl_days = request.form.get('rpl_days') or 0

    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('manage_items'))

    try:
        cursor = conn.cursor()

        # 1. Validation: Check if Item Code already exists
        cursor.execute("SELECT 1 FROM master WHERE [Item code] = ?", item_code)
        if cursor.fetchone():
            flash(f"Error: Item code '{item_code}' already exists.", 'error')
            return redirect(url_for('manage_items'))

        # 2. Insert new item
        # Note: We initialize [TriggerAccumulator] to 0
        sql = """
            INSERT INTO master (
                [Item code], [Description], [Vertical], [Category], [Type], [Model], 
                [MonthlyAvg], [Daily Max Plan], [Max Inv], [RPL days to Delivery],
                [TriggerAccumulator]
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0)
        """
        params = (
        item_code, description, vertical, category, item_type, model, monthly_avg, daily_max, max_inv, rpl_days)

        cursor.execute(sql, params)
        conn.commit()
        flash(f"Item '{item_code}' added successfully.", 'success')

    except Exception as e:
        if conn: conn.rollback()
        flash(f"Error adding item: {e}", 'error')
        # traceback.print_exc() # Uncomment for debugging
    finally:
        if conn: conn.close()

    return redirect(url_for('manage_items'))

@app.route('/stages', endpoint='manage_stages')
@login_required
def manage_stages():
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(url_for('dashboard'))

    stages = []
    try:
        cursor = conn.cursor()
        # FETCH extra column: is_dashboard_stage
        cursor.execute(
            "SELECT id, stage_name, display_order, is_dashboard_stage FROM manufacturing_stages ORDER BY display_order ASC")
        stages = [row_to_dict(cursor, row) for row in cursor.fetchall()]
    except Exception as e:
        flash(f"Error fetching stages: {e}", 'error')
    finally:
        conn.close()

    return render_template('stages.html', stages=stages)




@app.route('/reorder_stages', methods=['POST'], endpoint='reorder_stages')
def reorder_stages():
    # Expects JSON list of IDs in new order: [5, 2, 1, 3...]
    data = request.get_json()
    new_order_ids = data.get('order', [])

    conn = get_db_connection()
    try:
        cursor = conn.cursor()
        for index, stage_id in enumerate(new_order_ids):
            # Update display_order based on the index in the received list (1-based)
            cursor.execute("UPDATE manufacturing_stages SET display_order = ? WHERE id = ?", (index + 1, stage_id))
        conn.commit()
        return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500
    finally:
        conn.close()


# In app/routes.py

def get_dynamic_stages(cursor, dashboard_only=False):
    """
    Fetches stages.
    If dashboard_only=True, returns only stages marked for dashboard.
    Otherwise, returns all stages.
    """
    try:
        if dashboard_only:
            cursor.execute(
                "SELECT stage_name FROM manufacturing_stages WHERE is_dashboard_stage = 1 ORDER BY display_order ASC")
        else:
            cursor.execute("SELECT stage_name FROM manufacturing_stages ORDER BY display_order ASC")

        return [row[0] for row in cursor.fetchall()]
    except Exception:
        return []


@app.route('/api/vertical_overview', endpoint='api_vertical_overview')
def api_vertical_overview():
    conn = get_db_connection()
    if not conn: return jsonify([])
    
    # --- NEW: Get Filter ---
    filter_type = request.args.get('type')

    try:
        cursor = conn.cursor()
        
        # Build Clause
        filter_clause = " AND p.[Vertical] IS NOT NULL"
        params = []
        if filter_type:
            filter_clause += " AND m.[Type] = ?"
            params.append(filter_type)

        sql_vertical = f"""
            DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
            DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
            DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

            WITH VerticalFG AS (
                SELECT m.[Vertical], SUM(pl.quantity) as QtyReachedFG
                FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                WHERE pl.to_stage = 'FG' AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                GROUP BY m.[Vertical]
            ),
            VerticalDispatch AS (
                SELECT m.[Vertical], SUM(pl.quantity) as QtyDispatched
                FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                WHERE pl.from_stage = 'FG' AND pl.to_stage = 'Dispatch'
                AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                GROUP BY m.[Vertical]
            )
            SELECT 
                p.[Vertical], 
                SUM(ISNULL(m.[Pending], 0)) as [Opening Trigger],
                CASE 
                    WHEN (SUM(ISNULL(m.[Pending], 0)) - ISNULL(vd.QtyDispatched, 0)) < 0 THEN 0
                    ELSE (SUM(ISNULL(m.[Pending], 0)) - ISNULL(vd.QtyDispatched, 0))
                END as [Pending],
                ISNULL(vd.QtyDispatched, 0) as [Dispatch],
                ISNULL(vfg.QtyReachedFG, 0) as [Achieved]
            FROM Production_pl p 
            LEFT JOIN master m ON p.[Item code ] = m.[Item code]
            LEFT JOIN VerticalFG vfg ON p.[Vertical] = vfg.[Vertical]
            LEFT JOIN VerticalDispatch vd ON p.[Vertical] = vd.[Vertical]
            WHERE 1=1 {filter_clause}
            GROUP BY p.[Vertical], vfg.QtyReachedFG, vd.QtyDispatched 
            ORDER BY p.[Vertical]
        """
        cursor.execute(sql_vertical, params)
        data = [row_to_dict(cursor, row) for row in cursor.fetchall()]

        for item in data:
            trig = item.get('Opening Trigger', 0)
            ach = item.get('Achieved', 0)
            item['AdherencePercent'] = (ach * 100.0 / trig) if trig > 0 else 100.0

        return jsonify(data)
    finally:
        conn.close()


@app.route('/api/category_overview', endpoint='api_category_overview')
def api_category_overview():
    conn = get_db_connection()
    if not conn: return jsonify([])

    # --- NEW: Get Filter ---
    filter_type = request.args.get('type')

    try:
        cursor = conn.cursor()
        
        # Build Clause
        filter_clause = " AND p.[Category] IS NOT NULL"
        params = []
        if filter_type:
            filter_clause += " AND m.[Type] = ?"
            params.append(filter_type)

        sql_category = f"""
            DECLARE @CurrentProductionDate DATE = CAST(DATEADD(hour, -2, GETDATE()) AS DATE);
            DECLARE @ProductionDayStart DATETIME = DATEADD(hour, 2, CAST(@CurrentProductionDate AS DATETIME));
            DECLARE @ProductionDayEnd DATETIME = DATEADD(day, 1, @ProductionDayStart);

            WITH CategoryFG AS (
                SELECT m.[Category], SUM(pl.quantity) as QtyReachedFG
                FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                WHERE pl.to_stage = 'FG' AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                GROUP BY m.[Category]
            ),
            CategoryDispatch AS (
                SELECT m.[Category], SUM(pl.quantity) as QtyDispatched
                FROM production_log pl JOIN master m ON pl.item_code = m.[Item code]
                WHERE pl.from_stage = 'FG' AND pl.to_stage = 'Dispatch'
                AND pl.moved_at >= @ProductionDayStart AND pl.moved_at < @ProductionDayEnd
                GROUP BY m.[Category]
            )
            SELECT 
                p.[Category], 
                SUM(ISNULL(m.[Pending], 0)) as [Opening Trigger],
                CASE 
                    WHEN (SUM(ISNULL(m.[Pending], 0)) - ISNULL(cd.QtyDispatched, 0)) < 0 THEN 0
                    ELSE (SUM(ISNULL(m.[Pending], 0)) - ISNULL(cd.QtyDispatched, 0))
                END as [Pending],
                ISNULL(cd.QtyDispatched, 0) as [Dispatch],
                ISNULL(cfg.QtyReachedFG, 0) as [Achieved]
            FROM Production_pl p 
            LEFT JOIN master m ON p.[Item code ] = m.[Item code]
            LEFT JOIN CategoryFG cfg ON p.[Category] = cfg.[Category]
            LEFT JOIN CategoryDispatch cd ON p.[Category] = cd.[Category]
            WHERE 1=1 {filter_clause}
            GROUP BY p.[Category], cfg.QtyReachedFG, cd.QtyDispatched
            ORDER BY p.[Category]
        """
        cursor.execute(sql_category, params)
        data = [row_to_dict(cursor, row) for row in cursor.fetchall()]

        for item in data:
            trig = item.get('Opening Trigger', 0)
            ach = item.get('Achieved', 0)
            item['AdherencePercent'] = (ach * 100.0 / trig) if trig > 0 else 100.0

        return jsonify(data)
    finally:
        conn.close()      
       
        
    
@app.before_request
def make_session_permanent():
    session.permanent = True # Enforce the 30-minute timeout defined in Config
    session.modified = True  # Reset the timer on every request
    
# In app/routes.py

import calendar

@app.route('/upload_dispatch', methods=['POST'], endpoint='upload_dispatch')
@login_required
def upload_dispatch():
    if 'file' not in request.files or request.files['file'].filename == '':
        flash('No file selected.', 'error')
        return redirect(request.referrer)

    file = request.files['file']
    if not file.filename.endswith(('.xlsx', '.xls')):
        flash('Invalid file type. Please upload an Excel file.', 'error')
        return redirect(request.referrer)

    filepath = None
    conn = get_db_connection()
    if not conn:
        flash('Database connection failed.', 'error')
        return redirect(request.referrer)

    try:
        filename = secure_filename(file.filename)
        filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        file.save(filepath)

        # 1. Read Excel (First Sheet) using 'with' to ensure file is CLOSED afterwards
        target_month = None
        target_year = None
        df = None
        sheet_name = ""

        with pd.ExcelFile(filepath) as xls:
            sheet_name = xls.sheet_names[0] # Use first sheet automatically
            df = pd.read_excel(xls, sheet_name=sheet_name)

        # 2. Parse Month/Year from Sheet Name (Expected format: "Dec- 25", "Jan 24", etc.)
        import re
        date_match = re.search(r"([A-Za-z]{3})[\s-]*(\d{2})", sheet_name)
        
        if date_match:
            try:
                month_str = date_match.group(1)
                year_str = "20" + date_match.group(2) # Assume 20xx
                target_date_obj = datetime.strptime(f"{month_str}-{year_str}", "%b-%Y")
                target_month = target_date_obj.month
                target_year = target_date_obj.year
            except ValueError:
                pass
        
        # Fallback: If sheet name parsing fails, try to guess from the first valid date column header
        if not target_month:
            for col in df.columns:
                if isinstance(col, datetime):
                    target_month = col.month
                    target_year = col.year
                    break
        
        if not target_month or not target_year:
            flash(f"Could not detect Month/Year from sheet name '{sheet_name}'. Please rename sheet to format 'MMM- YY' (e.g., 'Dec- 25').", 'error')
            return redirect(request.referrer)

        print(f"DEBUG: Processing Dispatch for {target_month}/{target_year}")

        # 3. Clean & Process Data
        # Standardize columns
        df.columns = [str(c).strip() if isinstance(c, str) else c for c in df.columns]
        
        # Deduplicate columns
        new_columns = []
        seen_columns = {}
        for col in df.columns:
            col_str = str(col)
            if col_str in seen_columns:
                seen_columns[col_str] += 1
                new_columns.append(f"{col_str}.{seen_columns[col_str]}")
            else:
                seen_columns[col_str] = 0
                new_columns.append(col)
        df.columns = new_columns

        # --- MODIFIED: Identify Item Code Column (Check for 'item code' OR 'spl') ---
        possible_headers = ['item code', 'spl']
        item_code_col = next((c for c in df.columns if str(c).lower().strip() in possible_headers), None)
        
        if not item_code_col:
            flash("Column 'Item code' or 'SPL' not found in Excel.", 'error')
            return redirect(request.referrer)

        # Identify Date Columns (Dynamic based on found item code col)
        info_cols = [str(item_code_col).lower(), 'description', 'vertical', 'model', 'category', 'type', 'total', 's.no']
        date_columns = [c for c in df.columns if str(c).lower() not in info_cols and not str(c).startswith('Unnamed')]

        log_records = []
        for index, row in df.iterrows():
            raw_code = row[item_code_col]
            if pd.isna(raw_code): continue
            item_code = str(raw_code).strip()

            for col in date_columns:
                raw_val = row[col]
                # Validate Quantity
                try:
                    qty = int(raw_val)
                    if qty <= 0: continue
                except (ValueError, TypeError):
                    continue

                # Validate Date
                moved_at = None
                if isinstance(col, (datetime, pd.Timestamp)):
                    moved_at = col
                elif isinstance(col, str):
                    try:
                        clean_col = col.split('.')[0].strip() # Handle duplicates
                        # Use the parsed year from sheet name
                        date_str = f"{clean_col}-{target_year}" 
                        moved_at = datetime.strptime(date_str, "%d-%b-%Y")
                    except ValueError:
                        continue
                
                if moved_at:
                    # Filter: Only keep records belonging to the Target Month/Year found in sheet name
                    if moved_at.month == target_month and moved_at.year == target_year:
                        log_records.append((item_code, qty, 'FG', 'Dispatch', moved_at))

        if not log_records:
            flash("No valid dispatch records found for the detected month.", 'warning')
            return redirect(request.referrer)

        cursor = conn.cursor()

        # 4. REPLACE DATA (Delete existing for this month, then Insert)
        
        delete_sql = """
            DELETE FROM production_log 
            WHERE to_stage = 'Dispatch' 
            AND MONTH(moved_at) = ? 
            AND YEAR(moved_at) = ?
        """
        cursor.execute(delete_sql, target_month, target_year)
        deleted_count = cursor.rowcount

        insert_sql = """
            INSERT INTO production_log (item_code, quantity, from_stage, to_stage, moved_at) 
            VALUES (?, ?, ?, ?, ?)
        """
        cursor.executemany(insert_sql, log_records)
        
        conn.commit()
        flash(f"Successfully uploaded {len(log_records)} records for {calendar.month_name[target_month]} {target_year}. (Replaced {deleted_count} existing records)", 'success')

    except Exception as e:
        if conn: conn.rollback()
        flash(f"Error processing file: {str(e)}", 'error')
        traceback.print_exc()
    finally:
        if conn: conn.close()
        # Ensure file is removed
        if filepath and os.path.exists(filepath): 
            try:
                os.remove(filepath)
            except PermissionError:
                print(f"Warning: Could not remove {filepath} - File still locked.")

    return redirect(request.referrer)

======================================================================
== FILE: templates\layout.html
======================================================================

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Production Dashboard{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="banner-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="banner banner-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <nav class="top-nav">
        <div class="nav-left">
            <button id="sidebar-toggle" class="menu-btn" title="Toggle Menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close-icon">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="nav-header">
                <img src="{{ url_for('static', filename='images/ELGI.png') }}" alt="ELGI Logo" class="logo-img">
            </div>
        </div>

        <div class="nav-actions">
            {% if request.endpoint == 'dashboard' %}
                <div class="navbar-filter-group" style="display: flex; align-items: center; margin-right: 20px; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 20px;">
                    <label for="navbar-type-filter" style="color: #94a3b8; font-size: 0.8rem; font-weight: 600; margin-right: 10px; text-transform: uppercase;">Type</label>
                    <select id="navbar-type-filter" style="background-color: #1e293b; color: #f8fafc; border: 1px solid #334155; border-radius: 4px; padding: 4px 8px; font-size: 0.85rem; outline: none; cursor: pointer;">
                        <option value="">All</option>
                        <option value="Lean">Lean</option>
                        <option value="Non Lean">Non Lean</option>
                    </select>
                </div>
            {% endif %}

            <div class="profile-dropdown">
                <div class="profile-menu">
                    <div class="profile-avatar">
                        {{ current_user.username[0]|upper if current_user.is_authenticated else 'G' }}
                    </div>
                    <div class="profile-info">
                        <span class="profile-name">{{ current_user.name if current_user.is_authenticated else 'Guest' }}</span>
                        <span class="profile-role">Manager</span>
                    </div>
                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>

                <div class="dropdown-content">
                    <div class="dropdown-header">
                        <span class="user-email">{{ current_user.username if current_user.is_authenticated else 'Guest' }}</span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="dropdown-item logout-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div id="sidebar" class="sidebar">
        <ul class="sidebar-links">
            <li>
                <a href="{{ url_for('production_planning') }}" class="{% if request.endpoint == 'production_planning' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    Production Planning
                </a>
            </li>
            <li>
                <a href="{{ url_for('wip_tracking') }}" class="{% if request.endpoint == 'wip_tracking' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                    WIP Tracker
                </a>
            </li>
            <li>
                <a href="{{ url_for('dashboard') }}" class="{% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    Dashboard
                </a>
            </li>
            <li>
                <a href="{{ url_for('attendance') }}" class="{% if request.endpoint == 'attendance' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Worker Attendance
                </a>
            </li>
            <li>
                <a href="{{ url_for('manage_items') }}" class="{% if request.endpoint == 'manage_items' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    Item Master
                </a>
            </li>
            <li>
                <a href="{{ url_for('manage_stages') }}" class="{% if request.endpoint == 'manage_stages' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><path d="M13 6h3a2 2 0 0 1 2 2v7"></path><line x1="6" y1="9" x2="6" y2="21"></line></svg>
                    Stage Flow
                </a>
            </li>
            <hr style="border: 0; border-top: 1px solid #374151; margin: 10px 20px;">

            <li>
                <a href="#" id="sidebar-settings-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Settings & Data
                </a>
            </li>

        </ul>
    </div>

    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <div id="settings-modal" class="modal">
        <div class="modal-content settings-modal-content">
            <div class="modal-header settings-header">
                <div class="header-text">
                    <h2>System Data & Settings</h2>
                    <p>Manage daily uploads and system configurations</p>
                </div>
                <span class="close-button">&times;</span>
            </div>

            <div class="modal-body settings-body">
                
                <div class="settings-grid">

                    <div class="settings-card">
                        <div class="card-header">
                            <div class="card-icon" style="background: #e0f2fe; color: #0284c7;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            </div>
                            <div class="card-title">
                                <h3>Pending Triggers</h3>
                                <span class="card-subtitle">Daily Plan Generation</span>
                            </div>
                            
                            {% if last_triggers_upload_time %}
                                <div class="status-badge success"><span class="dot"></span> Active</div>
                            {% else %}
                                <div class="status-badge warning"><span class="dot"></span> Missing</div>
                            {% endif %}
                        </div>

                        <div class="card-content">
                            {% if last_triggers_upload_time %}
                                <div class="upload-info success">
                                    <div class="info-text">
                                        <strong>File Uploaded</strong>
                                        <span>{{ last_triggers_upload_time.strftime('%d %b, %I:%M %p') }}</span>
                                    </div>
                                    <form action="{{ url_for('delete_triggers') }}" method="POST" onsubmit="return confirm('Remove triggers?');">
                                        <button type="submit" class="button button-small button-danger button-ghost">Remove</button>
                                    </form>
                                </div>
                            {% else %}
                                <div class="upload-info warning"><p>Upload daily CSV to generate today's plan.</p></div>
                            {% endif %}

                            <form action="{{ url_for('upload_triggers') }}" method="POST" enctype="multipart/form-data" class="modern-upload-form">
                                <div class="file-input-wrapper">
                                    <input type="file" name="file" id="trigger-file" accept=".csv" required onchange="updateFileName(this)">
                                    <label for="trigger-file" class="file-label">
                                        <span class="file-cta">Choose CSV</span>
                                        <span class="file-name">No file selected</span>
                                    </label>
                                </div>
                                <button type="submit" class="button button-primary upload-btn">Upload</button>
                            </form>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="card-header">
                            <div class="card-icon" style="background: #dcfce7; color: #166534;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                            </div>
                            <div class="card-title">
                                <h3>Dispatch Log</h3>
                                <span class="card-subtitle">Monthly Excel Upload</span>
                            </div>
                        </div>

                        <div class="card-content">
                            <div class="upload-info" style="background-color: #f8fafc; border: 1px solid #e2e8f0; color: #64748b;">
                                <p style="margin:0;">Updates your dispatch details in the database</p>
                            </div>

                            <form action="{{ url_for('upload_dispatch') }}" method="POST" enctype="multipart/form-data" class="modern-upload-form">
                                <div class="file-input-wrapper">
                                    <input type="file" name="file" id="dispatch-file" accept=".xlsx, .xls" required onchange="updateFileName(this)">
                                    <label for="dispatch-file" class="file-label">
                                        <span class="file-cta">Choose Excel</span>
                                        <span class="file-name">No file selected</span>
                                    </label>
                                </div>
                                <button type="submit" class="button button-primary upload-btn">Upload</button>
                            </form>
                        </div>
                    </div>

                </div> </div>
        </div>
    </div>
    {% block scripts %}
    <script src="{{ url_for('static', filename='js/layout.js') }}?v=3"></script>
    {% endblock %}

</body>
</html>

======================================================================
== FILE: templates\productionpl.html
======================================================================

{% extends "layout.html" %}

{% block title %}Production Planning{% endblock %}
{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/productionpl.css') }}">

    {% set active_view = request.args.get('view', 'production') %}
    {% set has_plan = plans|length > 0 %}

    <div class="page-container">
        <div class="content-card">
            
            {# --- Unified Command Bar --- #}
            <div class="filter-toolbar">
                <div class="toolbar-section" style="display:flex; align-items:center; gap:20px;">
                    <h1 class="toolbar-title">
                        {% if request.args.get('view') == 'overdue' %}Overdue Triggers{% else %}Production Plan{% endif %}
                    </h1>

                    {# View Toggle #}
                    <div class="view-toggle">
                        <a href="{{ url_for('production_planning', view='production') }}" class="toggle-btn {% if request.args.get('view', 'production') == 'production' %}active{% endif %}">Plan</a>
                        <a href="{{ url_for('production_planning', view='overdue') }}" class="toggle-btn {% if request.args.get('view') == 'overdue' %}active{% endif %}">Overdue</a>
                    </div>
                </div>

                {# --- FILTERS FOR PRODUCTION PLAN --- #}
                {% if request.args.get('view', 'production') == 'production' and plan_generated_today %}
                <form action="{{ url_for('production_planning') }}" method="GET" class="toolbar-actions" style="display:flex; gap:10px; align-items:center;">
                    <input type="hidden" name="view" value="production">
                    
                    {# Rows per Page #}
                    <div class="rows-wrapper">
                        <input type="number" name="per_page" value="{{ current_per_page }}" min="1" max="1000" onchange="this.form.submit()" class="rows-input">
                        <span class="rows-label">Rows</span>
                    </div>

                    {# Server-Side Search + Client-Side Real-Time Filter #}
                    <input type="text" id="filter-search" name="search" value="{{ filter_search }}" placeholder="Search Item..." class="filter-input" oninput="filterTable()" autocomplete="off">

                    {# Vertical Dropdown #}
                    <select id="filter-vertical" name="vertical" onchange="this.form.submit()" class="filter-select">
                        <option value="">Vertical: All</option>
                        {% for v in all_verticals %}
                            <option value="{{ v }}" {% if filter_vertical == v %}selected{% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>

                    {# Category Dropdown #}
                    <select id="filter-category" name="category" onchange="this.form.submit()" class="filter-select">
                        <option value="">Category: All</option>
                        {% for c in all_categories %}
                            <option value="{{ c }}" {% if filter_category == c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                    
                    <button type="submit" style="display:none;">Search</button> {# Hidden submit for Enter key #}
                    <a href="{{ url_for('production_planning', view='production') }}" class="button button-text" style="height:30px; padding: 0 10px; line-height:30px;">Reset</a>
                </form>
                
                <div class="toolbar-actions">
                    <form action="{{ url_for('generate_plan') }}" method="POST">
                        <button type="submit" class="button button-primary">Generate</button>
                    </form>
                    <form action="{{ url_for('release_plan') }}" method="POST" onsubmit="return confirm('Release plan to Master?');">
                        <button type="submit" class="button button-success">Release</button>
                    </form>
                </div>

                {% elif request.args.get('view', 'production') == 'production' %}
                    {# Empty State Actions #}
                    <form action="{{ url_for('generate_plan') }}" method="POST">
                        <button type="submit" class="button button-primary">Generate Plan</button>
                    </form>

                {% elif request.args.get('view') == 'overdue' %}
                {# --- FILTERS FOR OVERDUE --- #}
                <div class="toolbar-actions">
                    <form method="GET" action="{{ url_for('production_planning') }}" style="display:flex; gap:8px;">
                        <input type="hidden" name="view" value="overdue">
                        <select name="trigger_type" class="filter-select">
                            <option value="All">Type: All</option>
                            {% for type in trigger_type_list %}
                                <option value="{{ type }}" {% if type == selected_trigger_type %}selected{% endif %}>{{ type }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" name="item_code" placeholder="Item Code..." value="{{ selected_item_code }}" class="filter-input">
                        <button type="submit" class="button button-secondary">Apply</button>
                    </form>
                </div>
                {% endif %}
            </div>

            {# --- Table Content --- #}
            <div class="table-wrapper">
                
                {# View: Production Plan #}
                <div id="production-plan-view" {% if active_view != 'production' %}style="display: none;"{% endif %}>
                    {% if not has_plan %}
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <h3>Ready to Plan</h3>
                            <p>Generate a plan to see items here.</p>
                        </div>
                    {% else %}
                    <form id="update-plan-form">
                        <table id="production-plan-table" class="modern-table">
                            <thead>
                                <tr>
                                    <th class="col-center" style="width: 40px;">#</th>
                                    <th style="width: 110px;">Item Code</th>
                                    <th>Description</th>
                                    <th class="col-center">Vertical</th>
                                    <th class="col-center">Cat</th>
                                    <th class="col-center">RPL</th>
                                    <th class="col-center">WIP</th>
                                    <th class="col-center">Pending</th>
                                    <th class="col-center bg-highlight">Suggested</th>
                                    <th class="col-center" style="width: 80px;">Modified</th>
                                </tr>
                            </thead>
                            <tbody id="plan-tbody">
                                {% for plan in plans %}
                                <tr class="plan-row group"
                                    data-code="{{ plan['Item code']|lower }}"
                                    data-desc="{{ plan['Description']|lower }}"
                                    data-vertical="{{ plan['Vertical'] }}"
                                    data-category="{{ plan['Category'] }}"
                                    data-type="{{ plan['Type'] }}">

                                    <td class="col-center" style="color: #94a3b8;">{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                                    
                                    <td class="col-code">{{ plan['Item code'] }}</td>
                                    
                                    <td class="col-desc" title="{{ plan['Description'] }}">
                                        {{ plan['Description'] }}
                                        <span style="display:block; font-size: 0.7rem; color: #94a3b8;">{{ plan['Type'] }}</span>
                                    </td>
                                    
                                    <td class="col-center"><span class="badge badge-blue">{{ plan['Vertical'] }}</span></td>
                                    <td class="col-center"><span class="badge badge-gray">{{ plan['Category'] }}</span></td>
                                    <td class="col-center" style="font-family: monospace;">{{ plan['RPL days to Delivery']|int }}</td>
                                    
                                    <td class="col-center" style="color: #0369a1;font-weight:bold">
                                        {{ plan['WIP']|int }}
                                    </td>

                                    <td class="col-center">
                                        {% if plan['Pending'] > 0 %}
                                            <span class="text-pending">{{ plan['Pending']|int }}</span>
                                        {% else %}
                                            <span class="text-good">-</span>
                                        {% endif %}
                                    </td>

                                    <td class="col-center bg-highlight">
                                        {{ plan['Daily Suggested Release Plan'] }}
                                    </td>
                                    
                                    <td class="col-center">
                                        <input type="number" name="modified_plan_{{ plan['Item code'] }}" 
                                            value="{{ plan['Modified Release plan'] }}" 
                                            class="plan-input"
                                            onfocus="this.select()">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </form>

                        <div id="no-results-msg" style="display:none; text-align:center; padding: 40px; color: #64748b;">No items match.</div>
                        
                        {# --- Pagination --- #}
                        {% if pagination and pagination.total_pages > 1 %}
                        <div class="pagination-container">
                            <ul class="pagination">
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('production_planning', page=pagination.prev_num, view='production', per_page=pagination.per_page, search=filter_search, vertical=filter_vertical, category=filter_category) }}">&laquo; Prev</a>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link" style="border: none;">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
                                </li>
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('production_planning', page=pagination.next_num, view='production', per_page=pagination.per_page, search=filter_search, vertical=filter_vertical, category=filter_category) }}">Next &raquo;</a>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>

                {# View: Overdue #}
                <div id="overdue-triggers-view" {% if active_view != 'overdue' %}style="display: none;"{% endif %}>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Trigger Date</th>
                                <th>Due Date</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in overdue_items %}
                            <tr>
                                <td class="col-code">{{ item['Item code'] }}</td>
                                <td class="col-desc">{{ item['ITEM DESCRIPTION'] }}</td>
                                <td class="text-pending">{{ item['Qty'] }}</td>
                                <td>{{ item['TRIGGER DT'] }}</td>
                                <td>{{ item['DUE DT'] }}</td>
                                <td><span class="badge badge-warning">{{ item['TRIGGER TYPE'] }}</span></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" style="text-align:center; padding:40px; color:#94a3b8;">No overdue items.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.productionConfig = {
        urls: { updateSinglePlan: "{{ url_for('update_single_plan') }}" }
    };
</script>
<script src="{{ url_for('static', filename='js/productionpl.js') }}"></script>
{% endblock %}

======================================================================
== FILE: templates\wip.html
======================================================================

{% extends "layout.html" %}

{% block title %}WIP Tracker{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wip.css') }}">

<div class="page-container">
    
    <div class="content-card">
        {# --- Unified Header & Toolbar --- #}
        <div class="filter-toolbar">
            <h1 class="toolbar-title">WIP Tracker</h1>

            <form action="{{ url_for('wip_tracking') }}" method="GET" class="toolbar-actions">
                
                <input type="search" name="search" placeholder="Search..." value="{{ search_query }}" class="filter-input">

                <select name="type" onchange="this.form.submit()" class="filter-select">
                    <option value="">Type: All</option>
                    {% for t in type_options %}
                        <option value="{{ t }}" {% if selected_type == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                </select>

                <select name="category" onchange="this.form.submit()" class="filter-select">
                    <option value="">Category: All</option>
                    {% for c in category_options %}
                        <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>

                {# --- Typeable Rows Per Page --- #}
                <div style="display: flex; align-items: center; border: 1px solid var(--border-light); border-radius: 6px; background: var(--bg-subtle); padding-right: 10px; height: 32px; transition: border-color 0.2s;">
                    <input type="number" 
                           name="per_page" 
                           value="{{ current_per_page }}" 
                           min="1" 
                           max="1000" 
                           onchange="this.form.submit()" 
                           style="border: none; background: transparent; width: 50px; padding-left: 10px; text-align: center; height: 100%; outline: none; font-size: 0.8rem; color: var(--text-main); font-weight: 600;"
                           title="Type number of rows and press Enter"
                    >
                    <span style="font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; border-left: 1px solid var(--border-light); padding-left: 8px; margin-left: 0px; line-height: 1;">Rows</span>
                </div>

                {% if search_query or selected_type or selected_category or current_per_page != 20 %}
                    <a href="{{ url_for('wip_tracking') }}" class="button button-secondary">Reset</a>
                {% else %}
                    <button type="submit" class="button button-secondary">Search</button>
                {% endif %}
            </form>
        </div>

        {# --- Table --- #}
        <div class="table-wrapper">
            <table id="wip-table" class="modern-table">
                <thead>
                    <tr>
                        <th class="col-center" style="width: 50px;">#</th>
                        <th class="col-left" style="width: 120px;">Item Code</th>
                        <th class="col-left">Description</th>
                        <th class="col-center bg-highlight">Total Inv</th>
                        {% for stage in stages %}
                            {# Highlight Header if Not Started #}
                            <th class="col-center {% if stage == 'Not Started' %}bg-not-started-header{% endif %}">{{ stage }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in master_items %}
                    <tr data-item-code="{{ item['Item code'] }}">
                        <td class="col-center" style="color: var(--text-muted);">{{ pagination.per_page * (pagination.page - 1) + loop.index }}</td>
                        
                        <td class="col-code">{{ item['Item code'] }}</td>
                        <td class="col-desc" title="{{ item['Description'] }}">{{ item['Description'] }}</td>

                        <td class="col-center bg-highlight">
                            {{ item['Total Inv'] }}
                        </td>

                        {% for stage in stages %}
                            {% set quantity = item.get(stage, 0) %}
                            
                            {# Special handling for the Grouped Column #}
                            {% if stage == 'Before Hydro' %}
                                <td class="col-center stage-qty clickable-cell {{ 'quantity-active' if quantity > 0 else 'quantity-zero' }}"
                                    data-stage="Before Hydro"
                                    data-item-code="{{ item['Item code'] }}"
                                    data-quantity="{{ quantity }}"
                                    data-breakdown="{{ item['Before_Hydro_Breakdown'] }}">
                                    {% if quantity > 0 %}{{ quantity }}{% else %}<span style="color: #cbd5e1;">-</span>{% endif %}
                                </td>
                            {% else %}
                                {# Standard Stage Rendering #}
                                <td class="col-center stage-qty {% if stage == 'Not Started' %}bg-not-started-cell{% endif %} {{ 'quantity-active' if quantity > 0 else 'quantity-zero' }} {{ 'clickable-cell' if quantity > 0 }}"
                                    data-stage="{{ stage }}"
                                    data-item-code="{{ item['Item code'] }}"
                                    data-quantity="{{ quantity }}">
                                    {% if quantity > 0 %}{{ quantity }}{% else %}<span style="color: #cbd5e1;">-</span>{% endif %}
                                </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% else %}
                    <tr><td colspan="{{ 4 + stages|length }}" style="text-align: center; padding: 40px; color: var(--text-muted);">No items found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# --- Pagination --- #}
        {% if pagination and pagination.total_pages > 1 %}
        <div class="pagination-container">
            <ul class="pagination">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('wip_tracking', page=pagination.prev_num, search=search_query, type=selected_type, category=selected_category, per_page=pagination.per_page) }}">&laquo; Prev</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link" style="border: none;">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
                </li>
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('wip_tracking', page=pagination.next_num, search=search_query, type=selected_type, category=selected_category, per_page=pagination.per_page) }}">Next &raquo;</a>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

{# --- Enhanced Action Modal --- #}
<div id="action-modal" class="modal">
    <div class="modal-content action-modal-content">
        
        {# --- Header Section --- #}
        <div class="modal-header">
            <h3 id="action-modal-title">Manage Item</h3>
            <span class="close-button">&times;</span>
        </div>
        
        {# --- Context Info Bar --- #}
        <div id="action-modal-subtitle" class="modal-context-bar"></div>

        <div class="modal-body">
            
            {# --- SECTION 1: PRIMARY ACTION (Move / Dispatch) --- #}
            <div class="action-section">
                
                {# Move Form #}
                <form id="move-form">
                    <input type="hidden" id="move-item-code" name="item_code">
                    <input type="hidden" id="source-stage-hidden" name="source_stage">

                    <div class="form-grid" style="display: flex; flex-direction: column; gap: 15px;">
                        
                        {# Row 1: Source & Quantity #}
                        <div style="display: flex; gap: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="modal-label">Move From</label>
                                <input type="text" id="source-stage-display" class="modal-input" readonly style="background-color: #f1f5f9; color: #64748b; font-weight: 600;">
                            </div>
                            <div class="form-group" style="width: 100px;">
                                <label class="modal-label">Quantity</label>
                                <input type="number" id="move-quantity" name="quantity" min="1" required class="modal-input font-bold" style="text-align: center;">
                            </div>
                        </div>

                        {# Row 2: Destination #}
                        <div class="form-group">
                            <label class="modal-label">Destination (Move To)</label>
                            <div class="select-wrapper">
                                <select id="dest-stage" name="dest_stage" required class="modal-input" style="border-color: #3b82f6; background-color: #eff6ff;">
                                    </select>
                            </div>
                        </div>

                    </div>

                    <button type="submit" class="button btn-action-primary" style="margin-top: 20px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        Confirm Move
                    </button>
                </form>

                {# Dispatch Form #}
                <form id="dispatch-form" action="{{ url_for('dispatch_item') }}" method="POST" style="display:none;">
                    <input type="hidden" id="dispatch-item-code" name="item_code">
                    
                    <div class="form-group">
                        <label class="modal-label">Quantity to Dispatch</label>
                        <input type="number" id="dispatch-quantity" name="quantity" min="1" required class="modal-input font-bold">
                    </div>
                    <button type="submit" class="button btn-action-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Confirm Dispatch
                    </button>
                </form>
            </div>

            {# --- SECTION 2: SECONDARY ACTION (Report Issue) --- #}
            <div class="issue-section">
                <div class="issue-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Report Issue / Scrap
                </div>
                <form id="flag-form">
                    <input type="hidden" id="flag-item-code" name="item_code">
                    <input type="hidden" id="flag-stage" name="stage">

                    <div class="form-grid" style="display: flex; gap: 10px;">
                        <div class="form-group" style="width: 80px;">
                            <label class="modal-label">Qty</label>
                            <input type="number" id="flag-quantity" name="quantity" min="1" required class="modal-input">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="modal-label">Reason</label>
                            <input type="text" id="flag-remark" name="remark" required class="modal-input" placeholder="e.g. Damaged, Rework">
                        </div>
                    </div>
                    <button type="submit" class="button btn-action-warning" style="margin-top: 10px;">Log Issue</button>
                </form>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.wipConfig = {
        stages: {{ stages|tojson }},
        groupStages: {{ group_stages|tojson }},
        urls: {
            moveItem: "{{ url_for('move_item') }}",
            flagItem: "{{ url_for('flag_item') }}",
            dispatchItem: "{{ url_for('dispatch_item') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/wip.js') }}"></script>
{% endblock %}

======================================================================
== FILE: templates\attendance.html
======================================================================

{% extends "layout.html" %}

{% block title %}Worker Attendance{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/attendance.css') }}">

<div class="page-container">
    <div class="content-card">
        
        {# --- Header --- #}
        <div class="attendance-header">
            <h1 id="page-title">Worker Attendance</h1>
            <div class="header-actions">
                <button id="toggle-view-btn" class="button button-secondary">
                    {# Users Icon #}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    {# Text Span #}
                    <span id="toggle-btn-text">Manage Employees</span>
                </button>
                <a href="{{ url_for('export_attendance') }}" class="button button-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span>Export</span>
                </a>
            </div>
        </div>

        {# --- VIEW 1: TRACKER --- #}
        <div id="attendance-view" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            
            {# Toolbar #}
            <div class="controls-toolbar">
                
                {# Left: Week Navigation #}
                <div class="week-nav">
                    <a href="{{ url_for('attendance', start_date=prev_week_start, stage=selected_stage) }}" class="nav-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </a>
                    <div class="week-display">{{ current_week_str }}</div>
                    <a href="{{ url_for('attendance', start_date=next_week_start, stage=selected_stage) }}" class="nav-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </a>
                </div>

                {# Right: Filters & Actions #}
                <div class="controls-right">
                    
                    {# Filter Stage #}
                    <div class="control-item">
                        <span class="control-label">Filter</span>
                        <form method="GET" action="{{ url_for('attendance') }}" style="margin:0;">
                            <select name="stage" class="compact-select" onchange="this.form.submit()">
                                <option value="All" {% if selected_stage == 'All' %}selected{% endif %}>All Stages</option>
                                {% for stage in stage_filter_list %}
                                    <option value="{{ stage }}" {% if selected_stage == stage %}selected{% endif %}>{{ stage }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    {# Mark Holiday #}
                    <form action="{{ url_for('add_holiday') }}" method="POST" style="margin:0;">
                        <input type="hidden" name="start_date" value="{{ week_days[0].strftime('%Y-%m-%d') }}">
                        <div class="control-item" style="padding-right: 4px;">
                            <span class="control-label">Holiday</span>
                            <input type="date" name="holiday_date" required class="compact-date">
                            <button type="submit" class="icon-btn" title="Add Holiday">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </form>

                </div>
            </div>

            {# Grid #}
            <div class="grid-container">
                <form id="attendance-form">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Employee Name</th>
                                <th style="width: 150px; padding-left: 10px;">Default Stage</th>
                                {% for day in week_days %}
                                    {% set day_type = holidays.get(day) %}
                                    <th class="{% if day_type == 'Holiday' %}holiday{% elif day_type == 'Working Day' %}working-day-override{% elif is_weekend %}weekend{% endif %}">
                                        <div class="date-header-content">
                                            <span class="dh-day">{{ day.strftime('%a') }}</span>
                                            <span class="dh-date">{{ day.day }}</span>
                                        </div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr>
                                <td>
                                    <span class="emp-name">{{ employee['Title'] }} {{ employee['Name of the Employee'] }}</span>
                                    <span class="emp-id">{{ employee['E.code'] }}</span>
                                </td>

                                {% set default_stage = employee['Stage'] %}
                                {% set roster_info = roster_dict.get(employee['E.code'], {}).get(today) %}
                                {% set assigned_stage = roster_info.get('assigned_stage') if roster_info else default_stage %}
                                <td class="stage-cell">{{ assigned_stage }}</td>

                                {% for day in week_days %}
                                    {% set status = attendance_data.get(employee['E.code'], {}).get(day) %}
                                    {% set day_type = holidays.get(day) %}
                                    {% set is_workday = (day_type == 'Working Day') or (day.weekday() < 5 and day_type != 'Holiday') %}

                                    <td class="{% if not is_workday %}{% if day_type == 'Holiday' %}holiday{% else %}weekend{% endif %}{% endif %}">
                                        {% if is_workday %}
                                            <select name="status-{{ employee['E.code'] }}-{{ day.strftime('%Y-%m-%d') }}" 
                                                    class="status-select {% if status and 'Present' in status %}present{% elif status == 'Absent' %}absent{% endif %}">
                                                <option value="" {% if not status %}selected{% endif %}>-</option>
                                                <option value="Present-1" {% if status == 'Present-1' %}selected{% endif %}>P (S1)</option>
                                                <option value="Present-2" {% if status == 'Present-2' %}selected{% endif %}>P (S2)</option>
                                                <option value="Absent" {% if status == 'Absent' %}selected{% endif %}>Abs</option>
                                            </select>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% else %}
                            <tr><td colspan="{{ 2 + 7 }}" style="padding: 40px; color: #94a3b8; text-align: center;">No employees found for this stage.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form>
            </div>
        </div>

        {# --- VIEW 2: MANAGE --- #}
        <div id="manage-view" style="display: none;">
            <div class="manage-container">
                <div class="manage-toolbar">
                    <h2 style="font-size: 1.1rem; margin: 0; color: var(--text-main); font-weight: 700;">Employee Directory</h2>
                    <button id="show-add-modal-btn" class="button button-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add New Employee
                    </button>
                </div>

                <div style="border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden;">
                    <table id="manage-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">E.code</th>
                                <th>Full Name</th>
                                <th>Company / Contract</th>
                                <th>Date of Joining</th>
                                <th>Default Stage</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in manage_employees %}
                            <tr>
                                <td style="font-family: monospace; font-weight: 600; color: #334155;">{{ employee['E.code'] }}</td>
                                <td style="font-weight: 600;">{{ employee['Title'] }} {{ employee['Name of the Employee'] }}</td>
                                <td>{{ employee['Company / Contract'] }}</td>
                                <td>{{ employee['DOJ'].strftime('%d-%b-%Y') if employee['DOJ'] else 'N/A' }}</td>
                                <td><span class="stage-badge">{{ employee['Stage'] }}</span></td>
                                
                                <td style="text-align: right;">
                                    <div class="action-btn-group" style="justify-content: flex-end; display: flex; gap: 8px;">
                                        <button class="button button-small button-secondary"
                                            onclick="populateEditModal(this)"
                                            data-ecode="{{ employee['E.code'] }}"
                                            data-title="{{ employee['Title'] or '' }}"
                                            data-name="{{ employee['Name of the Employee'] }}"
                                            data-company="{{ employee['Company / Contract'] }}"
                                            data-doj="{{ employee['DOJ'].strftime('%Y-%m-%d') if employee['DOJ'] else '' }}"
                                            data-stage="{{ employee['Stage'] }}">
                                            Edit
                                        </button>

                                        <form action="{{ url_for('remove_employee') }}" method="POST" onsubmit="return confirm('Remove {{ employee['Name of the Employee'] }}?');">
                                            <input type="hidden" name="e_code" value="{{ employee['E.code'] }}">
                                            <input type="hidden" name="start_date" value="{{ week_days[0].strftime('%Y-%m-%d') }}">
                                            <button type="submit" class="button button-small button-danger"></button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

{# --- Modern Modals --- #}

<div id="add-employee-modal" class="modal">
    <div class="modal-content attendance-modal-content">
        <div class="modal-header settings-header">
            <div class="header-text">
                <h2>New Employee</h2>
                <p>Register a new worker in the system</p>
            </div>
            <span class="close-button">&times;</span>
        </div>
        
        <div class="modal-body settings-body">
            <form id="add-employee-form" action="{{ url_for('add_employee') }}" method="POST">
                <div class="modal-form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Employee Code</label>
                        <input type="text" name="e_code" class="modal-input" required placeholder="e.g. E001">
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Title</label>
                        <div class="select-wrapper">
                            <select name="title" class="modal-input" required>
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Full Name</label>
                        <input type="text" name="name" class="modal-input" required placeholder="John Doe">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Company / Contract</label>
                        <input type="text" name="company" class="modal-input" required placeholder="Company Name">
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Date of Joining</label>
                        <input type="date" name="doj" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Default Stage</label>
                        <div class="select-wrapper">
                            <select name="stage" class="modal-input" required>
                                <option value="" disabled selected>-- Select Stage --</option>
                                {% for stage in stage_filter_list %}
                                    <option value="{{ stage }}">{{ stage }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="button button-primary">Create Employee</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="edit-employee-modal" class="modal">
    <div class="modal-content attendance-modal-content">
        <div class="modal-header settings-header">
            <div class="header-text">
                <h2 id="edit-modal-title">Edit Employee</h2>
                <p>Update worker details</p>
            </div>
            <span class="close-button">&times;</span>
        </div>

        <div class="modal-body settings-body">
            <form id="edit-employee-form" action="{{ url_for('edit_employee') }}" method="POST">
                <input type="hidden" id="edit_original_e_code" name="original_e_code">
                
                <div class="modal-form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Employee Code</label>
                        <input type="text" id="edit_e_code" name="e_code" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Title</label>
                        <div class="select-wrapper">
                            <select id="edit_title" name="title" class="modal-input" required>
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Full Name</label>
                        <input type="text" id="edit_name" name="name" class="modal-input" required>
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Company / Contract</label>
                        <input type="text" id="edit_company" name="company" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Date of Joining</label>
                        <input type="date" id="edit_doj" name="doj" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Default Stage</label>
                        <div class="select-wrapper">
                            <select id="edit_stage" name="stage" class="modal-input" required>
                                {% for stage in stage_filter_list %}
                                    <option value="{{ stage }}">{{ stage }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="button button-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.attendanceConfig = {
        urls: {
            markSingle: "{{ url_for('mark_single_attendance') }}",
            attendanceBase: "{{ url_for('attendance') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/attendance.js') }}"></script>
{% endblock %}

======================================================================
== FILE: templates\dashboard.html
======================================================================

{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    {% if current_view == 'details' %}
    <div id="fullscreen-toggle" title="Toggle Fullscreen">
        <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        <svg id="fullscreen-exit-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
    </div>
    <div class="details-view-wrapper">
        <div>
            <div class="details-header">
                <h2>Details for {{ filter_type|title }}: {{ filter_value }}</h2>
                <a href="{{ url_for('dashboard') }}" class="button">Back to Overview</a>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>S.No</th><th>Item code</th><th>Type</th><th>Category</th><th>Model</th>
                            <th>Opening Trigger</th><th>PDI</th><th>Powder coating</th>
                            <th>Hydro Testing</th><th>Dispatched</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in details_data %}
                        <tr>
                            <td>{{ item['S.No.'] }}</td><td class="align-left">{{ item['Item code '] }}</td><td>{{ item['Type'] }}</td>
                            <td>{{ item['Category'] }}</td><td>{{ item['Model'] }}</td><td>{{ item['Opening Trigger']|int }}</td>
                             <td>{{ item['PDI']|int }}</td><td>{{ item['Powder coating']|int }}</td>
                            <td>{{ item['Hydro Testing']|int }}</td><td>{{ item['Dispatched']|int }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="10" class="placeholder">No detailed data found for this filter.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

{% else %}
    <div class="dashboard-section">
        <div class="stage-cards-container">
            <div class="stage-card" data-stage="Total-Inv">
                <div class="count">0</div> <div class="stage-name">Total WIP Inv</div>
            </div>

{% for stage in stages %}
            <div class="stage-card drop-target" data-stage="{{ stage }}">
                <div class="count">{{ stage_totals.get(stage, 0)|int }}</div>
                <div class="stage-name">{{ stage }}</div>
            </div>
{% endfor %}

            <div class="stage-card monthly-dispatch-card" data-stage="MonthlyDispatch">
                <div class="count">{{ total_monthly_dispatch|int }}</div>
                <div class="stage-name">Monthly Dispatch</div>
            </div>
            
            {# --- Daily Adherence Card --- #}
            {% set daily_percent = daily_adherence|float %}
            {% if daily_percent > 100 %}{% set daily_percent = 100 %}{% endif %}
            {% if daily_percent < 0 %}{% set daily_percent = 0 %}{% endif %}
            {% set daily_hue = (daily_percent * 1.2)|int %}
            {% set daily_saturation = '80%' %}
            {% set daily_lightness = '85%' %}
            {% set daily_card_style = 'background-color: hsl(%d, %s, %s); color: #333;'|format(daily_hue, daily_saturation, daily_lightness) %}

            <div class="stage-card" data-metric="daily-adherence" style="{{ daily_card_style }}">
                <div class="count">{{ daily_adherence|round(1) }}%</div>
                <div class="stage-name">Daily Adherence</div>
            </div>
            {% set m_percent = monthly_trigger_adherence|float %}
            {% if m_percent > 100 %}{% set m_percent = 100 %}{% endif %}
            {% if m_percent < 0 %}{% set m_percent = 0 %}{% endif %}

            {# Calculate Color: 0% = Red(0), 100% = Green(120) #}
            {% set m_hue = (m_percent * 1.2)|int %}
            {% set m_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(m_hue) %}
            <div class="stage-card" data-metric="monthly-trigger-adherence" style="background-color: #f3e8ff; color: #333;">
                <div class="count">{{ monthly_trigger_adherence|round(1) }}%</div>
                <div class="stage-name">Monthly Trigger Adherence</div>
            </div>
            
        </div>
    </div>

    <div class="dashboard-tables-container">
        <div class="table-wrapper">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th colspan="11" class="table-title">Daily Production Plan</th></tr>
                        <tr>
                            <th>S.No.</th>
                            <th>Item code</th>
                            <th class="description-col">Description</th>
                            <th>Opening Due Trigger</th>
                            <th style="background-color: #f1f5f9; color: #64748b;">Next Pending</th> <th>Pending</th>

                            <th>Dispatch</th>
                            <th>FG</th>
                            <th>PC</th>
                            <th>Hydro</th>

                            <th id="failure-header-toggle" title="Click to Show/Hide Failure Buttons">Failure </th>
                        </tr>
                    </thead>
                    <tbody id="plan-table-body">
                        {% for plan in top_plans %}
                        {% set percent = plan.ItemAdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row draggable-item" draggable="true"
                            data-item-code="{{ plan['Item code '] }}"
                            data-filter-type="item_code"
                            data-filter-value="{{ plan['Item code '] }}">

                            <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                            <td class="align-left">{{ plan['Item code '] }}</td>
                            <td class="align-left description-col">{{ plan['Description'] }}</td>

                            <td style="{{ cell_style }}">{{ plan['Opening Trigger']|int }}</td>
                            <td style="color: #64748b;">{{ plan['Next Pending']|int }}</td> <td style="font-weight: bold; color: #d95319;">{{ plan['Pending']|int }}</td>

                            <td>{{ plan['Dispatch']|int }}</td>
                            <td>{{ plan['FG']|int }}</td>
                            <td>{{ plan['Powder coating']|int }}</td>
                            <td>{{ plan['Hydro Testing']|int }}</td>

                            <td class="reason-cell">
                                {% set failure_qty = plan.FailureInTrigger|int %}
                                {% if failure_qty > 0 and (show_failure_button == True) %}
                                    <button class="button reason-btn {% if plan.SavedReason %}has-reason{% endif %}"
                                            data-item-code="{{ plan['Item code '] }}"
                                            data-failed-qty="{{ failure_qty }}"
                                            data-saved-reason="{{ plan.SavedReason or '' }}"
                                            title="{{ plan.SavedReason or 'Log Reason' }}">
                                            {{ failure_qty }} Fail
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="11" class="placeholder">No plan data available.</td></tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

            {% if pagination and pagination.total > pagination.per_page %}
            <div class="pagination-container" id="plan-pagination" style="padding-top: 0px; padding-bottom: 5px;">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="#" data-page="{{ pagination.prev_num }}">&laquo;</a>
                        </li>
                        {% for page_num in range(1, pagination.total_pages + 1) %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                            </li>
                        {% endfor %}
                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                            <a class="page-link" href="#" data-page="{{ pagination.next_num }}">&raquo;</a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>

        <div class="table-wrapper overview-tables-wrapper">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th colspan="5" class="table-title">Vertical Wise Overview</th></tr>
                        <tr><th>Vertical</th><th>Opening Trigger</th><th>Pending</th><th>Dispatch</th><th>Action</th></tr>
                    </thead>
                    <tbody id="vertical-table-body">
                        {% for item in vertical_overview %}
                        {% set percent = item.AdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row" data-filter-type="vertical" data-filter-value="{{ item['Vertical'] }}">
                            <td class="align-left">{{ item['Vertical'] }}</td>
                            <td style="{{ cell_style }}">{{ item['Opening Trigger']|int }}</td>
                            <td style="font-weight: bold;">{{ item['Pending']|int }}</td>
                            <td>{{ item['Dispatch']|int }}</td>
                            <td><a href="{{ url_for('dashboard', view='details', type='vertical', value=item['Vertical']) }}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="placeholder">No data available.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>{{ vertical_overview|sum(attribute='Opening Trigger')|int }}</td>
                            <td>{{ vertical_overview|sum(attribute='Pending')|int }}</td>
                            <td>{{ vertical_overview|sum(attribute='Dispatch')|int }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="table-container" style="margin-top: 15px;">
                <table>
                    <thead>
                        <tr><th colspan="5" class="table-title">Category Wise Overview</th></tr>
                        <tr><th>Category</th><th>Opening Trigger</th><th>Pending</th><th>Dispatch</th><th>Action</th></tr>
                    </thead>
                    <tbody id="category-table-body">
                        {% for item in category_overview %}
                        {% set percent = item.AdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row" data-filter-type="category" data-filter-value="{{ item['Category'] }}">
                            <td class="align-left">{{ item['Category'] }}</td>
                            <td style="{{ cell_style }}">{{ item['Opening Trigger']|int }}</td>
                            <td style="font-weight: bold;">{{ item['Pending']|int }}</td>
                            <td>{{ item['Dispatch']|int }}</td>
                            <td><a href="{{ url_for('dashboard', view='details', type='category', value=item['Category']) }}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="placeholder">No data available.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>{{ category_overview|sum(attribute='Opening Trigger')|int }}</td>
                            <td>{{ category_overview|sum(attribute='Pending')|int }}</td>
                            <td>{{ category_overview|sum(attribute='Dispatch')|int }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
{% endif %}
<div id="failure-reason-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Log Failure Reason</h3>

        <div class="modal-info">
            Item Code: <strong id="reason-modal-item-code"></strong><br>
            Failed Quantity Today: <strong id="reason-modal-failed-qty"></strong>
        </div>

        <form id="failure-reason-form">
             <input type="hidden" id="reason-modal-item-code-hidden" name="item_code">
             <input type="hidden" id="reason-modal-failed-qty-hidden" name="failed_quantity">

            <div>
                <label for="reason-modal-select">Reason:</label>
                <select id="reason-modal-select" name="reason" class="modal-input" required>
                    <option value="">-- Select Reason --</option>
                    {% for reason in failure_reasons %}
                    <option value="{{ reason }}">{{ reason }}</option>
                    {% endfor %}
                 </select>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
                 <button type="button" id="reason-modal-clear-btn" class="button button-secondary" style="margin-right: 10px;">Clear Reason</button>
                 <button type="submit" class="button">Save Reason</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.dashboardConfig = {
        stages: {{ stages|tojson }},
        urls: {
            adherenceFiltered: "{{ url_for('api_adherence_filtered') }}",
            inventoryFiltered: "{{ url_for('api_inventory_filtered') }}",
            stageTotals: "{{ url_for('api_stage_totals') }}",
            adherenceTotals: "{{ url_for('api_adherence_totals') }}",
            planPage: "{{ url_for('api_plan_page') }}",
            verticalOverview: "{{ url_for('api_vertical_overview') }}",
            categoryOverview: "{{ url_for('api_category_overview') }}",
            logFailureReason: "{{ url_for('log_failure_reason') }}",
            dispatchItem: "{{ url_for('dispatch_item') }}",
            moveItem: "{{ url_for('move_item') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v=6"></script>
{% endblock %}

======================================================================
== FILE: templates\items.html
======================================================================

{% extends "layout.html" %}

{% block title %}Manage Items{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/items.css') }}">

<div class="page-container">
    <div class="content-card">
        
        {# --- Command Bar --- #}
        <div class="filter-toolbar">
            <h1 class="toolbar-title">Item Master</h1>

            <div class="toolbar-actions">
                <form action="{{ url_for('manage_items') }}" method="GET" style="display: flex; align-items: center; gap: 8px;">
                    <input type="search" name="search" placeholder="Search code or desc..." value="{{ search_query }}" class="filter-input">
                    
                    {% if search_query %}
                        <a href="{{ url_for('manage_items') }}" class="button button-secondary">Reset</a>
                    {% else %}
                        <button type="submit" class="button button-secondary">Search</button>
                    {% endif %}
                </form>

                <button id="show-add-modal-btn" class="button button-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    New Item
                </button>
            </div>
        </div>

        {# --- Table --- #}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-center" style="width: 50px;">#</th>
                        <th style="width: 120px;">Item Code</th>
                        <th>Description</th>
                        <th class="col-center">Category</th>
                        <th class="col-center">Vertical</th>
                        <th class="col-center">Model</th>
                        <th class="col-right">Avg Monthly</th>
                        <th class="col-center" style="width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr id="row-{{ item['Item code'] }}">
                        <td class="col-center" style="color: var(--text-muted);">{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                        <td class="col-code">{{ item['Item code'] }}</td>
                        <td class="col-desc" title="{{ item['Description'] }}">{{ item['Description'] }}</td>
                        <td class="col-center"><span style="font-size:0.75rem; color:var(--text-secondary);">{{ item['Category'] }}</span></td>
                        <td class="col-center"><span style="font-size:0.75rem; color:var(--text-secondary);">{{ item['Vertical'] }}</span></td>
                        <td class="col-center">{{ item['Model'] }}</td>
                        <td class="col-right">{{ item['MonthlyAvg']|int }}</td>

                        <td class="action-buttons">
                            <button class="button button-small button-secondary"
                                onclick="openEditModal(this)"
                                data-code="{{ item['Item code'] }}"
                                data-desc="{{ item['Description'] }}"
                                data-cat="{{ item['Category'] }}"
                                data-vert="{{ item['Vertical'] }}"
                                data-type="{{ item['Type'] }}"
                                data-model="{{ item['Model'] }}"
                                data-monthly="{{ item['MonthlyAvg'] }}"
                                data-daily="{{ item['Daily Max Plan'] }}"
                                data-maxinv="{{ item['Max Inv'] }}"
                                data-rpl="{{ item['RPL days to Delivery'] }}"
                                title="Edit Details">
                                Edit
                            </button>

                            <button class="button button-small button-blue"
                                onclick="openWipModal(this)"
                                data-code="{{ item['Item code'] }}"
                                data-desc="{{ item['Description'] }}"
                                {% for stage in stages %}
                                    data-stage-{{ stage|replace(' ', '_') }}="{{ item.get(stage, 0) }}"
                                {% endfor %}
                                title="Adjust Stock">
                                Stock
                            </button>

                            <form action="{{ url_for('delete_item') }}" method="POST" onsubmit="return confirm('Delete item {{ item['Item code'] }}? This cannot be undone.');" style="display:inline;">
                                <input type="hidden" name="item_code" value="{{ item['Item code'] }}">
                                <button type="submit" class="button button-small button-danger" title="Delete Item"></button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No items found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# --- Pagination --- #}
        {% if pagination and pagination.total_pages > 1 %}
        <div class="pagination-container">
            <ul class="pagination">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('manage_items', page=pagination.prev_num, search=search_query) }}">&laquo; Prev</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link" style="border: none;">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
                </li>
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('manage_items', page=pagination.next_num, search=search_query) }}">Next &raquo;</a>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

{# --- Modern Modals --- #}

<div id="add-item-modal" class="modal">
    <div class="modal-content items-modal-content">
        <div class="modal-header settings-header">
            <div class="header-text">
                <h2>New Item</h2>
                <p>Register a new SKU in the master list</p>
            </div>
            <span class="close-button">&times;</span>
        </div>

        <div class="modal-body settings-body">
            <form action="{{ url_for('add_item') }}" method="POST">
                <div class="modal-form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Item Code (Unique)</label>
                        <input type="text" name="item_code" class="modal-input" required placeholder="e.g. A12345678">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Description</label>
                        <div class="select-wrapper">
                            <select name="description" class="modal-input" required>
                                <option value="" disabled selected>-- Select Description --</option>
                                <option value="AOS Tank">AOS Tank</option>
                                <option value="Air Receiver">Air Receiver</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Vertical</label>
                        <div class="select-wrapper">
                            <select name="vertical" class="modal-input">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="DPSAC">DPSAC</option>
                                <option value="ENCAP">ENCAP</option>
                                <option value="LEPSAC">LEPSAC</option>
                                <option value="RCD">RCD</option>
                                <option value="ROTAIR">ROTAIR</option>
                                <option value="SEPSAC">SEPSAC</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Category</label>
                        <div class="select-wrapper">
                            <select name="category" class="modal-input">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="Stranger">Stranger</option>
                                <option value="Runner">Runner</option>
                                <option value="Milk Run">Milk Run</option>
                                <option value="Repeater">Repeater</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Type</label>
                        <div class="select-wrapper">
                            <select name="type" class="modal-input">
                                <option value="" disabled selected>-- Select --</option>
                                <option value="Lean">Lean</option>
                                <option value="Non Lean">Non Lean</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Model</label>
                        <input type="text" name="model" class="modal-input">
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Monthly Avg</label>
                        <input type="number" step="0.01" name="monthly_avg" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label class="modal-label">Daily Max Plan</label>
                        <input type="number" name="daily_max" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label class="modal-label">Max Inventory</label>
                        <input type="number" name="max_inv" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label class="modal-label">RPL Days</label>
                        <input type="number" name="rpl_days" class="modal-input">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="button button-primary">Create Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="edit-item-modal" class="modal">
    <div class="modal-content items-modal-content">
        <div class="modal-header settings-header">
            <div class="header-text">
                <h2>Edit Item</h2>
                <p>Update item properties</p>
            </div>
            <span class="close-button">&times;</span>
        </div>

        <div class="modal-body settings-body">
            <form action="{{ url_for('edit_item') }}" method="POST">
                <input type="hidden" id="edit_original_code" name="original_item_code">

                <div class="modal-form-grid">
                    <div class="form-group">
                        <label class="modal-label">Item Code</label>
                        <input type="text" id="edit_code" name="item_code" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Description</label>
                        <div class="select-wrapper">
                            <select id="edit_desc" name="description" class="modal-input" required>
                                <option value="AOS Tank">AOS Tank</option>
                                <option value="Air Receiver">Air Receiver</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Vertical</label>
                        <div class="select-wrapper">
                            <select id="edit_vert" name="vertical" class="modal-input">
                                <option value="DPSAC">DPSAC</option>
                                <option value="ENCAP">ENCAP</option>
                                <option value="LEPSAC">LEPSAC</option>
                                <option value="RCD">RCD</option>
                                <option value="ROTAIR">ROTAIR</option>
                                <option value="SEPSAC">SEPSAC</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Category</label>
                        <div class="select-wrapper">
                            <select id="edit_cat" name="category" class="modal-input">
                                <option value="Stranger">Stranger</option>
                                <option value="Runner">Runner</option>
                                <option value="Milk Run">Milk Run</option>
                                <option value="Repeater">Repeater</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Type</label>
                        <div class="select-wrapper">
                            <select id="edit_type" name="type" class="modal-input">
                                <option value="Lean">Lean</option>
                                <option value="Non Lean">Non Lean</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Model</label>
                        <input type="text" id="edit_model" name="model" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label class="modal-label">Monthly Avg</label>
                        <input type="number" step="0.01" id="edit_monthly" name="monthly_avg" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label class="modal-label">Daily Max Plan</label>
                        <input type="number" id="edit_daily" name="daily_max" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label class="modal-label">Max Inventory</label>
                        <input type="number" id="edit_maxinv" name="max_inv" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label class="modal-label">RPL Days</label>
                        <input type="number" id="edit_rpl" name="rpl_days" class="modal-input">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="button button-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="wip-modal" class="modal">
    <div class="modal-content items-modal-content">
        <div class="modal-header settings-header">
            <div class="header-text">
                <h2>Opening Stock</h2>
                <p id="wip-modal-subtitle">Update stage quantities</p>
            </div>
            <span class="close-button">&times;</span>
        </div>

        <div class="modal-body settings-body">
            <form action="{{ url_for('edit_item') }}" method="POST">
                <input type="hidden" id="wip_original_code" name="original_item_code">

                <div class="wip-grid-wrapper">
                    <div class="modal-form-grid">
                        {% for stage in stages %}
                        <div class="form-group">
                            <label class="modal-label">{{ stage }}</label>
                            <input type="number"
                                   id="stage_input_{{ stage|replace(' ', '_') }}"
                                   name="{{ stage }}"
                                   class="modal-input font-bold"
                                   {% if stage == 'Not Started' %}
                                       readonly
                                       style="background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed;"
                                   {% endif %}
                            >
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="button button-primary">Update Quantities</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.itemsConfig = {
        stages: {{ stages | tojson | default('[]') }}
    };
</script>
<script src="{{ url_for('static', filename='js/items.js') }}"></script>
{% endblock %}

======================================================================
== FILE: templates\stages.html
======================================================================

{% extends "layout.html" %}

{% block title %}Manage Stages{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stages.css') }}">

<div class="page-container">
    <div class="content-card">
        
        {# --- Command Bar --- #}
        <div class="filter-toolbar">
            <div class="toolbar-section">
                <h1 class="toolbar-title">Manufacturing Stages</h1>
                <span class="toolbar-subtitle">Drag and drop rows to reorder process flow</span>
            </div>

            <div class="toolbar-actions">
                <button id="show-add-modal-btn" class="button button-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    New Stage
                </button>
            </div>
        </div>

        {# --- Table --- #}
        <div class="table-container">
            <table id="stages-table" class="modern-table">
                <thead>
                    <tr>
                        <th class="col-center" style="width: 50px;">Order</th>
                        <th class="col-center" style="width: 50px;">Move</th>
                        <th style="width: 250px;">Stage Name</th>
                        <th class="col-center">Dashboard Visibility</th>
                        <th class="col-center" style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="sortable-rows">
                    {% for stage in stages %}
                    {# FIX: Added |trim to handle potential whitespace issues in DB #}
                    {% set is_locked = stage.stage_name|trim in ['Not Started', 'FG'] %}

                    <tr class="{% if not is_locked %}draggable-row{% endif %} {% if is_locked %}locked-row{% endif %}" 
                        data-id="{{ stage.id }}"
                        {% if not is_locked %}draggable="true"{% endif %}
                        style="{% if is_locked %}background-color: #f8fafc;{% endif %}">

                        <td class="sno-cell col-center" style="color: #94a3b8; font-weight: 600;">{{ loop.index }}</td>

                        <td class="drag-handle col-center" style="{% if is_locked %}cursor: not-allowed; opacity: 0.3;{% else %}cursor: grab;{% endif %}">
                            {% if is_locked %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                            {% endif %}
                        </td>

                        <td class="stage-name-cell">
                            <span class="stage-label">{{ stage.stage_name }}</span>
                            {% if is_locked %}
                                <span class="badge badge-gray" style="margin-left: 8px; font-size: 0.65rem;">System</span>
                            {% endif %}
                        </td>

                        <td class="col-center">
                            {% if stage.is_dashboard_stage %}
                                <span class="badge badge-success">Visible</span>
                            {% else %}
                                <span class="badge badge-gray">Hidden</span>
                            {% endif %}
                        </td>

                        <td class="action-buttons">
                            {% if is_locked %}
                                <span style="color: #cbd5e1; font-size: 0.8rem; font-style: italic;">Locked</span>
                            {% else %}
                                <button class="button button-small button-secondary"
                                    onclick="openEditModal('{{ stage.id }}', '{{ stage.stage_name }}', '{{ stage.is_dashboard_stage }}')">
                                    Edit
                                </button>
                                <form action="{{ url_for('delete_stage') }}" method="POST" onsubmit="return confirm('Delete stage {{ stage.stage_name }}? This will remove the column from the database.');" style="display:inline;">
                                    <input type="hidden" name="stage_id" value="{{ stage.id }}">
                                    <input type="hidden" name="stage_name" value="{{ stage.stage_name }}">
                                    <button type="submit" class="button button-small button-danger"></button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5" class="placeholder">No stages defined.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{# --- Modern Modals --- #}

<div id="add-stage-modal" class="modal">
    <div class="modal-content items-modal-content">
        <div class="items-modal-header">
            <div class="header-text">
                <h2>New Stage</h2>
                <p>Define a new production step</p>
            </div>
            <span class="close-button" id="close-add-modal">&times;</span>
        </div>

        <div class="items-modal-body">
            <form action="{{ url_for('add_stage') }}" method="POST">
                <div class="items-form-grid" style="display: block;"> <div class="form-group" style="margin-bottom: 20px;">
                        <label>Stage Name</label>
                        <input type="text" name="stage_name" class="items-input" required placeholder="e.g. Quality Check" autocomplete="off">
                        <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">This will add a new column to the database.</small>
                    </div>
                    
                    <div class="form-group" style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="add_include_dashboard" name="include_dashboard" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <div>
                            <label for="add_include_dashboard" style="margin: 0; cursor: pointer; color: #0f172a; font-size: 0.9rem;">Show on Dashboard</label>
                            <div style="font-size: 0.75rem; color: #64748b;">Include this stage in the top summary cards</div>
                        </div>
                    </div>
                </div>

                <div class="items-modal-footer">
                    <button type="submit" class="button button-primary">Create Stage</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="edit-stage-modal" class="modal">
    <div class="modal-content items-modal-content">
        <div class="items-modal-header">
            <div class="header-text">
                <h2>Edit Stage</h2>
                <p>Update stage properties</p>
            </div>
            <span class="close-button" id="close-edit-modal">&times;</span>
        </div>

        <div class="items-modal-body">
            <form action="{{ url_for('edit_stage') }}" method="POST">
                <input type="hidden" id="edit_stage_id" name="stage_id">
                <input type="hidden" id="edit_original_name" name="original_name">

                <div class="items-form-grid" style="display: block;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Stage Name</label>
                        <input type="text" id="edit_stage_name" name="stage_name" class="items-input" required>
                    </div>
                    
                    <div class="form-group" style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="edit_include_dashboard" name="include_dashboard" style="width: 18px; height: 18px; cursor: pointer;">
                        <div>
                            <label for="edit_include_dashboard" style="margin: 0; cursor: pointer; color: #0f172a; font-size: 0.9rem;">Show on Dashboard</label>
                            <div style="font-size: 0.75rem; color: #64748b;">Include this stage in the top summary cards</div>
                        </div>
                    </div>
                </div>

                <div class="items-modal-footer">
                    <button type="submit" class="button button-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.stagesConfig = {
        urls: {
            reorderStages: "{{ url_for('reorder_stages') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/stages.js') }}"></script>
{% endblock %}

======================================================================
== FILE: templates\login.html
======================================================================

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Production Planning</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="login-wrapper">
        <div class="login-card">
            
            <div class="login-header">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='images/ELGi_Black.png') }}" alt="ELGI Logo" class="logo-img">
                </div>
                
                <h1>Welcome Back</h1>
                <p class="subtitle">Manufacturing Execution System</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-container">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">
                                {% if category == 'error' %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                {% else %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                {% endif %}
                                <span>{{ message }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <form action="{{ url_for('login') }}" method="POST" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <input type="text" id="username" name="username" placeholder="Enter your ID" required autofocus autocomplete="username">
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <input type="password" id="password" name="password" placeholder="" required autocomplete="current-password">
                    </div>
                </div>

                <button type="submit" class="login-btn">
                    Sign In
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                </button>
            </form>

            <div class="login-footer">
                <p>&copy; 2025 ELGI Equipments Limited</p>
                <p class="version">System v1.0.3</p>
            </div>
        </div>
    </div>

</body>
</html>

======================================================================
== FILE: static\css\attendance.css
======================================================================

/* =========================================
   ATTENDANCE & ROSTER - CLEAN LAYOUT
   ========================================= */

:root {
    --primary-color: #ea580c;
    --primary-hover: #c2410c;
    --bg-surface: #ffffff;
    --bg-subtle: #f8fafc;
    --border-light: #e2e8f0;
    --header-bg: #f8fafc;
    --header-text: #334155;
    --text-main: #0f172a;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
}

/* --- Layout --- */
.page-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 85px);
    overflow: hidden;
    padding: 0 4px;
}

.content-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
    overflow: hidden;
}

/* --- 1. Header --- */
.attendance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-light);
    background-color: #fff;
    flex-shrink: 0;
}

.attendance-header h1 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--text-main);
    letter-spacing: -0.025em;
}

.header-actions {
    display: flex;
    gap: 10px;
}

/* --- 2. Toolbar (The Control Bar) --- */
.controls-toolbar {
    padding: 10px 20px;
    background-color: #fff;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    flex-shrink: 0;
    gap: 15px;
    height: 60px; /* Fixed height for consistency */
    box-sizing: border-box;
}

/* Week Nav (Left Side) */
.week-nav {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 2px;
}

.nav-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
}
.nav-btn:hover { background-color: var(--bg-subtle); color: var(--primary-color); }

.week-display {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-main);
    padding: 0 15px;
    min-width: 160px;
    text-align: center;
    user-select: none;
    border-left: 1px solid var(--border-light);
    border-right: 1px solid var(--border-light);
    line-height: 32px;
}

/* Right Controls Group (Pushed to right) */
.controls-right {
    margin-left: auto; /* This pushes filters to the right */
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Filter Items */
.control-item {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 0 4px 0 12px;
    height: 36px; /* Consistent Height */
}

.control-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-muted);
    margin-right: 8px;
    text-transform: uppercase;
}

.compact-select, .compact-date {
    border: none;
    font-size: 0.85rem;
    color: var(--text-main);
    outline: none;
    background: transparent;
    height: 100%;
    cursor: pointer;
    font-weight: 500;
    padding-right: 5px;
}

.icon-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: var(--bg-subtle);
    border-radius: 4px;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 5px;
}
.icon-btn:hover { background: var(--primary-color); color: white; }

/* --- 3. The Grid (Table Container) --- */
.grid-container {
    flex: 1; /* Take remaining height */
    overflow: auto; /* Scroll internally */
    position: relative;
    width: 100%;
    background-color: #fff;
}

/* Force table to align left and top */
.attendance-table {
    width: 100%; 
    border-collapse: separate;
    border-spacing: 0;
    margin: 0; /* Remove any default margins */
}

/* --- Sticky Headers --- */
.attendance-table thead th {
    position: sticky;
    top: 0;
    z-index: 20;
    background-color: var(--header-bg);
    color: var(--header-text);
    border-bottom: 1px solid var(--border-light);
    padding: 8px;
    text-align: center;
    vertical-align: middle;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* Top Left Corner (Employee Name Header) */
.attendance-table thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 30; /* Stays on top of everything */
    background-color: var(--header-bg);
    border-right: 1px solid var(--border-light);
    text-align: left;
    padding-left: 15px;
    width: 250px;
    min-width: 250px;
}

/* Date Header Content */
.date-header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.1;
}
.dh-day { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); }
.dh-date { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }

/* --- Table Rows --- */
.attendance-table tbody td {
    padding: 6px;
    border-bottom: 1px solid var(--border-light);
    border-right: 1px solid var(--border-light);
    vertical-align: middle;
    text-align: center;
    height: 50px;
    background-color: #fff;
}

/* Sticky First Column (Names) */
.attendance-table tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 10;
    background-color: #fff;
    border-right: 1px solid var(--border-light);
    text-align: left;
    padding-left: 15px;
    box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
}

.emp-name { font-weight: 600; color: var(--text-main); display: block; font-size: 0.9rem; }
.emp-id { font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 2px; font-family: monospace; }

/* Cell Types */
.stage-cell {
    background-color: #fafafa !important;
    color: var(--text-secondary);
    font-size: 0.8rem;
    text-align: left !important;
    padding-left: 10px !important;
}

.weekend { background-color: #f8fafc !important; }
.holiday { background-color: #eff6ff !important; color: #1e40af; font-weight: 600; }

/* -----------------------------------
   STATUS DROPDOWNS (THE FIX) 
   -----------------------------------
*/
.status-select {
    width: 100%;
    height: 34px;
    border: 1px solid #cbd5e1; /* VISIBLE Border */
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    appearance: none;
    background-color: #fff; /* White background by default */
    color: #475569; /* Darker text for visibility */
    transition: all 0.2s;
}

/* Hover State */
.status-select:hover {
    border-color: var(--primary-color);
    background-color: #fff7ed; /* Light orange tint */
}

/* Focus State */
.status-select:focus { 
    outline: none; 
    border-color: var(--primary-color); 
    box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.1);
}

/* Colored States (Present/Absent) */
.status-select.present { background-color: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
.status-select.absent { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

/* --- Manage View --- */
#manage-view { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
.manage-container { padding: 20px; overflow: auto; flex: 1; }
.manage-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

#manage-table { width: 100%; border-collapse: collapse; }
#manage-table th { text-align: left; background: var(--bg-subtle); color: var(--text-secondary); padding: 12px; border-bottom: 2px solid var(--border-light); font-size: 0.8rem; text-transform: uppercase; }
#manage-table td { padding: 12px; border-bottom: 1px solid var(--border-light); font-size: 0.9rem; }
#manage-table tr:hover { background-color: var(--bg-subtle); }

.stage-badge { background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #64748b; border: 1px solid #e2e8f0; font-weight: 500; }

/* --- Buttons --- */
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
    height: 36px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.85rem;
    border: 1px solid transparent;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
    white-space: nowrap;
    gap: 8px;
}
.button-primary { background-color: var(--primary-color); color: white; }
.button-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
.button-secondary { background-color: #fff; border: 1px solid var(--border-light); color: var(--text-secondary); }
.button-secondary:hover { border-color: var(--text-muted); color: var(--text-main); background-color: var(--bg-subtle); }
.button-small { height: 28px; padding: 0 10px; font-size: 0.75rem; }
.button-danger { background-color: #fef2f2; color: #ef4444; border: 1px solid #fecaca; }
.button-danger:hover { background-color: #fee2e2; border-color: #ef4444; }

/* Modal Grid */
.modal-form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
.modal-name-grid { display: grid; grid-template-columns: 80px 1fr; gap: 10px; }
.modal-input { width: 100%; padding: 10px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
.form-actions { text-align: right; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-light); }

/* =========================================
   ATTENDANCE MODAL STYLES
   ========================================= */

.attendance-modal-content {
    padding: 0;
    border: none;
    border-radius: 12px;
    background-color: #ffffff;
    max-width: 500px;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

/* Reusing generic header style from settings if available, 
   but ensuring specific overrides here just in case */
.settings-header {
    background-color: #fff;
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.settings-body {
    padding: 24px;
}

/* Grid Layout for Form */
.modal-form-grid {
    display: grid;
    grid-template-columns: 1fr 2fr; /* Title takes less space, Name takes more */
    gap: 16px;
    margin-bottom: 0;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* Form Inputs */
.modal-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.modal-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.9rem;
    color: var(--text-main);
    transition: all 0.2s;
    background-color: #f8fafc;
}

.modal-input:focus {
    background-color: #fff;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
    outline: none;
}

/* Select Arrow Styling */
.select-wrapper {
    position: relative;
}
.select-wrapper::after {
    content: "";
    font-size: 0.7rem;
    color: var(--text-secondary);
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}
select.modal-input {
    appearance: none;
    cursor: pointer;
}

/* Footer Actions */
.form-actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #f1f5f9;
    display: flex;
    justify-content: flex-end;
}

.form-actions .button {
    height: 40px;
    font-size: 0.9rem;
    padding: 0 24px;
}



======================================================================
== FILE: static\css\dashboard.css
======================================================================

.dashboard-section { margin-top: -20px; margin-bottom: 10px; }
.stage-cards-container { display: grid; grid-template-columns: repeat(13, minmax(0, 1fr)); gap: 5px; margin-top: 10px; }
.stage-card { background-color: #fff; border: 1px solid #000; border-radius: 6px; padding: 8px 4px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; text-align: center; min-height: 55px; }
.stage-card:first-child { grid-column: span 1; background-color: #e5e7eb; border: 1px solid #374151; }
.stage-card .count { font-size: 1.5rem; font-weight: 600; line-height: 1; display: block; width: 100%; }
.stage-card .stage-name { font-size: 0.65rem; text-align: center; white-space: normal; word-break: break-word; line-height: 1.1; }

.dashboard-tables-container, .details-view-wrapper { display: flex; align-items: flex-start; gap: 10px; justify-content: center; }
.dashboard-tables-container .table-wrapper, .details-view-wrapper .table-container { flex-shrink: 0; }
.dashboard-tables-container table, .details-view-wrapper table { font-size: 0.75rem; width: auto; border-collapse: collapse; }

.dashboard-tables-container .table-wrapper:last-child table { font-size: 0.8rem; width: 100%; }
.dashboard-tables-container .table-wrapper:last-child { flex-shrink: 1; min-width: 0; }

.dashboard-tables-container th, .dashboard-tables-container td, .details-view-wrapper th, .details-view-wrapper td { padding: 0px 3px; font-size: 0.84rem; text-align: center; white-space: nowrap; border: 1px solid #000; line-height: 0.98; }

.dashboard-tables-container .table-wrapper:last-child th { padding: 8px 10px; white-space: normal; vertical-align: middle; }
.dashboard-tables-container .table-wrapper:last-child td { padding: 7px 10px; white-space: normal; vertical-align: middle; }

.dashboard-tables-container .table-wrapper:last-child th:nth-child(2), .dashboard-tables-container .table-wrapper:last-child th:nth-child(3), .dashboard-tables-container .table-wrapper:last-child th:nth-child(4) { max-width: 65px; }

.dashboard-tables-container td.align-left, .details-view-wrapper td.align-left { text-align: left; }
.description-col { max-width: 180px; white-space: normal; }
.total-row td { font-weight: bold; border-top: 2px solid #000; background-color: #f8f9fa; }
.table-title { font-size: 0.9rem; font-weight: 600; padding: 4px; background-color: #e9ecef; }

.clickable-row { cursor: pointer; }
.clickable-row:hover { background-color: #e9ecef; }
.selected-row { background-color: #dbeafe !important; font-weight: bold; }

.draggable-item { cursor: grab; }
.draggable-item:active { cursor: grabbing; }
.draggable-item.dragging { opacity: 0.5; background-color: #f0f0f0; }
.drop-target.drag-over { background-color: #d1e7dd !important; border: 2px dashed #0f5132; }

#failure-header-toggle { cursor: pointer; user-select: none; background-color: #fee2e2; color: #991b1b; transition: background-color 0.2s; }
#failure-header-toggle:hover { background-color: #fecaca; }
#failure-header-toggle.active { background-color: #ef4444; color: white; }

.reason-cell { min-width: auto; width: 80px; padding: 2px !important; vertical-align: middle; }
.reason-btn { padding: 3px 8px; font-size: 0.75em; width: 100%; background-color: #ffc107; color: #333; border: 1px solid #d39e00; display: none; }
.reason-btn.has-reason { background-color: #fffbeb; border-color: #fcd34d; color: #78350f; }
.reason-btn:hover { background-color: #e0a800; }

#plan-table-body.show-failures .reason-btn { display: inline-block; }

#failure-reason-modal label { display: block; margin-bottom: 5px; font-weight: 500; }
#failure-reason-modal select { width: 100%; padding: 8px; }
#failure-reason-modal .modal-info { margin-bottom: 15px; font-size: 0.9em; color: var(--text-secondary); }
#failure-reason-modal .modal-info strong { color: var(--text-primary); }

#fullscreen-toggle { position: fixed; top: 75px; right: 30px; cursor: pointer; color: #888; z-index: 1050; }
#fullscreen-toggle:hover { color: #000; }

.details-view-wrapper > div { width: fit-content; margin: 0 auto; }
.details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 15px; padding-right: 30px; }
.details-header h2 { margin: 0; }


    /* Force the body to fit the screen exactly */
    html, body {
        font-size: 15px; /* Reduce base font size */
    }


======================================================================
== FILE: static\css\items.css
======================================================================

/* =========================================
   ITEM MASTER - NATURAL SCROLL (NO STICKY)
   ========================================= */

:root {
    --primary-color: #ea580c;       /* Orange-600 */
    --primary-hover: #c2410c;       /* Orange-700 */
    --primary-light: #fff7ed;       /* Orange-50 */
    --primary-border: #fdba74;      /* Orange-300 */

    --success-color: #16a34a;
    --success-bg: #f0fdf4;
    --danger-color: #ef4444;
    
    --bg-surface: #ffffff;
    --bg-subtle: #f8fafc;
    --border-light: #e2e8f0;
    
    --header-bg: #334155; 
    --header-text: #ffffff;
    
    --text-main: #0f172a;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
}

/* --- Layout (Expands Downwards) --- */
.page-container {
    display: flex;
    flex-direction: column;
    /* Allow height to grow beyond screen for natural scrolling */
    min-height: calc(100vh - 85px); 
    overflow: visible; 
    padding: 0 4px 20px 4px; /* Bottom padding for scroll space */
}

.content-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    /* Auto height allows expansion */
    height: auto; 
    min-height: 0;
}

/* --- Filter Toolbar --- */
.filter-toolbar {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-light);
    background-color: #fff;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    flex-shrink: 0;
    gap: 16px;
    height: 52px;
    box-sizing: border-box;
}

.toolbar-title {
    font-size: 1.25rem;
    color: var(--text-main);
    font-weight: 800;
    margin: 0;
    letter-spacing: -0.025em;
    white-space: nowrap;
}

.toolbar-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* Inputs */
.filter-input {
    padding: 0 10px 0 30px;
    border: 1px solid var(--border-light);
    border-radius: 5px;
    font-size: 0.8rem;
    color: var(--text-main);
    background-color: var(--bg-subtle);
    outline: none;
    transition: all 0.2s;
    height: 30px;
    box-sizing: border-box;
    width: 200px;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='11' cy='11' r='8'%3e%3c/circle%3e%3cline x1='21' y1='21' x2='16.65' y2='16.65'%3e%3c/line%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: left 8px center;
    background-size: 14px;
}

.filter-input:focus {
    background-color: #fff;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.1);
}

/* --- Buttons --- */
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 14px;
    border-radius: 5px;
    font-weight: 600;
    font-size: 0.8rem;
    border: 1px solid transparent;
    cursor: pointer;
    height: 30px;
    text-decoration: none;
    white-space: nowrap;
    gap: 6px;
    transition: all 0.2s;
}

.button-primary { background-color: var(--primary-color); color: white; }
.button-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }

.button-secondary { background-color: #fff; border: 1px solid var(--border-light); color: var(--text-secondary); }
.button-secondary:hover { border-color: var(--text-muted); color: var(--text-main); background-color: var(--bg-subtle); }

.button-small { 
    height: 24px; 
    padding: 0 8px; 
    font-size: 0.75rem; 
    border-radius: 4px;
}

.button-blue { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
.button-blue:hover { background-color: #dbeafe; }

.button-danger { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
.button-danger:hover { background-color: #fee2e2; }

/* --- Table Styles (No Sticky, Natural Scroll) --- */
.table-container {
    width: 100%;
    /* Remove internal scroll constraints */
    overflow: visible; 
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.75rem; 
    table-layout: auto; 
}

th {
    /* Standard Static Positioning */
    position: static;
    
    background-color: var(--header-bg);
    color: var(--header-text);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.65rem;
    letter-spacing: 0.05em;
    padding: 10px 6px;
    border-bottom: 1px solid #1e293b;
    white-space: nowrap;
    text-align: left;
}

td {
    padding: 8px 6px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-main);
    vertical-align: middle;
    text-align: left;
    white-space: nowrap;
}

/* Column Specifics */
th.col-center, td.col-center { text-align: center; }
th.col-right, td.col-right { text-align: right; }

td.col-code { 
    font-family: 'Consolas', monospace; 
    font-weight: 600; 
    color: #334155; 
    width: 100px;
}

td.col-desc {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-secondary);
}

td.action-buttons {
    text-align: center;
    width: 180px;
    padding: 4px !important;
}

tr:hover td { background-color: var(--primary-light); }

/* --- Pagination (Static at Bottom) --- */
.pagination-container {
    padding: 12px 24px;
    border-top: 1px solid var(--border-light);
    background: #ffffff;
    display: flex;
    justify-content: flex-end; 
    align-items: center;
    /* Static position flows naturally after table */
    position: static; 
}

.pagination { display: flex; list-style: none; padding: 0; margin: 0; gap: 4px; }

.page-link {
    display: flex; align-items: center; justify-content: center;
    min-width: 28px; height: 28px; padding: 0 8px;
    border: 1px solid var(--border-light); border-radius: 4px; background-color: #ffffff;
    color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; text-decoration: none;
    transition: all 0.2s;
}

.page-item.disabled .page-link { background: #f8fafc; border-color: #f1f5f9; color: #cbd5e1; pointer-events: none; }
.page-link:hover:not(.disabled) { border-color: var(--primary-color); color: var(--primary-color); background-color: #fff7ed; transform: translateY(-1px); }

.page-item.active .page-link, .page-item.disabled span.page-link {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    color: #ffffff !important;
    opacity: 1 !important;
    box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.4);
    pointer-events: none;
}

/* --- Modals --- */
.modal-content {
    border-radius: 10px;
    border: 1px solid var(--border-light);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    padding: 24px;
    max-width: 600px;
}

.modal h3 { margin-top: 0; color: var(--text-main); font-size: 1.25rem; font-weight: 800; margin-bottom: 20px; }

.modal-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
}

.modal-form-grid label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    display: block;
    margin-bottom: 4px;
    text-transform: uppercase;
}

.modal-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.9rem;
    color: var(--text-main);
    box-sizing: border-box;
    transition: all 0.2s;
}

.modal-input:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
}

.form-actions {
    text-align: right;
    padding-top: 10px;
    border-top: 1px solid var(--border-light);
}

/* WIP Grid in Modal */
.wip-grid {
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 10px;
    background: var(--bg-subtle);
}

/* =========================================
   ITEMS MODAL STYLES (MATCHING SETTINGS)
   ========================================= */

/* 1. Modal Container */
.items-modal-content {
    background-color: #ffffff;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 0; 
    max-width: 600px;
    width: 95%;
    
    /* --- FIX: Flexbox for sticky header + Scrollable Body --- */
    display: flex;
    flex-direction: column;
    max-height: 90vh; /* Prevent it from going off-screen */
    
    position: relative;
    animation: modalFadeIn 0.2s ease-out;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 2. Header (No Changes, kept for context) */
.items-modal-header {
    background-color: #fff;
    padding: 20px 24px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-shrink: 0; /* Prevents header from shrinking */
}

/* ... (Keep existing .items-modal-header h2, p, .close-button styles) ... */

/* 3. Body (The Fix) */
.items-modal-body {
    padding: 24px;
    background-color: #fff;
    
    /* --- FIX: Enable Scrolling --- */
    overflow-y: auto; 
    flex-grow: 1; /* Takes up remaining space */
}

/* Header & Body Structure (Reusing from style.css global if avail, else defined here) */
.settings-header {
    background-color: #fff;
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}
.header-text h2 { margin: 0; font-size: 1.25rem; color: #0f172a; font-weight: 700; }
.header-text p { margin: 4px 0 0 0; font-size: 0.85rem; color: #64748b; }

.settings-body {
    padding: 24px;
}

/* Grid Layout */
.modal-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 0;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* Labels & Inputs */
.modal-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.modal-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.9rem;
    color: var(--text-main);
    transition: all 0.2s;
    background-color: #f8fafc;
    box-sizing: border-box;
}

.modal-input:focus {
    background-color: #fff;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
    outline: none;
}

.font-bold { font-weight: 700; }

/* Select Arrow */
.select-wrapper {
    position: relative;
}
.select-wrapper::after {
    content: "";
    font-size: 0.7rem;
    color: var(--text-secondary);
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}
select.modal-input {
    appearance: none;
    cursor: pointer;
}

/* WIP Scroll Area */
.wip-grid-wrapper {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 5px; /* Space for scrollbar */
}

/* Actions */
.form-actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #f1f5f9;
    display: flex;
    justify-content: flex-end;
}

.form-actions .button {
    height: 40px;
    font-size: 0.9rem;
    padding: 0 24px;
}

======================================================================
== FILE: static\css\productionpl.css
======================================================================

/* =========================================
   PRODUCTION PLAN - MATCHING WIP STYLE
   ========================================= */

:root {
    --primary-color: #ea580c;       /* Orange-600 */
    --primary-hover: #c2410c;       /* Orange-700 */
    --primary-light: #fff7ed;       /* Orange-50 */
    --primary-border: #fdba74;      /* Orange-300 */

    --success-color: #16a34a;
    --success-bg: #f0fdf4;
    --bg-surface: #ffffff;
    --bg-subtle: #f8fafc;
    --border-light: #e2e8f0;
    
    /* Header Colors (Matches WIP) */
    --header-bg: #334155; 
    --header-text: #ffffff;
    
    --text-main: #0f172a;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
}

/* --- Layout (Fixed Height with Internal Scroll) --- */
.page-container {
    display: flex;
    flex-direction: column;
    /* Full height minus navbar (approx 64px) and padding */
    height: calc(100vh - 85px); 
    overflow: hidden; 
    padding: 0 4px;
}

/* --- Content Card --- */
.content-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    flex-grow: 1; 
    min-height: 0;
}

/* --- Unified Filter Toolbar --- */
.filter-toolbar {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-light);
    background-color: #fff;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    flex-shrink: 0;
    gap: 16px;
}

.toolbar-section {
    display: flex;
    align-items: center;
    gap: 16px;
}

.toolbar-title {
    font-size: 1.25rem;
    color: var(--text-main);
    font-weight: 800;
    margin: 0;
    letter-spacing: -0.025em;
    white-space: nowrap;
}

.toolbar-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* --- Inputs --- */
.filter-select, 
.filter-input,
.rows-input {
    padding: 5px 12px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.8rem;
    color: var(--text-main);
    background-color: var(--bg-subtle);
    outline: none;
    transition: all 0.2s;
    height: 32px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
}

/* Search Input */
.filter-input {
    width: 140px;
    padding-left: 28px;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='11' cy='11' r='8'%3e%3c/circle%3e%3cline x1='21' y1='21' x2='16.65' y2='16.65'%3e%3c/line%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: left 8px center;
    background-size: 14px;
}

/* Select Dropdown */
.filter-select { 
    width: 120px;
    padding-left: 10px;
    cursor: pointer;
    padding-right: 24px;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ea580c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 10px;
}

/* Rows Input Container */
.rows-wrapper {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    background: var(--bg-subtle);
    height: 32px;
    padding-right: 8px;
    overflow: hidden;
}

.rows-input {
    border: none;
    background: transparent;
    width: 50px;
    padding: 0 0 0 8px;
    text-align: center;
    height: 100%;
    font-weight: 600;
}

.rows-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    border-left: 1px solid var(--border-light);
    padding-left: 8px;
    line-height: 32px;
}

.filter-input:focus, .filter-select:focus, .rows-input:focus {
    background-color: #fff;
    border-color: var(--primary-color);
}

/* --- Buttons --- */
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 14px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.8rem;
    border: 1px solid transparent;
    cursor: pointer;
    height: 32px;
    text-decoration: none;
    white-space: nowrap;
    gap: 6px;
}

.button svg { width: 14px; height: 14px; display: block; flex-shrink: 0; }

.button-primary { background-color: var(--primary-color); color: white; }
.button-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }

.button-success { background-color: var(--success-color); color: white; }
.button-success:hover { background-color: #15803d; transform: translateY(-1px); }

.button-secondary { background-color: #fff; border: 1px solid var(--border-light); color: var(--text-secondary); }
.button-secondary:hover { border-color: var(--text-muted); color: var(--text-main); background-color: var(--bg-subtle); }

.button-text { background: transparent; color: var(--text-secondary); padding: 0 8px; font-weight: 500; font-size: 0.8rem; height: auto; border:none; box-shadow: none; }
.button-text:hover { color: var(--primary-color); text-decoration: underline; background: transparent; border: none; }

/* --- Table Styles (Matches WIP Exactly) --- */
.table-wrapper {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: auto;
    width: 100%;
    position: relative;
    /* Hide scrollbars */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
.table-wrapper::-webkit-scrollbar { display: none; }

.modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.75rem; 
    table-layout: auto; 
}

.modern-table th {
    position: sticky;
    top: 0;
    
    /* Dark Header Style from WIP */
    background-color: var(--header-bg);
    color: var(--header-text);
    
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.65rem;
    letter-spacing: 0.05em;
    padding: 10px 6px;
    border-bottom: 1px solid #1e293b;
    z-index: 10;
    white-space: nowrap;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.modern-table td {
    padding: 6px 6px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-main);
    vertical-align: middle;
    text-align: center;
    white-space: nowrap;
}

/* --- Column Styling --- */
.col-code { font-weight: 600; color: #334155; font-family: 'Consolas', monospace; text-align: left; }
.col-desc { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); text-align: left; }
.col-center { text-align: center; }

/* Highlights */
/* Matches the "Total Inv" blue column from WIP */
.bg-highlight { 
    background-color: #e0f2fe; 
    color: #0369a1; 
    font-weight: 700; 
    border-left: 1px solid var(--border-light); 
    border-right: 1px solid var(--border-light); 
}

.text-pending { color: #d97706; font-weight: 700; }
.text-good { color: #16a34a; font-weight: 500; opacity: 0.7; }

/* Row Hover */
.modern-table tr:hover td { background-color: var(--primary-light); }

/* Badges */
.badge { display: inline-flex; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; line-height: 1.2; border: 1px solid transparent; }
.badge-blue { background: var(--bg-subtle); color: var(--text-secondary); border-color: var(--border-light); }
.badge-gray { background: #f1f5f9; color: #64748b; }
.badge-warning { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }

/* Modified Plan Input */
.plan-input {
    width: 100%; max-width: 80px; padding: 6px;
    border: 1px solid var(--border-light); border-radius: 4px;
    text-align: center; font-weight: 700; color: var(--primary-color);
    font-size: 0.9rem; transition: all 0.2s; background: white;
}
.plan-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.15); outline: none; }

/* Failure Button */
.reason-btn {
    font-size: 0.7rem; padding: 2px 8px; border-radius: 12px;
    border: 1px solid #fecaca; background-color: #fef2f2; color: #ef4444;
    cursor: pointer; transition: all 0.2s; display: inline-block; white-space: nowrap;
}
.reason-btn:hover { background-color: #fee2e2; border-color: #f87171; }
.reason-btn.has-reason { background-color: #fff7ed; border-color: #fdba74; color: #c2410c; }

/* --- Pagination (Bright & Attractive) --- */
.pagination-container {
    padding: 12px 24px;
    border-top: 1px solid var(--border-light);
    background: #ffffff;
    display: flex;
    justify-content: flex-end; 
    align-items: center;
    flex-shrink: 0;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.02);
}

.pagination { display: flex; list-style: none; padding: 0; margin: 0; gap: 6px; }

.page-link {
    display: flex; align-items: center; justify-content: center;
    min-width: 32px; height: 32px; padding: 0 12px;
    border: 1px solid var(--border-light); border-radius: 8px; background-color: #ffffff;
    color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; text-decoration: none;
    transition: all 0.2s;
}

.page-item.disabled .page-link { background: #f8fafc; border-color: #f1f5f9; color: #cbd5e1; pointer-events: none; }
.page-link:hover:not(.disabled) { border-color: var(--primary-color); color: var(--primary-color); background-color: #fff7ed; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(234, 88, 12, 0.1); }

/* Active Page */
.page-item.active .page-link, .page-item.disabled span.page-link {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    color: #ffffff !important;
    opacity: 1 !important;
    box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.4);
    pointer-events: none;
}

/* Empty State */
.empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; color: var(--text-muted); text-align: center; padding: 40px;
}
.empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; filter: grayscale(1); }

/* View Toggle */
.view-toggle {
    background: var(--bg-subtle);
    padding: 3px;
    border-radius: 6px;
    display: flex;
    border: 1px solid var(--border-light);
    margin-right: 10px;
}
.toggle-btn {
    padding: 4px 10px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    transition: all 0.2s;
    line-height: 1;
}
.toggle-btn.active { background: white; color: var(--primary-color); font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

======================================================================
== FILE: static\css\stages.css
======================================================================

/* =========================================
   MODERN STAGES UI
   ========================================= */

:root {
    --primary-color: #ea580c;       /* Orange-600 */
    --primary-hover: #c2410c;       /* Orange-700 */
    --bg-surface: #ffffff;
    --bg-subtle: #f8fafc;
    --border-light: #e2e8f0;
    
    --header-bg: #334155; 
    --header-text: #ffffff;
    
    --text-main: #0f172a;
    --text-secondary: #64748b;
}

/* --- Layout --- */
.page-container {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 85px); 
    padding: 0 4px 20px 4px;
}

.content-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    min-height: 0;
}

/* --- Toolbar --- */
.filter-toolbar {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-light);
    background-color: #fff;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    gap: 16px;
}

.toolbar-title {
    font-size: 1.25rem;
    color: var(--text-main);
    font-weight: 800;
    margin: 0;
    letter-spacing: -0.025em;
    line-height: 1.1;
}

.toolbar-subtitle {
    font-size: 0.85rem;
    color: var(--text-secondary);
    display: block;
    margin-top: 2px;
}

/* --- Buttons --- */
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.85rem;
    border: 1px solid transparent;
    cursor: pointer;
    height: 36px;
    text-decoration: none;
    transition: all 0.2s;
    gap: 8px;
}

.button-primary { background-color: var(--primary-color); color: white; }
.button-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }

.button-secondary { background-color: #fff; border: 1px solid var(--border-light); color: var(--text-secondary); }
.button-secondary:hover { border-color: var(--text-secondary); color: var(--text-main); background-color: var(--bg-subtle); }

.button-danger { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; height: 28px; padding: 0 10px; }
.button-danger:hover { background-color: #fee2e2; border-color: #f87171; }

.button-small { height: 28px; padding: 0 12px; font-size: 0.75rem; }

/* --- Table Styles --- */
.table-container {
    width: 100%;
    overflow: visible;
}

.modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9rem;
}

.modern-table th {
    background-color: var(--header-bg);
    color: var(--header-text);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 12px 16px;
    border-bottom: 1px solid #1e293b;
    text-align: left;
}

.modern-table td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-main);
    vertical-align: middle;
}

.modern-table tr:hover td { background-color: var(--bg-subtle); }

/* Column Helpers */
.col-center { text-align: center !important; }
.stage-label { font-weight: 600; color: #334155; }

/* Badges */
.badge { display: inline-flex; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; border: 1px solid transparent; }
.badge-success { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
.badge-gray { background: #f1f5f9; color: #64748b; border-color: #e2e8f0; }

/* Dragging Styles */
.draggable-row { transition: background-color 0.2s; }
.draggable-row.dragging { opacity: 0.5; background: #e2e8f0; }

/* --- REUSED MODAL STYLES (Matches Items/Settings) --- */
.items-modal-content {
    background-color: #ffffff;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    padding: 0; 
    max-width: 450px; /* Slightly narrower for stages */
    width: 95%;
    display: flex;
    flex-direction: column;
    max-height: 90vh;
    position: relative;
    animation: modalFadeIn 0.2s ease-out;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.items-modal-header {
    background-color: #fff;
    padding: 20px 24px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-shrink: 0;
}

.items-modal-header h2 { margin: 0; font-size: 1.25rem; font-weight: 700; color: #0f172a; }
.items-modal-header p { margin: 4px 0 0 0; font-size: 0.85rem; color: #64748b; }
.close-button { font-size: 1.5rem; color: #94a3b8; cursor: pointer; line-height: 1; }
.close-button:hover { color: #ef4444; }

.items-modal-body { padding: 24px; background-color: #fff; overflow-y: auto; flex-grow: 1; }

.items-form-grid label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 6px; display: block; }

.items-input {
    width: 100%; padding: 10px 12px;
    background-color: #f8fafc; border: 1px solid #e2e8f0;
    border-radius: 6px; font-size: 0.9rem; color: #0f172a;
    box-sizing: border-box; transition: all 0.2s;
}
.items-input:focus { background-color: #fff; border-color: #ea580c; outline: none; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1); }

.items-modal-footer {
    margin-top: 24px; padding-top: 20px; border-top: 1px solid #f1f5f9;
    display: flex; justify-content: flex-end;
}
.items-modal-footer .button { height: 40px; padding: 0 24px; font-size: 0.9rem; }

======================================================================
== FILE: static\css\wip.css
======================================================================

/* =========================================
   WIP TRACKER - NATURAL SCROLL (NO STICKY)
   ========================================= */

:root {
    --primary-color: #ea580c;       /* Orange-600 */
    --primary-hover: #c2410c;       /* Orange-700 */
    --primary-light: #fff7ed;       /* Orange-50 */
    --primary-border: #fdba74;      /* Orange-300 */

    --success-color: #16a34a;
    --success-bg: #f0fdf4;
    --bg-surface: #ffffff;
    --bg-subtle: #f8fafc;
    --border-light: #e2e8f0;
    
    /* Header Colors (Dark Slate) */
    --header-bg: #334155; 
    --header-text: #ffffff;
    
    --text-main: #0f172a;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
}

/* --- Layout: Natural Scroll --- */
.page-container {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 85px); 
    overflow: visible; 
    padding: 0 4px 20px 4px;
}

/* --- Content Card --- */
.content-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
    height: auto;
}

/* --- Filter Toolbar --- */
.filter-toolbar {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-light);
    background-color: #fff;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    gap: 16px;
    height: 52px;
    box-sizing: border-box;
    flex-shrink: 0;
}

.toolbar-title {
    font-size: 1.25rem;
    color: var(--text-main);
    font-weight: 800;
    margin: 0;
    letter-spacing: -0.025em;
    white-space: nowrap;
}

.toolbar-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    height: 100%;
}

/* --- Inputs --- */
.filter-select, 
.filter-input {
    padding: 0 10px;
    border: 1px solid var(--border-light);
    border-radius: 5px;
    font-size: 0.8rem;
    color: var(--text-main);
    background-color: var(--bg-subtle);
    outline: none;
    transition: all 0.2s;
    height: 30px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
}

.filter-input {
    width: 140px;
    padding-left: 28px;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='11' cy='11' r='8'%3e%3c/circle%3e%3cline x1='21' y1='21' x2='16.65' y2='16.65'%3e%3c/line%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: left 8px center;
    background-size: 14px;
}

.filter-select { 
    width: 120px;
    padding-left: 10px;
    cursor: pointer;
    padding-right: 24px;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ea580c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 10px;
}

.filter-input:focus, .filter-select:focus {
    background-color: #fff;
    border-color: var(--primary-color);
}

/* --- Buttons --- */
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 14px;
    border-radius: 5px;
    font-weight: 600;
    font-size: 0.8rem;
    border: 1px solid transparent;
    cursor: pointer;
    height: 30px;
    text-decoration: none;
    white-space: nowrap;
    gap: 6px;
}

.button-secondary { background-color: #fff; border: 1px solid var(--border-light); color: var(--text-secondary); }
.button-secondary:hover { border-color: var(--text-muted); color: var(--text-main); background-color: var(--bg-subtle); }
.button-primary { background-color: var(--primary-color); color: white; }
.button-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }

/* --- Table Styles (Modern) --- */
.table-wrapper {
    overflow: visible;
    width: 100%;
}

.modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.75rem; 
    table-layout: auto; 
}

/* --- HEADER: NOT STICKY --- */
.modern-table th {
    position: static; /* Removes sticky behavior */
    
    background-color: var(--header-bg);
    color: var(--header-text);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.65rem;
    letter-spacing: 0.05em;
    padding: 10px 6px;
    border-bottom: 1px solid #1e293b;
    white-space: nowrap;
    text-align: center;
}

.modern-table td {
    padding: 6px 6px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-main);
    vertical-align: middle;
    text-align: center;
    white-space: nowrap;
}

/* --- Column Specifics --- */
.col-code { 
    font-weight: 600; 
    color: #334155; 
    font-family: 'Consolas', monospace; 
    text-align: left !important;
}

.col-desc { 
    max-width: 250px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    color: var(--text-secondary); 
    text-align: left !important;
}

.col-left { text-align: left !important; }
.col-center { text-align: center !important; }

/* Highlights */
.bg-highlight { 
    background-color: #e0f2fe; 
    color: #0369a1; 
    font-weight: 700; 
    border-left: 1px solid var(--border-light); 
    border-right: 1px solid var(--border-light); 
}

/* Row Interactions */
.modern-table tr:hover td { background-color: var(--primary-light); }

.clickable-cell { cursor: pointer; color: var(--primary-color); font-weight: 600; }
.clickable-cell:hover { text-decoration: underline; background-color: #ffedd5; }
.quantity-zero { color: #cbd5e1; }

/* --- Pagination: NOT STICKY --- */
.pagination-container {
    padding: 12px 24px;
    border-top: 1px solid var(--border-light);
    background: #ffffff;
    display: flex;
    justify-content: flex-end; 
    align-items: center;
    flex-shrink: 0;
    position: static;
    box-shadow: none; /* Removed shadow since it's not floating */
}

.pagination { display: flex; list-style: none; padding: 0; margin: 0; gap: 4px; }

.page-link {
    display: flex; align-items: center; justify-content: center;
    min-width: 32px; height: 32px; padding: 0 12px;
    border: 1px solid var(--border-light); border-radius: 6px; background-color: #ffffff;
    color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; text-decoration: none;
    transition: all 0.2s;
}

.page-item.disabled .page-link { background: #f8fafc; border-color: #f1f5f9; color: #cbd5e1; pointer-events: none; }
.page-link:hover:not(.disabled) { border-color: var(--primary-color); color: var(--primary-color); background-color: #fff7ed; transform: translateY(-1px); }

/* =========================================
   ENHANCED ACTION MODAL STYLES
   ========================================= */

/* Modal Container */
.action-modal-content {
    padding: 0; /* Remove default padding, handled by children */
    border: none;
    border-radius: 12px;
    overflow: hidden;
    max-width: 420px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

/* 1. Header */
.modal-header {
    background-color: var(--header-bg);
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.02em;
}

.modal-header .close-button {
    color: #94a3b8;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    transition: color 0.2s;
}

.modal-header .close-button:hover { color: white; }

/* 2. Context Bar */
.modal-context-bar {
    background-color: #f1f5f9;
    padding: 10px 20px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
}

/* 3. Body Layout */
.modal-body {
    padding: 0;
}

.action-section {
    padding: 20px;
    background-color: white;
}

.issue-section {
    padding: 15px 20px;
    background-color: #fffbeb; /* Light Yellow/Orange for caution */
    border-top: 1px solid #fcd34d;
}

/* Form Elements */
.form-grid {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
}

.form-group {
    width: 100%;
}

.modal-label {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 700;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.modal-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.95rem;
    color: var(--text-main);
    transition: all 0.2s;
    box-sizing: border-box;
}

.modal-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
    outline: none;
}

.font-bold { font-weight: 700; }

/* Buttons */
.btn-action-primary {
    width: 100%;
    height: 40px;
    font-size: 0.95rem;
    margin-top: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 6px;
}
.btn-action-primary:hover { background-color: var(--primary-hover); }

.btn-action-success {
    width: 100%;
    height: 40px;
    font-size: 0.95rem;
    background-color: var(--success-color);
    color: white;
    border: none;
    border-radius: 6px;
}
.btn-action-success:hover { background-color: #15803d; }

/* Issue Section Styles */
.issue-header {
    font-size: 0.75rem;
    font-weight: 700;
    color: #b45309;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-action-warning {
    width: 100%;
    height: 32px;
    font-size: 0.85rem;
    background-color: #fff;
    border: 1px solid #fcd34d;
    color: #b45309;
    border-radius: 6px;
    margin-top: 0;
}
.btn-action-warning:hover {
    background-color: #fef3c7;
    border-color: #d97706;
}

/* Custom Select Arrow */
.select-wrapper {
    position: relative;
}
.select-wrapper::after {
    content: "";
    font-size: 0.7rem;
    color: var(--text-secondary);
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}
select.modal-input {
    appearance: none;
    background-color: white;
}
/* =========================================
   NOT STARTED COLUMN HIGHLIGHT (PENDING QUEUE)
   ========================================= */

/* Header Style - Warm Amber to signify 'Queue/Pending' */
.bg-not-started-header {
    background-color: #fef3c7 !important; /* Amber-100 */
    color: #92400e !important;           /* Amber-800 */
    border-right: 2px solid #fcd34d !important; /* Strong Gold Border separator */
}

/* Cell Style - Lighter Amber */
.bg-not-started-cell {
    background-color: #fffbeb !important; /* Amber-50 */
    color: #b45309;                       /* Amber-700 */
    font-weight: 700;                     /* Bold text to show backlog count clearly */ /* subtle separator */
}

/* Maintain distinct color even on row hover */
.modern-table tr:hover td.bg-not-started-cell {
    background-color: #fef3c7 !important; /* Darkens slightly on hover to match header */
}

/* Ensure empty zeros are still subtle, but tinted correctly */
.bg-not-started-cell.quantity-zero span {
    color: #d1d5db !important; /* Light Gray for dashes */
    opacity: 0.6;
}

======================================================================
== FILE: static\css\style.css
======================================================================

/* --- Google Font Import --- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

/* --- CSS Variables --- */
:root {
    /* Modern Dark Slate Palette */
    --nav-bg: #0f172a;        /* Deep Slate Blue (Sidebar & Navbar) */
    --nav-border: #1e293b;    /* Slightly lighter for borders */
    --nav-text: #94a3b8;      /* Muted Slate */
    --nav-text-hover: #f8fafc; /* White hover */
    --sidebar-width: 260px;
    
    --main-bg: #ffffff;       /* CHANGED: Pure White Background */
    --content-bg: #ffffff;    /* White cards/tables */
    --border-color: #e2e8f0;
    
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    
    --accent-color: #ea580c;
    --accent-color-hover: #c2410c; 
    
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --profile-hover: rgba(255, 255, 255, 0.1);
}

/* --- General Body Styling --- */
body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    
    /* Force white background and remove any images */
    background-color: #ffffff !important;
    background-image: none !important;
    
    color: var(--text-primary);
    overflow-x: hidden;
    min-height: 100vh;
}



/* Explicitly hide the pseudo-element that held the image */
body::before {
    display: none !important;
    content: none !important;
    background-image: none !important;
}


/* =========================================
   NAVBAR & SIDEBAR STYLES
   ========================================= */

/* --- Top Navigation Bar (Dark Theme) --- */
.top-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: var(--nav-bg); /* Dark background (Slate) */
    height: 64px;
    padding: 0 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1002;
    border-bottom: 1px solid var(--nav-border);
    color: var(--nav-text);
}

/* Wrapper for Left Elements (Toggle & Logo) */
.nav-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

/* Logo */
.logo-img {
    height: 32px;
    width: auto;
    display: block;
    /* Optional: If your logo is black text, uncomment below to invert it to white */
    /* filter: brightness(0) invert(1); */
}

/* Sidebar Toggle Button */
.menu-btn {
    background: transparent;
    border: 1px solid var(--nav-border);
    border-radius: 6px;
    cursor: pointer;
    color: var(--nav-text);
    padding: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}
.menu-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--nav-text-hover);
    border-color: var(--nav-text-hover);
}

/* Icon Swapping Logic for Toggle */
.menu-btn .close-icon { display: none; }
.menu-btn .menu-icon { display: block; }
body.sb-open .menu-btn .menu-icon { display: none; }
body.sb-open .menu-btn .close-icon { display: block; }


/* --- Right Side Actions (Settings & Profile) --- */
.nav-actions {
    display: flex;
    align-items: center;
    gap: 15px; /* Space between Settings and Profile */
}



/* --- Profile Section Styles --- */
.profile-menu {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 12px;
    border-radius: 30px; /* Pill shape */
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--nav-border);
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}

.profile-menu:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
}

.profile-avatar {
    width: 32px;
    height: 32px;
    background-color: var(--accent-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 13px;
    letter-spacing: 0.5px;
}

.profile-info {
    display: flex;
    flex-direction: column;
    line-height: 1.2;
    margin-right: 5px;
}

.profile-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--nav-text-hover); /* White text */
}

.profile-role {
    font-size: 0.7rem;
    color: var(--nav-text);
}


/* --- Sidebar Styles --- */
.sidebar {
    height: calc(100vh - 64px); /* Full height minus Navbar */
    width: var(--sidebar-width);
    position: fixed;
    z-index: 1001; /* Below Navbar */
    top: 64px; /* Starts below Navbar */
    left: calc(var(--sidebar-width) * -1); /* Hidden by default */
    background-color: var(--nav-bg); /* Dark sidebar */
    transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px 15px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--nav-border);
}

/* Sidebar Links List */
.sidebar-links {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px; /* Spacing between items */
}

.sidebar-links li a {
    padding: 12px 16px;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--nav-text);
    display: flex;
    align-items: center;
    gap: 12px;
    border-radius: 8px; /* Modern rounded shape */
    transition: all 0.2s ease;
    border-left: none; 
}

.sidebar-links li a:hover {
    background-color: rgba(255, 255, 255, 0.05);
    color: var(--nav-text-hover);
    transform: translateX(4px); /* Subtle slide effect */
}

.sidebar-links li a.active {
    background-color: var(--accent-color);
    color: #ffffff;
    box-shadow: 0 4px 6px rgba(234, 88, 12, 0.3); /* Glow effect for active item */
}

.sidebar-icon {
    width: 20px;
    height: 20px;
    opacity: 0.9;
}

/* Sidebar Separator Line */
.sidebar hr {
    border: 0;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin: 15px 0;
}
/* =========================================
   MAIN CONTENT & PUSH LOGIC
   ========================================= */

.main-content {
    padding: 15px;
    /* Transition for the "Push" effect */
    transition: margin-left 0.3s ease, width 0.3s ease;
    width: 100%;
    box-sizing: border-box;
}

/* HEADER within pages */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}
.header h1 { margin: 0; }
/* --- OPEN STATE STYLES --- */
body.sb-open .sidebar {
    left: 0;
    box-shadow: 4px 0 24px rgba(0,0,0,0.15);
}

body.sb-open .main-content {
    margin-left: var(--sidebar-width);
    width: calc(100% - var(--sidebar-width));
}

/* 2. Push Main Content right and adjust width */
body.sb-open .main-content {
    margin-left: 260px;
    width: calc(100% - 260px);
}

/* Note: Navbar does NOT move anymore, it stays fixed on top */

/* =========================================
   COMMON UI ELEMENTS
   ========================================= */

/* --- Tables --- */
.table-container { background-color: var(--content-bg); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th, td { text-align: left; border: 1px solid var(--border-color); word-wrap: break-word; font-size: 14px; }
thead th { background-color: #f8f9fa; font-weight: 600; color: var(--text-secondary); }
tbody tr:nth-child(even) { background-color: #f8f9fa; }
tbody tr:hover { background-color: #e9ecef; }
td.placeholder { text-align: center; color: var(--text-secondary); font-style: italic; }

/* Standard Padding */
.table-container table th,
.table-container table td {
    padding: 8px 10px;
}

/* --- Buttons --- */
.button {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    text-decoration: none;
}
.button:hover { background-color: var(--accent-color-hover); }
.save-button { background-color: #28a745; }
.save-button:hover { background-color: #218838; }
.button-danger { background-color: #dc3545; }
.button-danger:hover { background-color: #c82333; }

.form-actions { margin-top: 20px; text-align: right; }
input[type="number"], input[type="search"], select, input[type="text"], input[type="date"] {
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
}

/* --- Banner Notifications --- */
#banner-container { position: fixed; top: 65px; left: 0; width: 100%; z-index: 2000; display: flex; justify-content: center; pointer-events: none; }
.banner { padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; min-width: 300px; text-align: center; pointer-events: auto; opacity: 0; transform: translateY(-30px); transition: opacity 0.5s ease, transform 0.5s ease; }
.banner.show { opacity: 1; transform: translateY(0); }
.banner.banner-success { background-color: var(--success-bg); color: var(--success-text); border: 1px solid #c3e6cb; }
.banner.banner-error, .banner.banner-info { background-color: var(--error-bg); color: var(--error-text); border: 1px solid #f5c6cb; }

/* --- Pagination --- */
.pagination-container { margin-top: 0px; display: flex; justify-content: center; }
.pagination { display: flex; list-style: none; padding-left: 0; border-radius: 0.25rem; }
.page-item { margin: 0 2px; }
.page-item.disabled .page-link { color: #6c757d; pointer-events: none; background-color: #fff; border-color: #dee2e6; }
.page-item.active .page-link { z-index: 1; color: #fff; background-color: var(--accent-color); border-color: var(--accent-color); }
.page-link { position: relative; display: block; padding: 0.5rem 0.75rem; line-height: 1.25; color: var(--accent-color); background-color: #fff; border: 1px solid #dee2e6; text-decoration: none; transition: all 0.2s; }
.page-link:hover { color: var(--accent-color-hover); background-color: #e9ecef; border-color: #dee2e6; }

/* =========================================
   MODALS
   ========================================= */
.modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 25px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
    position: relative;
    max-height: 80vh;
    overflow-y: auto;
}
.close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.close-button:hover, .close-button:focus { color: black; text-decoration: none; }
.modal-input { width: 100%; padding: 8px; box-sizing: border-box; margin-top: 5px; }

/* =========================================
   PAGE SPECIFIC STYLES
   ========================================= */

/* --- Production Plan Table Specifics --- */
#production-plan-table th { padding: 8px 10px; text-align: center; }
#production-plan-table td { padding: 2.5px 10px; text-align: center; }

/* --- WIP Tracker --- */
.clickable-cell, .clickable-plan { cursor: pointer; font-weight: 600; color: var(--accent-color); }
.clickable-cell:hover, .clickable-plan:hover { background-color: #e7f5ff; text-decoration: underline; }
.welding-header a, td[data-stage="Full welding"] a { color: var(--accent-color); text-decoration: none; font-weight: 600; }
.welding-header a:hover, td[data-stage="Full welding"] a:hover { text-decoration: underline; }
.row-needs-production { background-color: #e7f5ff !important; }
.cell-fg-ready { background-color: #d4edda !important; font-weight: 600; }

/* Center alignment for WIP Table */
#wip-table th, #wip-table td { text-align: center; vertical-align: middle; }
#wip-table th:nth-child(1), #wip-table td:nth-child(1),
#wip-table th:nth-child(2), #wip-table td:nth-child(2) { text-align: left; }
td { white-space: nowrap; }

/* --- Dashboard --- */
.dashboard-section { margin-top: -20px; margin-bottom: 10px; }
.stage-cards-container {
    display: grid;
    grid-template-columns: repeat(13, minmax(0, 1fr));
    gap: 5px;
    margin-top: 10px;
}
.stage-card {
    background-color: #fff;
    border: 1px solid #000;
    border-radius: 6px;
    padding: 8px 4px;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    text-align: center;
    min-height: 55px;
}
.stage-card .count { font-size: 1.5rem; font-weight: 600; line-height: 1; display: block; width: 100%; }
.stage-card .stage-name { font-size: 0.65rem; text-align: center; white-space: normal; word-break: break-word; line-height: 1.1; }

.dashboard-tables-container, .details-view-wrapper { display: flex; align-items: flex-start; gap: 10px; justify-content: center; }
.dashboard-tables-container .table-wrapper, .details-view-wrapper .table-container { flex-shrink: 0; }
/* Table sizing for Dashboard Overview */
.dashboard-tables-container table, .details-view-wrapper table { font-size: 0.75rem; width: auto; border-collapse: collapse; }
.dashboard-tables-container .table-wrapper:last-child table { font-size: 0.8rem; width: 100%; }
.dashboard-tables-container .table-wrapper:last-child { flex-shrink: 1; min-width: 0; }

.dashboard-tables-container th, .dashboard-tables-container td, .details-view-wrapper th, .details-view-wrapper td {
    padding: 0px 3px; font-size: 0.84rem; text-align: center; white-space: nowrap; border: 1px solid #000; line-height: 0.98;
}
/* Larger padding for small overview tables headers */
.dashboard-tables-container .table-wrapper:last-child th { padding: 8px 10px; white-space: normal; vertical-align: middle; }
.dashboard-tables-container .table-wrapper:last-child td { padding: 7px 10px; white-space: normal; vertical-align: middle; }
.dashboard-tables-container .table-wrapper:last-child th:nth-child(2),
.dashboard-tables-container .table-wrapper:last-child th:nth-child(3),
.dashboard-tables-container .table-wrapper:last-child th:nth-child(4) { max-width: 65px; }

.dashboard-tables-container td.align-left, .details-view-wrapper td.align-left { text-align: left; }
.description-col { max-width: 180px; white-space: normal; }
.total-row td { font-weight: bold; border-top: 2px solid #000; background-color: #f8f9fa; }
.table-title { font-size: 0.9rem; font-weight: 600; padding: 4px; background-color: #e9ecef; }
.dashboard-tables-container thead tr:last-child th, .details-view-wrapper thead tr:last-child th { font-weight: bold; }
.details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 15px; padding-right: 30px; }
.details-header h2 { margin: 0; }
.clickable-row { cursor: pointer; }
.clickable-row:hover { background-color: #e9ecef; }
.selected-row { background-color: #dbeafe !important; font-weight: bold; }
#fullscreen-toggle { position: fixed; top: 75px; right: 30px; cursor: pointer; color: #888; z-index: 1050; }
#fullscreen-toggle:hover { color: #000; }
.details-view-wrapper > div { width: fit-content; margin: 0 auto; }
.stage-cards-container .stage-card:first-child { grid-column: span 1; background-color: #e5e7eb; border: 1px solid #374151; }

/* --- Attendance & Other --- */
.week-nav h3 { margin: 0; }
.input-group { display: flex; align-items: center; }

/* --- Settings / Upload Modal Styles --- */
.upload-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #dee2e6;
}
#settings-modal .upload-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}
#settings-modal .upload-section h2 { font-size: 1.25rem; margin-top: 0; margin-bottom: 10px; }
#settings-modal .upload-section p { font-size: 0.9rem; margin-top: 0; margin-bottom: 10px; }

.upload-status-indicator {
    padding: 8px;
    border-radius: 5px;
    margin-bottom: 10px;
    font-weight: 500;
    font-size: 0.9rem;
}
.upload-status-indicator.success { background-color: #d4edda; color: #155724; }
.upload-status-indicator.warning { background-color: #fff3cd; color: #856404; }

.status-box { padding: 15px; margin-top: 10px; border-radius: 8px; text-align: center; }
.status-box h3 { font-size: 1.1rem; margin: 0 0 5px 0; }
.status-box p { font-size: 0.9rem; margin: 0; }
.status-box form { margin-top: 10px !important; }
.status-box.success { background-color: #d4edda; border: 1px solid #c3e6cb; }

/* Horizontal Upload Forms */
.upload-form-simple { display: flex; align-items: center; gap: 10px; }
.upload-form-simple input[type="file"] { font-size: 0.9rem; }
.upload-form-simple .button { padding: 8px 16px; font-size: 0.9rem; margin: 0; flex-shrink: 0; }

/* --- Center Action Buttons in Tables --- */
td.action-buttons {
    text-align: center;      /* Centers the buttons horizontally */
    vertical-align: middle;  /* Centers them vertically */
}

/* Add a little spacing between the Edit and Delete buttons */
td.action-buttons .button,
td.action-buttons form {
    display: inline-block;
    margin: 0 2px;
}

/* =========================================
   NEW SETTINGS MODAL UI
   ========================================= */

/* Modal Container Override */
.settings-modal-content {
    padding: 0;
    border: none;
    border-radius: 12px;
    background-color: #f8fafc; /* Light gray background for contrast */
    max-width: 550px;
    overflow: hidden;
}

/* Header */
.settings-header {
    background-color: #fff;
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}
.header-text h2 { margin: 0; font-size: 1.25rem; color: #0f172a; font-weight: 700; }
.header-text p { margin: 4px 0 0 0; font-size: 0.85rem; color: #64748b; }
.settings-header .close-button { color: #94a3b8; font-size: 1.5rem; line-height: 1; transition: color 0.2s; }
.settings-header .close-button:hover { color: #ef4444; }

/* Body */
.settings-body { padding: 24px; display: flex; flex-direction: column; gap: 20px; }

/* Cards */
.settings-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    overflow: hidden;
}

.card-header {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    align-items: center;
    gap: 12px;
}

.card-icon {
    width: 40px; height: 40px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}

.card-title { flex-grow: 1; }
.card-title h3 { margin: 0; font-size: 1rem; font-weight: 600; color: #1e293b; }
.card-subtitle { font-size: 0.75rem; color: #64748b; }

/* Status Badges */
.status-badge {
    padding: 4px 10px; border-radius: 20px;
    font-size: 0.75rem; font-weight: 600;
    display: flex; align-items: center; gap: 6px;
}
.status-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
.status-badge.success { background: #dcfce7; color: #166534; }
.status-badge.warning { background: #fff7ed; color: #c2410c; }

.card-content { padding: 16px; }

/* Info Box */
.upload-info {
    padding: 12px; border-radius: 6px; margin-bottom: 16px;
    font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;
}
.upload-info.success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
.upload-info.warning { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; }
.info-text strong { display: block; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 2px; }
.button-ghost { background: transparent; border: 1px solid #fecaca; color: #ef4444; }
.button-ghost:hover { background: #fef2f2; }

/* Modern File Input */
.modern-upload-form { display: flex; gap: 10px; }
.file-input-wrapper { flex-grow: 1; position: relative; height: 36px; }
.file-input-wrapper input[type="file"] {
    position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;
}
.file-label {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 6px;
    display: flex; align-items: center; padding: 0 12px; box-sizing: border-box;
    transition: all 0.2s;
}
.file-input-wrapper input[type="file"]:hover + .file-label { border-color: #94a3b8; background: #f1f5f9; }
.file-cta {
    background: #fff; border: 1px solid #e2e8f0; padding: 2px 8px; border-radius: 4px;
    font-size: 0.75rem; font-weight: 600; color: #475569; margin-right: 10px;
}
.file-name { font-size: 0.85rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.upload-btn { height: 36px; padding: 0 20px; }

/* Master Data specific */
.secondary-card .card-header { background-color: #fafafa; }
.master-actions { display: flex; align-items: center; justify-content: space-between; }

/* Simple Logout Dropdown */
.nav-actions { position: relative; }
.profile-menu { position: relative; }
.profile-dropdown-content {
    display: none;
    position: absolute;
    top: 50px;
    right: 0;
    background-color: #fff;
    min-width: 120px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    z-index: 2000;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    overflow: hidden;
}
.profile-menu:hover + .profile-dropdown-content,
.profile-dropdown-content:hover {
    display: block;
}
.profile-dropdown-content a {
    color: #ef4444;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
}
.profile-dropdown-content a:hover {
    background-color: #fef2f2;
}

/* =========================================
   NAVBAR PROFILE DROPDOWN
   ========================================= */

.profile-dropdown {
    position: relative;
    display: inline-block;
}

/* Trigger Styles */
.profile-menu {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 12px;
    border-radius: 30px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--nav-border);
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}

.profile-menu:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
}

/* Arrow Rotation on Hover */
.dropdown-arrow {
    transition: transform 0.3s ease;
    color: var(--nav-text);
}

.profile-dropdown:hover .dropdown-arrow {
    transform: rotate(180deg);
}

/* Dropdown Content Box */
.dropdown-content {
    display: none; /* Hidden by default */
    position: absolute;
    right: 0;
    top: 110%; /* Just below the trigger */
    background-color: #ffffff;
    min-width: 180px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    z-index: 2000;
    overflow: hidden;
    animation: fadeIn 0.2s ease-out;
}

/* Show on Hover */
.profile-dropdown:hover .dropdown-content {
    display: block;
}

/* Keyframes for smooth appearance */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Dropdown Header (Username/Email) */
.dropdown-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    background-color: #f8fafc;
}

.user-email {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
}

/* Dropdown Links */
.dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    text-decoration: none;
    font-size: 0.9rem;
    color: var(--text-main);
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: #f1f5f9;
}

/* Logout Specific Style */
.logout-item {
    color: #ef4444; /* Red color */
    font-weight: 500;
}

.logout-item:hover {
    background-color: #fef2f2;
}


/* =========================================
   SETTINGS MODAL - SIDE-BY-SIDE LAYOUT
   ========================================= */

/* 1. Make the modal wider to fit two cards */
.settings-modal-content {
    padding: 0;
    border: none;
    border-radius: 12px;
    background-color: #f8fafc;
    max-width: 900px !important; /* Force width increase */
    width: 95%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: 90vh;
}

/* 2. Grid Layout for cards */
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Two equal columns */
    gap: 20px;
    align-items: start;
}

/* 3. Ensure cards take full height */
.settings-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.card-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 16px;
}

/* Responsive: Stack on mobile */
@media (max-width: 768px) {
    .settings-grid {
        grid-template-columns: 1fr;
    }
}

======================================================================
== FILE: static\css\login.css
======================================================================

/* =========================================
   LOGIN PAGE - MODERN PROFESSIONAL UI
   ========================================= */

:root {
    --primary-color: #ea580c;       /* Orange-600 */
    --primary-hover: #c2410c;       /* Orange-700 */
    --text-main: #0f172a;           /* Slate-900 */
    --text-muted: #64748b;          /* Slate-500 */
    --border-color: #e2e8f0;        /* Slate-200 */
    --input-bg: #f8fafc;            /* Slate-50 */
    --bg-gradient-start: #f1f5f9;   /* Slate-100 */
    --bg-gradient-end: #e2e8f0;     /* Slate-200 */
}

body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-main);
}

/* --- Layout Wrapper --- */
.login-wrapper {
    width: 100%;
    padding: 20px;
    display: flex;
    justify-content: center;
}

/* --- The Card --- */
.login-card {
    background: white;
    width: 100%;
    max-width: 400px;
    padding: 40px 35px;
    border-radius: 16px;
    box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.05), 
        0 10px 15px -3px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(0,0,0,0.02); /* Subtle border effect */
    text-align: center;
    transition: transform 0.3s ease;
}

/* --- Header & Logo --- */
.login-header {
    margin-bottom: 30px;
}

.logo-container {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

.logo-img {
    max-height: 100%;
    max-width: 180px;
    object-fit: contain;
}

.login-header h1 {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text-main);
    margin: 0 0 6px 0;
    letter-spacing: -0.025em;
}

.login-header .subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin: 0;
    font-weight: 500;
}

/* --- Inputs --- */
.form-group {
    margin-bottom: 20px;
    text-align: left;
}

.form-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #334155;
    margin-bottom: 8px;
}

.input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.input-icon {
    position: absolute;
    left: 12px;
    color: #94a3b8;
    pointer-events: none;
    transition: color 0.2s;
}

.form-group input {
    width: 100%;
    padding: 12px 12px 12px 40px; /* Space for icon */
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--input-bg);
    font-size: 0.95rem;
    color: var(--text-main);
    transition: all 0.2s ease;
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
}

/* Input Focus State */
.form-group input:focus {
    background-color: #fff;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1); /* Orange Glow */
    outline: none;
}

.form-group input:focus + .input-icon,
.input-wrapper:focus-within .input-icon {
    color: var(--primary-color);
}

/* --- Button --- */
.login-btn {
    width: 100%;
    padding: 12px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.3);
}

.login-btn:hover {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 6px 8px -1px rgba(234, 88, 12, 0.4);
}

.login-btn:active {
    transform: translateY(0);
}

/* --- Alerts --- */
.flash-container {
    margin-bottom: 20px;
}

.alert {
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    text-align: left;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.alert-error {
    background-color: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.alert-info {
    background-color: #eff6ff;
    color: #2563eb;
    border: 1px solid #bfdbfe;
}

/* --- Footer --- */
.login-footer {
    margin-top: 35px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
    color: var(--text-muted);
}

.login-footer p {
    margin: 4px 0;
    font-size: 0.75rem;
}

.version {
    font-family: monospace;
    opacity: 0.7;
}

/* --- Responsive --- */
@media (max-width: 480px) {
    .login-card {
        padding: 30px 20px;
        box-shadow: none;
        background: transparent;
    }
    body {
        background: white;
    }
}

======================================================================
== FILE: static\js\attendance.js
======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. View Toggle Logic (Tracker vs Manage) ---
    const toggleBtn = document.getElementById('toggle-view-btn');
    const toggleBtnText = document.getElementById('toggle-btn-text'); // Target the span
    const attendanceView = document.getElementById('attendance-view');
    const manageView = document.getElementById('manage-view');
    const pageTitle = document.getElementById('page-title');

    // Check URL param on load
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') === 'manage') {
        showManageView();
    } else {
        showTrackerView();
    }

    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            if (attendanceView.style.display === 'none') {
                showTrackerView();
                window.history.pushState({}, '', attendanceConfig.urls.attendanceBase);
            } else {
                showManageView();
            }
        });
    }

    function showTrackerView() {
        if(attendanceView) attendanceView.style.display = 'flex'; // Changed to flex for sticky footer
        if(manageView) manageView.style.display = 'none';
        if(toggleBtnText) toggleBtnText.textContent = 'Manage Employees';
        if(pageTitle) pageTitle.textContent = 'Worker Attendance';
    }

    function showManageView() {
        if(attendanceView) attendanceView.style.display = 'none';
        if(manageView) manageView.style.display = 'flex'; // Changed to flex for sticky footer
        if(toggleBtnText) toggleBtnText.textContent = 'Back to Tracker';
        if(pageTitle) pageTitle.textContent = 'Manage Employees';
    }

    // --- 2. Auto-Saving Attendance Logic ---
    const attendanceTable = document.querySelector('.attendance-table'); // Updated selector
    if (attendanceTable) {
        attendanceTable.addEventListener('change', function(event) {
            const selectElement = event.target;
            if (selectElement.tagName === 'SELECT' && selectElement.name.startsWith('status-')) {
                handleAttendanceChange(selectElement);
            }
        });
    }

    function handleAttendanceChange(selectElement) {
        const nameParts = selectElement.name.split('-');
        const postData = {
            employee_code: nameParts[1],
            date: nameParts.slice(2).join('-'), 
            status: selectElement.value
        };

        // Visual feedback (Yellow)
        selectElement.style.transition = 'background-color 0.2s';
        selectElement.style.backgroundColor = '#fef9c3'; 

        fetch(attendanceConfig.urls.markSingle, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Success feedback (Green)
                selectElement.style.backgroundColor = '#dcfce7'; 
                selectElement.classList.remove('present', 'absent');
                
                if (postData.status.startsWith('Present')) {
                    selectElement.classList.add('present');
                } else if (postData.status === 'Absent') {
                    selectElement.classList.add('absent');
                }

                setTimeout(() => { selectElement.style.backgroundColor = ''; }, 1200);

                // Reload if status changed significantly (updates roster)
                if (postData.status.startsWith('Present') || postData.status === 'Absent' || postData.status === '') {
                     window.location.reload();
                }
            } else {
                alert('Error: ' + data.message);
                selectElement.style.backgroundColor = '#fee2e2'; // Red
            }
        })
        .catch(error => {
            console.error('Error:', error);
            selectElement.style.backgroundColor = '#fee2e2'; 
            alert('Network error saving attendance.');
        });
    }

    // --- 3. Modal Logic (Add Employee) ---
    const addModal = document.getElementById('add-employee-modal');
    const showAddModalBtn = document.getElementById('show-add-modal-btn');
    const addCloseBtn = addModal ? addModal.querySelector('.close-button') : null;

    if (showAddModalBtn && addModal) {
        showAddModalBtn.onclick = function() {
            document.getElementById('add-employee-form').reset();
            addModal.style.display = 'block';
        }
    }
    if (addCloseBtn) addCloseBtn.onclick = () => addModal.style.display = 'none';

    // --- 4. Modal Logic (Edit Employee) ---
    const editModal = document.getElementById('edit-employee-modal');
    const editCloseBtn = editModal ? editModal.querySelector('.close-button') : null;
    
    if (editCloseBtn) editCloseBtn.onclick = () => editModal.style.display = 'none';

    // Close on outside click
    window.onclick = function(event) {
        if (event.target == addModal) addModal.style.display = 'none';
        if (event.target == editModal) editModal.style.display = 'none';
    }
});

// --- 5. Global Function for "Edit" Button ---
window.populateEditModal = function(btn) {
    const editModal = document.getElementById('edit-employee-modal');
    if (!editModal) return;

    // Get data
    const ecode = btn.dataset.ecode;
    const title = btn.dataset.title;
    const name = btn.dataset.name;
    const company = btn.dataset.company;
    const doj = btn.dataset.doj;
    const stage = btn.dataset.stage;

    // Populate fields
    document.getElementById('edit_original_e_code').value = ecode;
    document.getElementById('edit_e_code').value = ecode;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_company').value = company;
    document.getElementById('edit_doj').value = doj;
    
    const titleSelect = document.getElementById('edit_title');
    if(titleSelect) titleSelect.value = title;

    const stageSelect = document.getElementById('edit_stage');
    if(stageSelect) stageSelect.value = stage;

    document.getElementById('edit-modal-title').textContent = `Edit Employee: ${title} ${name}`;
    
    editModal.style.display = 'block';
};

======================================================================
== FILE: static\js\dashboard.js
======================================================================

document.addEventListener('DOMContentLoaded', function() {

    // --- GLOBAL VARIABLES ---
    let currentPage = 1;
    // READ FROM CONFIG OBJECT (Passed from HTML)
    const config = window.dashboardConfig || {};
    const stages = config.stages || [];
    const urls = config.urls || {};

    // DOM Elements
    const failureHeader = document.getElementById('failure-header-toggle');
    const planTableBody = document.getElementById('plan-table-body');
    const verticalTableBody = document.getElementById('vertical-table-body');
    const categoryTableBody = document.getElementById('category-table-body');
    
    // --- UPDATED: Get Filter from Navbar ---
    const typeFilterSelect = document.getElementById('navbar-type-filter');

    // Track selections for row-click filtering
    let currentSelections = {
        item_code: new Set(),
        vertical: new Set(),
        category: new Set()
    };

    // ---------------------------------------------------------
    // 1. DATA FETCHING (Real-Time Polling + Filtering)
    // ---------------------------------------------------------
    function refreshDashboardData() {
        if (!planTableBody) return;

        // Get Global Type Filter Value (Lean/Non Lean)
        const globalType = typeFilterSelect ? typeFilterSelect.value : '';

        // Prepare Filter Payload
        const payload = {
            item_code: Array.from(currentSelections.item_code),
            vertical: Array.from(currentSelections.vertical),
            category: Array.from(currentSelections.category),
            type: globalType ? [globalType] : [] 
        };

        // A. Update Top Cards (WIP & Dispatch)
        fetch(urls.inventoryFiltered, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(payload) 
        })
        .then(r => r.json())
        .then(updateCards)
        .catch(err => console.warn("Card update skipped:", err));

        // B. Update Adherence Cards
        fetch(urls.adherenceFiltered, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(payload) 
        })
        .then(r => r.json())
        .then(updateAdherenceCards)
        .catch(err => console.warn("Adherence update skipped:", err));

        // C. Update Tables (GET Requests)
        let queryParams = `?page=${currentPage}`;
        if (globalType) queryParams += `&type=${encodeURIComponent(globalType)}`;

        // 1. Daily Production Plan Table
        fetch(`${urls.planPage}${queryParams}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    updatePlanTable(data.plans, data.per_page, data.current_page, data.show_failure_button);
                    updatePlanPagination(data.total_pages, data.current_page);
                    attachDragEvents();
                    restoreSelectionHighlights();
                }
            })
            .catch(console.error);

        // 2. Vertical Overview
        const overviewParams = globalType ? `?type=${encodeURIComponent(globalType)}` : '';

        fetch(`${urls.verticalOverview}${overviewParams}`)
            .then(r => r.json())
            .then(data => {
                updateOverviewTable(verticalTableBody, data, 'Vertical', 'vertical');
                renderOverviewChart('verticalChart', data, 'Vertical');
                restoreSelectionHighlights();
            })
            .catch(console.error);

        // 3. Category Overview
        fetch(`${urls.categoryOverview}${overviewParams}`)
            .then(r => r.json())
            .then(data => {
                updateOverviewTable(categoryTableBody, data, 'Category', 'category');
                renderOverviewChart('categoryChart', data, 'Category');
                restoreSelectionHighlights();
            })
            .catch(console.error);
    }

    // --- EVENT LISTENER: Navbar Type Filter ---
    if (typeFilterSelect) {
        typeFilterSelect.addEventListener('change', function() {
            currentPage = 1; 
            refreshDashboardData();
        });
    }

    // ---------------------------------------------------------
    // 2. INTERACTION LOGIC (Clicking Rows)
    // ---------------------------------------------------------

    function handleRowClick(event) {
        if (event.target.closest('a.button, button.reason-btn')) return;

        const row = event.target.closest('tr.clickable-row');
        if (!row) return;

        const filterType = row.dataset.filterType;
        const filterValue = row.dataset.filterValue;
        const isCtrlClick = event.ctrlKey || event.metaKey;

        if (filterType === 'item_code') { currentSelections.vertical.clear(); currentSelections.category.clear(); }
        if (filterType === 'vertical') { currentSelections.item_code.clear(); currentSelections.category.clear(); }
        if (filterType === 'category') { currentSelections.item_code.clear(); currentSelections.vertical.clear(); }

        if (isCtrlClick) {
            if (currentSelections[filterType].has(filterValue)) {
                currentSelections[filterType].delete(filterValue);
            } else {
                currentSelections[filterType].add(filterValue);
            }
        } else {
            const alreadySelected = currentSelections[filterType].has(filterValue) && currentSelections[filterType].size === 1;
            currentSelections[filterType].clear();
            if (!alreadySelected) {
                currentSelections[filterType].add(filterValue);
            }
        }

        restoreSelectionHighlights();
        refreshDashboardData();
    }

    function restoreSelectionHighlights() {
        document.querySelectorAll('tr.clickable-row').forEach(row => {
            const fType = row.dataset.filterType;
            const fVal = row.dataset.filterValue;
            if (currentSelections[fType] && currentSelections[fType].has(fVal)) {
                row.classList.add('selected-row');
            } else {
                row.classList.remove('selected-row');
            }
        });
    }

    if (planTableBody) planTableBody.addEventListener('click', handleRowClick);
    if (verticalTableBody) verticalTableBody.addEventListener('click', handleRowClick);
    if (categoryTableBody) categoryTableBody.addEventListener('click', handleRowClick);


    // ---------------------------------------------------------
    // 3. UI UPDATE FUNCTIONS (Render HTML)
    // ---------------------------------------------------------

// FILE: static/js/dashboard.js

// Find the existing updateCards function and modify it:

    function updateCards(data) {
        if (!data) return;
        let grandTotal = 0;
        
        // Update Standard WIP Stages
        stages.forEach(stage => {
            const count = parseInt(data[stage]) || 0;
            if (stage !== 'FG') grandTotal += count;
            const card = document.querySelector(`.stage-card[data-stage="${stage}"]`);
            if (card) card.querySelector('.count').textContent = count;
        });

        // Update Total Inv Card
        const totalCard = document.querySelector('.stage-card[data-stage="Total-Inv"] .count');
        if (totalCard) totalCard.textContent = grandTotal;
        
        // Update Monthly Dispatch Card
        const dispatchCard = document.querySelector('.stage-card.monthly-dispatch-card .count');
        if (dispatchCard && data['Dispatch'] !== undefined) {
            dispatchCard.textContent = parseInt(data['Dispatch']);
        }

        // --- NEW: Update Monthly Trigger Adherence Card ---
        const monthlyTriggerCard = document.querySelector('.stage-card[data-metric="monthly-trigger-adherence"]');
        if (monthlyTriggerCard && data['MonthlyTriggerAdherence'] !== undefined) {
            let val = parseFloat(data['MonthlyTriggerAdherence']) || 0;
            // Cap at 100% and Floor at 0% for visual sanity
            val = Math.max(0, Math.min(100, val));
            
            const countDiv = monthlyTriggerCard.querySelector('.count');
            countDiv.textContent = val.toFixed(1) + '%';

            // Optional: Dynamic coloring (Purple Scale)
            const hue = 270; // Purple
            const lightness = 95 - (val * 0.15); // Darker as percentage goes up
            monthlyTriggerCard.style.backgroundColor = `hsl(${hue}, 60%, ${Math.max(85, lightness)}%)`;
        }
    }

// FILE: static/js/dashboard.js

// Locate the updateAdherenceCards function and ensure it looks like this:

// FILE: static/js/dashboard.js

// Locate the existing updateAdherenceCards function and update the Monthly section:

    function updateAdherenceCards(data) {
        if (!data) return;

        // 1. Update Daily Adherence
        if (data.daily_adherence !== undefined) {
            updateSingleAdherenceCard('daily-adherence', data.daily_adherence);
        }

        // 2. Update Monthly Trigger Adherence
        if (data.monthly_trigger_adherence !== undefined) {
            const monthlyTriggerCard = document.querySelector('.stage-card[data-metric="monthly-trigger-adherence"]');
            if (monthlyTriggerCard) {
                let val = parseFloat(data.monthly_trigger_adherence) || 0;
                // Cap at 100% and Floor at 0%
                val = Math.max(0, Math.min(100, val));
                
                const countDiv = monthlyTriggerCard.querySelector('.count');
                if (countDiv) countDiv.textContent = val.toFixed(1) + '%';

                // --- CHANGED: Use Red-to-Green Logic (Same as Daily) ---
                // 0% = Hue 0 (Red), 100% = Hue 120 (Green)
                const hue = Math.round(val * 1.2); 
                
                monthlyTriggerCard.style.backgroundColor = `hsl(${hue}, 80%, 85%)`;
                monthlyTriggerCard.style.color = '#333';
            }
        }
    }

    // Cleaned up: Removed Num/Den logic
    function updateSingleAdherenceCard(metric, value) {
        const card = document.querySelector(`.stage-card[data-metric="${metric}"]`);
        if (!card) return;
        
        // 1. Update Percentage
        let percent = parseFloat(value) || 0;
        percent = Math.max(0, Math.min(100, percent));
        const hue = Math.round(percent * 1.2); 
        
        // Update the big number
        const countEl = card.querySelector('.count');
        if (countEl) countEl.textContent = `${percent.toFixed(1)}%`;
        
        // Update Background Color
        card.style.backgroundColor = `hsl(${hue}, 80%, 85%)`;

        // If there was any detail element from before, remove it to be safe
        const detailsEl = card.querySelector('.adherence-details');
        if (detailsEl) detailsEl.remove();
    }

    function updatePlanTable(plans, perPage, curPage, showFailureButton) {
         let html = '';
         if (!plans || plans.length === 0) {
             html = '<tr><td colspan="11" class="placeholder">No plan data available.</td></tr>';
         } else {
             plans.forEach((plan, index) => {
                 const serialNumber = (parseInt(curPage) - 1) * parseInt(perPage) + (index + 1);
                 
                 let percent = parseFloat(plan['ItemAdherencePercent']) || 0;
                 percent = Math.max(0, Math.min(100, percent));
                 const hue = Math.round(percent * 1.2);
                 const adherenceStyle = `background-color: hsl(${hue}, 80%, 85%); color: #333; font-weight: bold;`;
                 
                 const pendingQty = parseInt(plan['Pending']);
                 const pendingStyle = pendingQty > 0 ? `font-weight: bold; color: #d95319;` : `color: #166534;`;

                 let reasonHtml = '';
                 const failureQty = parseInt(plan['FailureInTrigger']);
                 if (failureQty > 0 && showFailureButton) {
                     const reason = plan['SavedReason'] || '';
                     const escapedReason = reason.replace(/"/g, '&quot;');
                     const hasReasonClass = reason ? ' has-reason' : '';
                     reasonHtml = `<button class="button reason-btn${hasReasonClass}"
                                     data-item-code="${plan['Item code ']}"
                                     data-failed-qty="${failureQty}"
                                     data-saved-reason="${escapedReason}"
                                     title="${reason || 'Log Reason'}">
                                     ${failureQty} Fail
                                    </button>`;
                 }

                 html += `
                 <tr class="clickable-row draggable-item" draggable="true"
                     data-item-code="${plan['Item code ']}"
                     data-filter-type="item_code" data-filter-value="${plan['Item code ']}">
                    <td>${serialNumber}</td>
                    <td class="align-left">${plan['Item code ']}</td>
                    <td class="align-left description-col">${plan['Description']}</td>
                    
                    <td style="${adherenceStyle}" title="Adherence: ${percent.toFixed(1)}%">
                        ${parseInt(plan['Opening Trigger'])}
                    </td>

                    <td style="color: #64748b; font-weight: 500;">
                        ${parseInt(plan['Next Pending'] || 0)}
                    </td>
                    
                    <td style="${pendingStyle}">${pendingQty}</td>
                    
                    <td>${parseInt(plan['Dispatch'])}</td>
                    <td>${parseInt(plan['FG'])}</td>
                    <td>${parseInt(plan['Powder coating'])}</td>
                    <td>${parseInt(plan['Hydro Testing'])}</td>
                    <td class="reason-cell">${reasonHtml}</td>
                 </tr>`;
             });
         }
         planTableBody.innerHTML = html;
         if (failureHeader && failureHeader.classList.contains('active')) {
             planTableBody.classList.add('show-failures');
         } else {
             planTableBody.classList.remove('show-failures');
         }
    }

    function updatePlanPagination(totalPages, curPage) {
        const paginationContainer = document.getElementById('plan-pagination');
        if(!paginationContainer) return;
        let html = '<nav aria-label="Page navigation"><ul class="pagination">';
        const prevDisabled = (curPage === 1) ? 'disabled' : '';
        html += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${curPage - 1}">&laquo;</a></li>`;
        for (let i = 1; i <= totalPages; i++) {
            const active = (i === curPage) ? 'active' : '';
            html += `<li class="page-item ${active}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        const nextDisabled = (curPage === totalPages) ? 'disabled' : '';
        html += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${curPage + 1}">&raquo;</a></li>`;
        html += `</ul></nav>`;
        paginationContainer.innerHTML = html;
    }

    function updateOverviewTable(tbody, data, labelKey, type) {
        if (!tbody) return;
        let html = '';
        let totalOpen = 0, totalPend = 0, totalDisp = 0;

        if (!data || data.length === 0) {
            html = '<tr><td colspan="5" class="placeholder">No data available.</td></tr>';
        } else {
            data.forEach(item => {
                let percent = parseFloat(item['AdherencePercent']) || 0;
                percent = Math.max(0, Math.min(100, percent));
                const hue = Math.round(percent * 1.2);
                const cellStyle = `background-color: hsl(${hue}, 80%, 85%); color: #333;`;

                const open = parseInt(item['Opening Trigger'] || 0);
                const pend = parseInt(item['Pending'] || 0);
                const disp = parseInt(item['Dispatch'] || 0);

                totalOpen += open;
                totalPend += pend;
                totalDisp += disp;

                html += `
                <tr class="clickable-row" data-filter-type="${type}" data-filter-value="${item[labelKey]}">
                    <td class="align-left">${item[labelKey]}</td>
                    <td style="${cellStyle}">${open}</td>
                    <td style="font-weight: bold;">${pend}</td>
                    <td>${disp}</td>
                    <td><a href="/dashboard?view=details&type=${type}&value=${encodeURIComponent(item[labelKey])}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                </tr>`;
            });
        }
        tbody.innerHTML = html;

        // Update Footer Totals
        const table = tbody.closest('table');
        if (table) {
            const footer = table.querySelector('tfoot');
            if (footer) {
                footer.innerHTML = `
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td>${totalOpen}</td>
                    <td>${totalPend}</td>
                    <td>${totalDisp}</td>
                    <td></td>
                </tr>`;
            }
        }
    }

    // --- Chart.js Rendering ---
    function renderOverviewChart(canvasId, data, labelKey) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return; 

        const labels = data ? data.map(d => d[labelKey]) : [];
        const pendingData = data ? data.map(d => d['Pending'] || 0) : [];
        const dispatchData = data ? data.map(d => d['Dispatch'] || 0) : [];

        if (window[canvasId + 'Instance']) {
            window[canvasId + 'Instance'].destroy();
        }

        window[canvasId + 'Instance'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Pending',
                        data: pendingData,
                        backgroundColor: '#fbbf24'
                    },
                    {
                        label: 'Dispatch',
                        data: dispatchData,
                        backgroundColor: '#4ade80'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });
    }

    // ---------------------------------------------------------
    // 4. COMMON EVENTS (Pagination, Modal, Drag)
    // ---------------------------------------------------------

    const planPagination = document.getElementById('plan-pagination');
    if (planPagination) {
        planPagination.addEventListener('click', function(e) {
            e.preventDefault();
            const link = e.target.closest('.page-link');
            if (!link || link.parentElement.classList.contains('disabled')) return;
            currentPage = parseInt(link.dataset.page);
            refreshDashboardData();
        });
    }

    if (failureHeader && planTableBody) {
        failureHeader.addEventListener('click', function() {
            planTableBody.classList.toggle('show-failures');
            this.classList.toggle('active');
            this.innerHTML = this.classList.contains('active') ? 'Failure ' : 'Failure ';
        });
    }

    // --- Failure Reason Modal Logic ---
    const reasonModal = document.getElementById('failure-reason-modal');
    const reasonForm = document.getElementById('failure-reason-form');
    const reasonSelect = document.getElementById('reason-modal-select');
    const reasonModalItemCodeHidden = document.getElementById('reason-modal-item-code-hidden');
    const reasonModalFailedQtyHidden = document.getElementById('reason-modal-failed-qty-hidden');
    const reasonModalCloseBtn = reasonModal ? reasonModal.querySelector('.close-button') : null;
    const reasonModalClearBtn = document.getElementById('reason-modal-clear-btn');

    if (planTableBody) {
        planTableBody.addEventListener('click', function(event) {
            const button = event.target.closest('button.reason-btn');
            if (button) {
                document.getElementById('reason-modal-item-code').textContent = button.dataset.itemCode;
                document.getElementById('reason-modal-failed-qty').textContent = button.dataset.failedQty;
                reasonModalItemCodeHidden.value = button.dataset.itemCode;
                reasonModalFailedQtyHidden.value = button.dataset.failedQty;
                reasonSelect.value = button.dataset.savedReason.replace(/&quot;/g, '"');
                if(reasonModal) reasonModal.style.display = 'block';
            }
        });
    }

    if (reasonForm) {
        reasonForm.addEventListener('submit', function(event) { event.preventDefault(); saveReason(reasonSelect.value); });
    }
    if (reasonModalClearBtn) {
        reasonModalClearBtn.addEventListener('click', function() { saveReason(""); });
    }

    function saveReason(reasonValue) {
        const postData = {
            item_code: reasonModalItemCodeHidden.value,
            failed_quantity: parseInt(reasonModalFailedQtyHidden.value),
            reason: reasonValue
        };
        fetch(urls.logFailureReason, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(postData)
        }).then(r => r.json()).then(data => {
            if (data.status === 'success') {
                if(reasonModal) reasonModal.style.display = 'none';
                refreshDashboardData();
            } else { alert(data.message); }
        });
    }

    if(reasonModalCloseBtn) reasonModalCloseBtn.onclick = () => reasonModal.style.display = 'none';
    window.onclick = (e) => { if(e.target == reasonModal) reasonModal.style.display = 'none'; };

    // --- Drag & Drop Logic ---
    let draggedItemCode = null;
    function attachDragEvents() {
        document.querySelectorAll('.draggable-item').forEach(draggable => {
            draggable.addEventListener('dragstart', (e) => {
                draggedItemCode = draggable.getAttribute('data-item-code');
                draggable.classList.add('dragging');
                e.dataTransfer.effectAllowed = "move";
            });
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
                draggedItemCode = null;
            });
        });
    }

    function attachDropEvents() {
        document.querySelectorAll('.drop-target').forEach(target => {
            target.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
            target.addEventListener('dragleave', (e) => { e.currentTarget.classList.remove('drag-over'); });
            target.addEventListener('drop', handleDrop);
        });
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!draggedItemCode) return;
        let toStage = e.currentTarget.getAttribute('data-stage');
        if (e.currentTarget.classList.contains('monthly-dispatch-card')) toStage = 'Dispatch';
        
        const qty = prompt(`Moving ${draggedItemCode} to ${toStage}. Quantity:`, "1");
        if (qty && parseInt(qty) > 0) {
            const url = (toStage === 'Dispatch') ? urls.dispatchItem : urls.moveItem;
            const formData = new FormData();
            formData.append('item_code', draggedItemCode);
            formData.append('quantity', qty);
            if(toStage !== 'Dispatch') {
                formData.append('from_stage', 'FG');
                formData.append('to_stage', toStage);
            }
            fetch(url, { method: 'POST', body: formData }).then(() => refreshDashboardData());
        }
    }

    attachDropEvents();

    const fullscreenToggle = document.getElementById('fullscreen-toggle');
    if (fullscreenToggle) {
        const enterIcon = document.getElementById('fullscreen-enter-icon');
        const exitIcon = document.getElementById('fullscreen-exit-icon');
        fullscreenToggle.addEventListener('click', () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => alert(err));
            else if (document.exitFullscreen) document.exitFullscreen();
        });
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) { enterIcon.style.display = 'none'; exitIcon.style.display = 'block'; }
            else { enterIcon.style.display = 'block'; exitIcon.style.display = 'none'; }
        });
    }

    // Init & Poll (Set to 10 seconds to avoid choking DB)
    refreshDashboardData();
    if (planTableBody) setInterval(refreshDashboardData, 10000); 
});

======================================================================
== FILE: static\js\layout.js
======================================================================

document.addEventListener('DOMContentLoaded', function () {
    // --- 1. Flash Banner Logic ---
    const banners = document.querySelectorAll('.banner');
    banners.forEach((banner, index) => {
        setTimeout(() => { banner.classList.add('show'); }, 100);
        setTimeout(() => {
            banner.classList.remove('show');
            setTimeout(() => { banner.remove(); }, 600);
        }, 5000);
    });

    // --- 2. Sidebar Logic ---
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const body = document.body;

    function toggleSidebar() {
        body.classList.toggle('sb-open');
    }

    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }

    // --- 3. Settings Modal Logic ---
    const settingsModal = document.getElementById('settings-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const sidebarSettingsBtn = document.getElementById('sidebar-settings-btn');

    const openSettings = function(e) {
        e.preventDefault();
        settingsModal.style.display = 'block';
        if (body.classList.contains('sb-open')) {
            toggleSidebar(); // Close sidebar if open
        }
    };

    if (settingsModal) {
        const settingsCloseBtn = settingsModal.querySelector('.close-button');

        if (settingsBtn) settingsBtn.addEventListener('click', openSettings);
        if (sidebarSettingsBtn) sidebarSettingsBtn.addEventListener('click', openSettings);

        if (settingsCloseBtn) {
            settingsCloseBtn.onclick = function() {
                settingsModal.style.display = 'none';
            }
        }

        window.addEventListener('click', function(event) {
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
    }
});

// --- 4. File Input Helper (Global) ---
function updateFileName(input) {
    if (input.files && input.files.length > 0) {
        const label = input.nextElementSibling; // The <label> after the <input>
        const nameSpan = label.querySelector('.file-name');
        if (nameSpan) {
            nameSpan.textContent = input.files[0].name;
            nameSpan.style.color = '#0f172a'; // Darker text for visibility
        }
    }
}

======================================================================
== FILE: static\js\items.js
======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. Safely Load Stages from Python Config ---
    const allStages = window.itemsConfig ? window.itemsConfig.stages : [];

    // --- 2. Modal Logic ---
    const addModal = document.getElementById('add-item-modal');
    const editModal = document.getElementById('edit-item-modal');
    const wipModal = document.getElementById('wip-modal');
    const addBtn = document.getElementById('show-add-modal-btn');

    // Safe Event Listeners
    if (addBtn && addModal) {
        addBtn.onclick = () => addModal.style.display = "block";
    }

    document.querySelectorAll('.close-button').forEach(btn => {
        btn.onclick = function() {
            const modal = this.closest('.modal');
            if (modal) modal.style.display = "none";
        }
    });

    window.onclick = (event) => {
        if (addModal && event.target == addModal) addModal.style.display = "none";
        if (editModal && event.target == editModal) editModal.style.display = "none";
        if (wipModal && event.target == wipModal) wipModal.style.display = "none";
    }

    // --- 3. Edit Info Modal (Global Function) ---
    // Attached to window so onclick="..." in HTML can find it
    window.openEditModal = function(btn) {
        if (!editModal) return;

        // Set the original item code (hidden field)
        const hiddenInput = document.getElementById('edit_original_code');
        if (hiddenInput) hiddenInput.value = btn.dataset.code;

        // Helper function to safely set values
        const setValue = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.value = val || '';
        };

        setValue('edit_code', btn.dataset.code);
        setValue('edit_desc', btn.dataset.desc);
        setValue('edit_vert', btn.dataset.vert);
        setValue('edit_cat', btn.dataset.cat);
        setValue('edit_type', btn.dataset.type);
        setValue('edit_model', btn.dataset.model);
        setValue('edit_monthly', btn.dataset.monthly);
        setValue('edit_daily', btn.dataset.daily);
        setValue('edit_maxinv', btn.dataset.maxinv);
        setValue('edit_rpl', btn.dataset.rpl);

        editModal.style.display = "block";
    }

    // --- 4. WIP Edit Modal (Global Function) ---
    window.openWipModal = function(btn) {
        if (!wipModal) return;

        // Set hidden item code
        const hiddenInput = document.getElementById('wip_original_code');
        if (hiddenInput) hiddenInput.value = btn.dataset.code;

        // Set Title text
        const subtitle = document.getElementById('wip-modal-subtitle');
        if (subtitle) subtitle.textContent = `Item: ${btn.dataset.code} - ${btn.dataset.desc}`;

        // Dynamic Stage Population
        allStages.forEach(stageName => {
            // Match the ID format used in HTML generation (spaces replaced by underscores)
            const stageKey = stageName.replace(/ /g, '_');
            const inputId = 'stage_input_' + stageKey;
            const el = document.getElementById(inputId);

            // Construct the data attribute name (e.g. data-stage-Long_seam)
            // Note: HTML data attributes are automatically lowercased by the browser
            // So data-stage-Long_seam becomes dataset.stageLong_seam (camelCase) or accessible via getAttribute
            const attrName = 'data-stage-' + stageKey;
            const val = btn.getAttribute(attrName);

            if (el) {
                el.value = val || 0;
            }
        });

        wipModal.style.display = "block";
    }
});

======================================================================
== FILE: static\js\productionpl.js
======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. Client-Side Filtering Logic ---

    window.filterTable = function() {
        const searchInput = document.getElementById('filter-search');
        // Get dropdowns if they exist, otherwise null
        const verticalSelect = document.getElementById('filter-vertical');
        const categorySelect = document.getElementById('filter-category');
        // Check navbar type filter if page specific one is missing
        const typeSelect = document.getElementById('filter-type') || document.getElementById('navbar-type-filter');

        if (!searchInput) return;

        const search = searchInput.value.toLowerCase();
        const vertical = verticalSelect ? verticalSelect.value : '';
        const category = categorySelect ? categorySelect.value : '';
        const type = typeSelect ? typeSelect.value : '';

        const rows = document.querySelectorAll('.plan-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const rCode = (row.dataset.code || '').toLowerCase();
            const rDesc = (row.dataset.desc || '').toLowerCase();
            const rVert = row.dataset.vertical || '';
            const rCat = row.dataset.category || '';
            const rType = row.dataset.type || '';

            // Logic: If filter is empty, it's a match. Otherwise, check exact match (or includes for search)
            const matchSearch = (!search || rCode.includes(search) || rDesc.includes(search));
            const matchVert = (!vertical || rVert === vertical);
            const matchCat = (!category || rCat === category);
            const matchType = (!type || rType === type);

            if (matchSearch && matchVert && matchCat && matchType) {
                row.style.display = '';
                visibleCount++;
                // Update S.No for filtered view
                const snoCell = row.querySelector('.sno-cell');
                if (snoCell) snoCell.textContent = visibleCount;
            } else {
                row.style.display = 'none';
            }
        });

        // Show/Hide "No Results" message
        const noResults = document.getElementById('no-results-msg');
        if (noResults) {
            noResults.style.display = (visibleCount === 0) ? 'block' : 'none';
        }
    };

    window.clearFilters = function() {
        const ids = ['filter-search', 'filter-vertical', 'filter-category', 'filter-type'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        filterTable(); // Re-run to show all
    };

    // --- 2. Plan Update Listener (AJAX) ---
    const planInputs = document.querySelectorAll('.plan-input');

    planInputs.forEach(input => {
        input.addEventListener('change', function(e) {
            const itemCode = this.name.replace('modified_plan_', '');
            const newPlanValue = this.value;

            // Visual feedback: Processing (Orange)
            this.style.borderColor = '#fdba74'; 
            this.style.backgroundColor = '#fff7ed';

            const postData = { item_code: itemCode, new_plan_value: newPlanValue };

            // Use the URL from the config object
            fetch(productionConfig.urls.updateSinglePlan, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(postData)
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.status === 'success') {
                    // Success feedback: Green
                    this.style.borderColor = '#4ade80'; 
                    this.style.backgroundColor = '#f0fdf4';
                    
                    // Revert style after 1 second
                    setTimeout(() => {
                        this.style.borderColor = '';
                        this.style.backgroundColor = '';
                    }, 1000);
                } else {
                    // Error feedback: Red
                    this.style.borderColor = '#f87171'; 
                    this.style.backgroundColor = '#fef2f2';
                    alert('Error saving changes: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                this.style.borderColor = '#f87171';
                alert('Network error.');
                console.error(error);
            });
        });
    });
});

======================================================================
== FILE: static\js\stages.js
======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. Modal Logic ---
    const addModal = document.getElementById('add-stage-modal');
    const editModal = document.getElementById('edit-stage-modal');
    const addBtn = document.getElementById('show-add-modal-btn');

    // Specific close buttons
    const closeAddBtn = document.getElementById('close-add-modal');
    const closeEditBtn = document.getElementById('close-edit-modal');

    // Open Add Modal
    if (addBtn) {
        addBtn.addEventListener('click', function() {
            addModal.style.display = "block";
        });
    }

    // Close Logic
    if (closeAddBtn) {
        closeAddBtn.onclick = () => addModal.style.display = "none";
    }
    if (closeEditBtn) {
        closeEditBtn.onclick = () => editModal.style.display = "none";
    }

    // Close on outside click
    window.onclick = function(event) {
        if (event.target == addModal) addModal.style.display = "none";
        if (event.target == editModal) editModal.style.display = "none";
    }

    // --- 2. Global Edit Function ---
    window.openEditModal = function(id, name, isDashboard) {
        document.getElementById('edit_stage_id').value = id;
        document.getElementById('edit_original_name').value = name;
        document.getElementById('edit_stage_name').value = name;

        const chk = document.getElementById('edit_include_dashboard');
        if (isDashboard == 'True' || isDashboard == '1' || isDashboard === true) {
            chk.checked = true;
        } else {
            chk.checked = false;
        }

        editModal.style.display = "block";
    }

    // --- 3. Drag and Drop Logic (Fixed) ---
    const tbody = document.getElementById('sortable-rows');
    let draggedRow = null;

    if (tbody) {
        tbody.addEventListener('dragstart', function(e) {
            // FIX: Explicitly prevent dragging if row is not marked draggable
            if (!e.target.classList.contains('draggable-row')) {
                e.preventDefault();
                return false;
            }

            draggedRow = e.target;
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML); 
        });

        tbody.addEventListener('dragend', function(e) {
            if(e.target) e.target.style.opacity = '';
            saveNewOrder();
        });

        tbody.addEventListener('dragover', function(e) {
            e.preventDefault();
            
            const afterElement = getDragAfterElement(tbody, e.clientY);
            
            // FIX: Find the "FG" row (last locked row) to prevent dropping below it
            // We assume FG is the last row with class 'locked-row' usually
            const lockedRows = [...tbody.querySelectorAll('.locked-row')];
            const fgRow = lockedRows.length > 0 ? lockedRows[lockedRows.length - 1] : null;

            if (afterElement == null) {
                // If dragging to bottom, ensure we insert BEFORE FG, not append after
                if (fgRow) {
                    tbody.insertBefore(draggedRow, fgRow);
                } else {
                    tbody.appendChild(draggedRow);
                }
            } else {
                tbody.insertBefore(draggedRow, afterElement);
            }
        });
    }

    function getDragAfterElement(container, y) {
        // Only consider draggable rows for calculation, ignoring headers or locked rows
        const draggableElements = [...container.querySelectorAll('.draggable-row:not([style*="opacity: 0.5"])')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function saveNewOrder() {
        // Select ALL rows (draggable + locked) to get the true full order
        // This ensures the DB gets the correct index for every item
        const rows = document.querySelectorAll('#sortable-rows tr');
        const orderIds = Array.from(rows).map(row => row.getAttribute('data-id')).filter(id => id); // Filter out nulls

        fetch(stagesConfig.urls.reorderStages, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ order: orderIds })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                // Update S.No visuals immediately
                document.querySelectorAll('#sortable-rows tr').forEach((row, index) => {
                    const snoCell = row.querySelector('.sno-cell');
                    if(snoCell) snoCell.textContent = index + 1;
                });
            } else {
                console.error('Save order failed', data);
            }
        })
        .catch(err => console.error('Error saving order:', err));
    }
});

======================================================================
== FILE: static\js\wip.js
======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. CONFIGURATION ---
    const config = window.wipConfig || {};
    const allStages = config.stages || [];
    const groupStages = config.groupStages || [];
    
    // --- 2. MODAL LOGIC ---
    const actionModal = document.getElementById('action-modal');
    
    // Click logic for table cells
    document.querySelectorAll('.clickable-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            const itemCode = this.dataset.itemCode;
            const stage = this.dataset.stage;
            const quantity = parseInt(this.dataset.quantity);
            // Get breakdown if available (for grouped columns)
            const breakdown = this.dataset.breakdown ? JSON.parse(this.dataset.breakdown) : null;

            openActionModal(itemCode, stage, quantity, breakdown);
        });
    });

    function openActionModal(itemCode, stage, quantity, breakdown) {
        // Update Title & Subtitle
        document.getElementById('action-modal-title').textContent = `Actions for ${itemCode}`;
        document.getElementById('action-modal-subtitle').textContent = `${stage} | Available: ${quantity}`;

        // --- 1. Setup Move Form ---
        const moveForm = document.getElementById('move-form');
        const dispatchForm = document.getElementById('dispatch-form');
        
        const sourceDisplay = document.getElementById('source-stage-display');
        const sourceHidden = document.getElementById('source-stage-hidden');

        if (stage === 'FG') {
            // IF FG: Hide Move, Show Dispatch
            moveForm.style.display = 'none';
            dispatchForm.style.display = 'block';

            // Setup Dispatch Inputs
            document.getElementById('dispatch-item-code').value = itemCode;
            document.getElementById('dispatch-quantity').max = quantity;
            document.getElementById('dispatch-quantity').value = 1;
        } else {
            // IF NORMAL STAGE: Show Move, Hide Dispatch
            moveForm.style.display = 'block';
            dispatchForm.style.display = 'none';

            // Setup Item Code & Source Display
            document.getElementById('move-item-code').value = itemCode;
            sourceDisplay.value = stage; // User sees "Before Hydro"
            
            // --- AUTO-SELECT SOURCE LOGIC ---
            if (stage === 'Before Hydro' && breakdown) {
                // We need to deduct from a real column in the DB.
                // We pick the LATEST stage in the group that has stock.
                let bestSource = null;
                let maxQty = 0;

                // Iterate group in reverse to find the "furthest" item
                const reversedGroup = [...groupStages].reverse();
                for (const s of reversedGroup) {
                    if (breakdown[s] && breakdown[s] > 0) {
                        bestSource = s;
                        maxQty = breakdown[s];
                        break; 
                    }
                }

                if (bestSource) {
                    sourceHidden.value = bestSource; // Send real DB name (e.g. "Full welding")
                    document.getElementById('move-quantity').max = maxQty;
                    document.getElementById('move-quantity').value = 1;
                } else {
                    // Fallback (shouldn't happen if total > 0)
                    sourceHidden.value = stage;
                    document.getElementById('move-quantity').max = quantity;
                }
            } else {
                // Standard Single Stage
                sourceHidden.value = stage;
                document.getElementById('move-quantity').max = quantity;
                document.getElementById('move-quantity').value = 1;
            }

            // --- DESTINATION STAGE LOGIC (Allow Previous Stages) ---
            const destSelect = document.getElementById('dest-stage');
            destSelect.innerHTML = '';

            // Add ALL stages except the current one
            allStages.forEach(s => {
                if (s !== stage) {
                    const option = new Option(s, s);
                    destSelect.add(option);
                }
            });

            // Attempt to Auto-select the NEXT logical stage for convenience
            const currentIndex = allStages.indexOf(stage);
            if (currentIndex >= 0 && currentIndex < allStages.length - 1) {
                // Select the next one in the list
                destSelect.value = allStages[currentIndex + 1];
            } else if (destSelect.options.length > 0) {
                // Fallback to first option
                destSelect.selectedIndex = 0;
            }
        }

        // --- 2. Setup Flag Form (Always available) ---
        document.getElementById('flag-item-code').value = itemCode;
        document.getElementById('flag-stage').value = stage; 
        document.getElementById('flag-quantity').max = quantity;
        document.getElementById('flag-quantity').value = 1;
        document.getElementById('flag-remark').value = '';

        // Show Modal
        if (actionModal) actionModal.style.display = "block";
    }

    // --- 3. AJAX SUBMISSIONS ---

    // Move Form
    const moveForm = document.getElementById('move-form');
    if (moveForm) {
        moveForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const data = {
                item_code: document.getElementById('move-item-code').value,
                source_stage: document.getElementById('source-stage-hidden').value, // Real DB Column
                dest_stage: document.getElementById('dest-stage').value,
                quantity: document.getElementById('move-quantity').value
            };

            fetch(config.urls.moveItem, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
            });
        });
    }

    // Flag Form
    const flagForm = document.getElementById('flag-form');
    if (flagForm) {
        flagForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                item_code: document.getElementById('flag-item-code').value,
                stage: document.getElementById('flag-stage').value,
                quantity: document.getElementById('flag-quantity').value,
                remark: document.getElementById('flag-remark').value
            };
            fetch(config.urls.flagItem, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    document.getElementById('action-modal').style.display = "none";
                    alert("Issue logged.");
                    window.location.reload();
                } else { alert('Error: ' + result.message); }
            })
            .catch(error => { console.error('Error:', error); alert('An unexpected error occurred.'); });
        });
    }

    // Dispatch Form
    const dispatchForm = document.getElementById('dispatch-form');
    if (dispatchForm) {
        dispatchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(config.urls.dispatchItem, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') { window.location.reload(); } 
                else { alert('Error: ' + result.message); }
            })
            .catch(error => { console.error('Error:', error); alert('An unexpected error occurred.'); });
        });
    }

    // --- 4. CLOSE LOGIC ---
    document.querySelectorAll('.close-button').forEach(btn => {
        btn.onclick = () => { if(actionModal) actionModal.style.display = "none"; }
    });
    window.onclick = (e) => {
        if(e.target == actionModal) actionModal.style.display = "none";
    }
});

======================================================================
== FILE: static\js\script.js
======================================================================



