{% extends "layout.html" %}

{% block title %}WIP Tracker{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wip.css') }}">

<div class="page-container">
    
    <div class="content-card">
        {# --- Unified Header & Toolbar --- #}
        <div class="filter-toolbar">
            <h1 class="toolbar-title">WIP Tracker</h1>

            <form action="{{ url_for('wip_tracking') }}" method="GET" class="toolbar-actions">
                
                <input type="search" name="search" placeholder="Search..." value="{{ search_query }}" class="filter-input">

                <select name="type" onchange="this.form.submit()" class="filter-select">
                    <option value="">Type: All</option>
                    {% for t in type_options %}
                        <option value="{{ t }}" {% if selected_type == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                </select>

                <select name="category" onchange="this.form.submit()" class="filter-select">
                    <option value="">Category: All</option>
                    {% for c in category_options %}
                        <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>

                {# --- Typeable Rows Per Page --- #}
                <div style="display: flex; align-items: center; border: 1px solid var(--border-light); border-radius: 6px; background: var(--bg-subtle); padding-right: 10px; height: 32px; transition: border-color 0.2s;">
                    <input type="number" 
                           name="per_page" 
                           value="{{ current_per_page }}" 
                           min="1" 
                           max="1000" 
                           onchange="this.form.submit()" 
                           style="border: none; background: transparent; width: 50px; padding-left: 10px; text-align: center; height: 100%; outline: none; font-size: 0.8rem; color: var(--text-main); font-weight: 600;"
                           title="Type number of rows and press Enter"
                    >
                    <span style="font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; border-left: 1px solid var(--border-light); padding-left: 8px; margin-left: 0px; line-height: 1;">Rows</span>
                </div>

                {% if search_query or selected_type or selected_category or current_per_page != 20 %}
                    <a href="{{ url_for('wip_tracking') }}" class="button button-secondary">Reset</a>
                {% else %}
                    <button type="submit" class="button button-secondary">Search</button>
                {% endif %}
            </form>
        </div>

        {# --- Table --- #}
        <div class="table-wrapper">
            <table id="wip-table" class="modern-table">
                <thead>
                    <tr>
                        <th class="col-center" style="width: 50px;">#</th>
                        <th class="col-left" style="width: 120px;">Item Code</th>
                        <th class="col-left">Description</th>
                        <th class="col-center bg-highlight">Total Inv</th>
                        {% for stage in stages %}
                            {# Highlight Header if Not Started #}
                            <th class="col-center {% if stage == 'Not Started' %}bg-not-started-header{% endif %}">{{ stage }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in master_items %}
                    <tr data-item-code="{{ item['Item code'] }}">
                        <td class="col-center" style="color: var(--text-muted);">{{ pagination.per_page * (pagination.page - 1) + loop.index }}</td>
                        
                        <td class="col-code">{{ item['Item code'] }}</td>
                        <td class="col-desc" title="{{ item['Description'] }}">{{ item['Description'] }}</td>

                        <td class="col-center bg-highlight">
                            {{ item['Total Inv'] }}
                        </td>

                        {% for stage in stages %}
                            {% set quantity = item.get(stage, 0) %}
                            
                            {# Special handling for the Grouped Column #}
                            {% if stage == 'Before Hydro' %}
                                <td class="col-center stage-qty clickable-cell {{ 'quantity-active' if quantity > 0 else 'quantity-zero' }}"
                                    data-stage="Before Hydro"
                                    data-item-code="{{ item['Item code'] }}"
                                    data-quantity="{{ quantity }}"
                                    data-breakdown="{{ item['Before_Hydro_Breakdown'] }}">
                                    {% if quantity > 0 %}{{ quantity }}{% else %}<span style="color: #cbd5e1;">-</span>{% endif %}
                                </td>
                            {% else %}
                                {# Standard Stage Rendering #}
                                <td class="col-center stage-qty {% if stage == 'Not Started' %}bg-not-started-cell{% endif %} {{ 'quantity-active' if quantity > 0 else 'quantity-zero' }} {{ 'clickable-cell' if quantity > 0 }}"
                                    data-stage="{{ stage }}"
                                    data-item-code="{{ item['Item code'] }}"
                                    data-quantity="{{ quantity }}">
                                    {% if quantity > 0 %}{{ quantity }}{% else %}<span style="color: #cbd5e1;">-</span>{% endif %}
                                </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% else %}
                    <tr><td colspan="{{ 4 + stages|length }}" style="text-align: center; padding: 40px; color: var(--text-muted);">No items found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# --- Pagination --- #}
        {% if pagination and pagination.total_pages > 1 %}
        <div class="pagination-container">
            <ul class="pagination">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('wip_tracking', page=pagination.prev_num, search=search_query, type=selected_type, category=selected_category, per_page=pagination.per_page) }}">&laquo; Prev</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link" style="border: none;">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
                </li>
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('wip_tracking', page=pagination.next_num, search=search_query, type=selected_type, category=selected_category, per_page=pagination.per_page) }}">Next &raquo;</a>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

{# --- Enhanced Action Modal --- #}
<div id="action-modal" class="modal">
    <div class="modal-content action-modal-content">
        
        {# --- Header Section --- #}
        <div class="modal-header">
            <h3 id="action-modal-title">Manage Item</h3>
            <span class="close-button">&times;</span>
        </div>
        
        {# --- Context Info Bar --- #}
        <div id="action-modal-subtitle" class="modal-context-bar"></div>

        <div class="modal-body">
            
            {# --- SECTION 1: PRIMARY ACTION (Move / Dispatch) --- #}
            <div class="action-section">
                
                {# Move Form #}
                <form id="move-form">
                    <input type="hidden" id="move-item-code" name="item_code">
                    <input type="hidden" id="source-stage-hidden" name="source_stage">

                    <div class="form-grid" style="display: flex; flex-direction: column; gap: 15px;">
                        
                        {# Row 1: Source & Quantity #}
                        <div style="display: flex; gap: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="modal-label">Move From</label>
                                <input type="text" id="source-stage-display" class="modal-input" readonly style="background-color: #f1f5f9; color: #64748b; font-weight: 600;">
                            </div>
                            <div class="form-group" style="width: 100px;">
                                <label class="modal-label">Quantity</label>
                                <input type="number" id="move-quantity" name="quantity" min="1" required class="modal-input font-bold" style="text-align: center;">
                            </div>
                        </div>

                        {# Row 2: Destination #}
                        <div class="form-group">
                            <label class="modal-label">Destination (Move To)</label>
                            <div class="select-wrapper">
                                <select id="dest-stage" name="dest_stage" required class="modal-input" style="border-color: #3b82f6; background-color: #eff6ff;">
                                    </select>
                            </div>
                        </div>

                    </div>

                    <button type="submit" class="button btn-action-primary" style="margin-top: 20px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        Confirm Move
                    </button>
                </form>

                {# Dispatch Form #}
                <form id="dispatch-form" action="{{ url_for('dispatch_item') }}" method="POST" style="display:none;">
                    <input type="hidden" id="dispatch-item-code" name="item_code">
                    
                    <div class="form-group">
                        <label class="modal-label">Quantity to Dispatch</label>
                        <input type="number" id="dispatch-quantity" name="quantity" min="1" required class="modal-input font-bold">
                    </div>
                    <button type="submit" class="button btn-action-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Confirm Dispatch
                    </button>
                </form>
            </div>

            {# --- SECTION 2: SECONDARY ACTION (Report Issue) --- #}
            <div class="issue-section">
                <div class="issue-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Report Issue / Scrap
                </div>
                <form id="flag-form">
                    <input type="hidden" id="flag-item-code" name="item_code">
                    <input type="hidden" id="flag-stage" name="stage">

                    <div class="form-grid" style="display: flex; gap: 10px;">
                        <div class="form-group" style="width: 80px;">
                            <label class="modal-label">Qty</label>
                            <input type="number" id="flag-quantity" name="quantity" min="1" required class="modal-input">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="modal-label">Reason</label>
                            <input type="text" id="flag-remark" name="remark" required class="modal-input" placeholder="e.g. Damaged, Rework">
                        </div>
                    </div>
                    <button type="submit" class="button btn-action-warning" style="margin-top: 10px;">Log Issue</button>
                </form>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.wipConfig = {
        stages: {{ stages|tojson }},
        groupStages: {{ group_stages|tojson }},
        urls: {
            moveItem: "{{ url_for('move_item') }}",
            flagItem: "{{ url_for('flag_item') }}",
            dispatchItem: "{{ url_for('dispatch_item') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/wip.js') }}"></script>
{% endblock %}