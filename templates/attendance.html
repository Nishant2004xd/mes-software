{% extends "layout.html" %}

{% block title %}Worker Attendance{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/attendance.css') }}">

<div class="page-container">
    <div class="content-card">
        
        {# --- Header --- #}
        <div class="attendance-header">
            <h1 id="page-title">Worker Attendance</h1>
            <div class="header-actions">
                <button id="toggle-view-btn" class="button button-secondary">
                    {# Users Icon #}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    {# Text Span #}
                    <span id="toggle-btn-text">Manage Employees</span>
                </button>
                <a href="{{ url_for('export_attendance') }}" class="button button-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span>Export</span>
                </a>
            </div>
        </div>

        {# --- VIEW 1: TRACKER --- #}
        <div id="attendance-view" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            
            {# Toolbar #}
            <div class="controls-toolbar">
                
                {# Left: Week Navigation #}
                <div class="week-nav">
                    <a href="{{ url_for('attendance', start_date=prev_week_start, stage=selected_stage) }}" class="nav-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </a>
                    <div class="week-display">{{ current_week_str }}</div>
                    <a href="{{ url_for('attendance', start_date=next_week_start, stage=selected_stage) }}" class="nav-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </a>
                </div>

                {# Right: Filters & Actions #}
                <div class="controls-right">
                    
                    {# Filter Stage #}
                    <div class="control-item">
                        <span class="control-label">Filter</span>
                        <form method="GET" action="{{ url_for('attendance') }}" style="margin:0;">
                            <select name="stage" class="compact-select" onchange="this.form.submit()">
                                <option value="All" {% if selected_stage == 'All' %}selected{% endif %}>All Stages</option>
                                {% for stage in stage_filter_list %}
                                    <option value="{{ stage }}" {% if selected_stage == stage %}selected{% endif %}>{{ stage }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    {# Mark Holiday #}
                    <form action="{{ url_for('add_holiday') }}" method="POST" style="margin:0;">
                        <input type="hidden" name="start_date" value="{{ week_days[0].strftime('%Y-%m-%d') }}">
                        <div class="control-item" style="padding-right: 4px;">
                            <span class="control-label">Holiday</span>
                            <input type="date" name="holiday_date" required class="compact-date">
                            <button type="submit" class="icon-btn" title="Add Holiday">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </form>

                </div>
            </div>

            {# Grid #}
            <div class="grid-container">
                <form id="attendance-form">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Employee Name</th>
                                <th style="width: 150px; padding-left: 10px;">Default Stage</th>
                                {% for day in week_days %}
                                    {% set day_type = holidays.get(day) %}
                                    <th class="{% if day_type == 'Holiday' %}holiday{% elif day_type == 'Working Day' %}working-day-override{% elif is_weekend %}weekend{% endif %}">
                                        <div class="date-header-content">
                                            <span class="dh-day">{{ day.strftime('%a') }}</span>
                                            <span class="dh-date">{{ day.day }}</span>
                                        </div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr>
                                <td>
                                    <span class="emp-name">{{ employee['Title'] }} {{ employee['Name of the Employee'] }}</span>
                                    <span class="emp-id">{{ employee['E.code'] }}</span>
                                </td>

                                {% set default_stage = employee['Stage'] %}
                                {% set roster_info = roster_dict.get(employee['E.code'], {}).get(today) %}
                                {% set assigned_stage = roster_info.get('assigned_stage') if roster_info else default_stage %}
                                <td class="stage-cell">{{ assigned_stage }}</td>

                                {% for day in week_days %}
                                    {% set status = attendance_data.get(employee['E.code'], {}).get(day) %}
                                    {% set day_type = holidays.get(day) %}
                                    {% set is_workday = (day_type == 'Working Day') or (day.weekday() < 5 and day_type != 'Holiday') %}

                                    <td class="{% if not is_workday %}{% if day_type == 'Holiday' %}holiday{% else %}weekend{% endif %}{% endif %}">
                                        {% if is_workday %}
                                            <select name="status-{{ employee['E.code'] }}-{{ day.strftime('%Y-%m-%d') }}" 
                                                    class="status-select {% if status and 'Present' in status %}present{% elif status == 'Absent' %}absent{% endif %}">
                                                <option value="" {% if not status %}selected{% endif %}>-</option>
                                                <option value="Present-1" {% if status == 'Present-1' %}selected{% endif %}>P (S1)</option>
                                                <option value="Present-2" {% if status == 'Present-2' %}selected{% endif %}>P (S2)</option>
                                                <option value="Absent" {% if status == 'Absent' %}selected{% endif %}>Abs</option>
                                            </select>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% else %}
                            <tr><td colspan="{{ 2 + 7 }}" style="padding: 40px; color: #94a3b8; text-align: center;">No employees found for this stage.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form>
            </div>
        </div>

        {# --- VIEW 2: MANAGE --- #}
        <div id="manage-view" style="display: none;">
            <div class="manage-container">
                <div class="manage-toolbar">
                    <h2 style="font-size: 1.1rem; margin: 0; color: var(--text-main); font-weight: 700;">Employee Directory</h2>
                    <button id="show-add-modal-btn" class="button button-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add New Employee
                    </button>
                </div>

                <div style="border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden;">
                    <table id="manage-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">E.code</th>
                                <th>Full Name</th>
                                <th>Company / Contract</th>
                                <th>Date of Joining</th>
                                <th>Default Stage</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in manage_employees %}
                            <tr>
                                <td style="font-family: monospace; font-weight: 600; color: #334155;">{{ employee['E.code'] }}</td>
                                <td style="font-weight: 600;">{{ employee['Title'] }} {{ employee['Name of the Employee'] }}</td>
                                <td>{{ employee['Company / Contract'] }}</td>
                                <td>{{ employee['DOJ'].strftime('%d-%b-%Y') if employee['DOJ'] else 'N/A' }}</td>
                                <td><span class="stage-badge">{{ employee['Stage'] }}</span></td>
                                
                                <td style="text-align: right;">
                                    <div class="action-btn-group" style="justify-content: flex-end; display: flex; gap: 8px;">
                                        <button class="button button-small button-secondary"
                                            onclick="populateEditModal(this)"
                                            data-ecode="{{ employee['E.code'] }}"
                                            data-title="{{ employee['Title'] or '' }}"
                                            data-name="{{ employee['Name of the Employee'] }}"
                                            data-company="{{ employee['Company / Contract'] }}"
                                            data-doj="{{ employee['DOJ'].strftime('%Y-%m-%d') if employee['DOJ'] else '' }}"
                                            data-stage="{{ employee['Stage'] }}">
                                            Edit
                                        </button>

                                        <form action="{{ url_for('remove_employee') }}" method="POST" onsubmit="return confirm('Remove {{ employee['Name of the Employee'] }}?');">
                                            <input type="hidden" name="e_code" value="{{ employee['E.code'] }}">
                                            <input type="hidden" name="start_date" value="{{ week_days[0].strftime('%Y-%m-%d') }}">
                                            <button type="submit" class="button button-small button-danger">âœ•</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

{# --- Modern Modals --- #}

<div id="add-employee-modal" class="modal">
    <div class="modal-content attendance-modal-content">
        <div class="modal-header settings-header">
            <div class="header-text">
                <h2>New Employee</h2>
                <p>Register a new worker in the system</p>
            </div>
            <span class="close-button">&times;</span>
        </div>
        
        <div class="modal-body settings-body">
            <form id="add-employee-form" action="{{ url_for('add_employee') }}" method="POST">
                <div class="modal-form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Employee Code</label>
                        <input type="text" name="e_code" class="modal-input" required placeholder="e.g. E001">
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Title</label>
                        <div class="select-wrapper">
                            <select name="title" class="modal-input" required>
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Full Name</label>
                        <input type="text" name="name" class="modal-input" required placeholder="John Doe">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Company / Contract</label>
                        <input type="text" name="company" class="modal-input" required placeholder="Company Name">
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Date of Joining</label>
                        <input type="date" name="doj" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Default Stage</label>
                        <div class="select-wrapper">
                            <select name="stage" class="modal-input" required>
                                <option value="" disabled selected>-- Select Stage --</option>
                                {% for stage in stage_filter_list %}
                                    <option value="{{ stage }}">{{ stage }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="button button-primary">Create Employee</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="edit-employee-modal" class="modal">
    <div class="modal-content attendance-modal-content">
        <div class="modal-header settings-header">
            <div class="header-text">
                <h2 id="edit-modal-title">Edit Employee</h2>
                <p>Update worker details</p>
            </div>
            <span class="close-button">&times;</span>
        </div>

        <div class="modal-body settings-body">
            <form id="edit-employee-form" action="{{ url_for('edit_employee') }}" method="POST">
                <input type="hidden" id="edit_original_e_code" name="original_e_code">
                
                <div class="modal-form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Employee Code</label>
                        <input type="text" id="edit_e_code" name="e_code" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Title</label>
                        <div class="select-wrapper">
                            <select id="edit_title" name="title" class="modal-input" required>
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Full Name</label>
                        <input type="text" id="edit_name" name="name" class="modal-input" required>
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="modal-label">Company / Contract</label>
                        <input type="text" id="edit_company" name="company" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Date of Joining</label>
                        <input type="date" id="edit_doj" name="doj" class="modal-input" required>
                    </div>

                    <div class="form-group">
                        <label class="modal-label">Default Stage</label>
                        <div class="select-wrapper">
                            <select id="edit_stage" name="stage" class="modal-input" required>
                                {% for stage in stage_filter_list %}
                                    <option value="{{ stage }}">{{ stage }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="button button-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.attendanceConfig = {
        urls: {
            markSingle: "{{ url_for('mark_single_attendance') }}",
            attendanceBase: "{{ url_for('attendance') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/attendance.js') }}"></script>
{% endblock %}