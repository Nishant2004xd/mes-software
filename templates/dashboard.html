{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    {% if current_view == 'details' %}
    <div id="fullscreen-toggle" title="Toggle Fullscreen">
        <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        <svg id="fullscreen-exit-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
    </div>
    <div class="details-view-wrapper">
        <div>
            <div class="details-header">
                <h2>Details for {{ filter_type|title }}: {{ filter_value }}</h2>
                <a href="{{ url_for('dashboard') }}" class="button">Back to Overview</a>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>S.No</th><th>Item code</th><th>Type</th><th>Category</th><th>Model</th>
                            <th>Opening Trigger</th><th>PDI</th><th>Powder coating</th>
                            <th>Hydro Testing</th><th>Dispatched</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in details_data %}
                        <tr>
                            <td>{{ item['S.No.'] }}</td><td class="align-left">{{ item['Item code '] }}</td><td>{{ item['Type'] }}</td>
                            <td>{{ item['Category'] }}</td><td>{{ item['Model'] }}</td><td>{{ item['Opening Trigger']|int }}</td>
                             <td>{{ item['PDI']|int }}</td><td>{{ item['Powder coating']|int }}</td>
                            <td>{{ item['Hydro Testing']|int }}</td><td>{{ item['Dispatched']|int }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="10" class="placeholder">No detailed data found for this filter.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

{% else %}
    <div class="dashboard-section">
        <div class="stage-cards-container">
            <div class="stage-card" data-stage="Total-Inv">
                <div class="count">0</div> <div class="stage-name">Total WIP Inv</div>
            </div>

{% for stage in stages %}
            <div class="stage-card drop-target" data-stage="{{ stage }}">
                <div class="count">{{ stage_totals.get(stage, 0)|int }}</div>
                <div class="stage-name">{{ stage }}</div>
            </div>
{% endfor %}

            <div class="stage-card monthly-dispatch-card" data-stage="MonthlyDispatch">
                <div class="count">{{ total_monthly_dispatch|int }}</div>
                <div class="stage-name">Monthly Dispatch</div>
            </div>
            
            {# --- Daily Adherence Card --- #}
            {% set daily_percent = daily_adherence|float %}
            {% if daily_percent > 100 %}{% set daily_percent = 100 %}{% endif %}
            {% if daily_percent < 0 %}{% set daily_percent = 0 %}{% endif %}
            {% set daily_hue = (daily_percent * 1.2)|int %}
            {% set daily_saturation = '80%' %}
            {% set daily_lightness = '85%' %}
            {% set daily_card_style = 'background-color: hsl(%d, %s, %s); color: #333;'|format(daily_hue, daily_saturation, daily_lightness) %}

            <div class="stage-card" data-metric="daily-adherence" style="{{ daily_card_style }}">
                <div class="count">{{ daily_adherence|round(1) }}%</div>
                <div class="stage-name">Daily Adherence</div>
            </div>
            {% set m_percent = monthly_trigger_adherence|float %}
            {% if m_percent > 100 %}{% set m_percent = 100 %}{% endif %}
            {% if m_percent < 0 %}{% set m_percent = 0 %}{% endif %}

            {# Calculate Color: 0% = Red(0), 100% = Green(120) #}
            {% set m_hue = (m_percent * 1.2)|int %}
            {% set m_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(m_hue) %}
            <div class="stage-card" data-metric="monthly-trigger-adherence" style="background-color: #f3e8ff; color: #333;">
                <div class="count">{{ monthly_trigger_adherence|round(1) }}%</div>
                <div class="stage-name">Monthly Trigger Adherence</div>
            </div>
            
        </div>
    </div>

    <div class="dashboard-tables-container">
        <div class="table-wrapper">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th colspan="11" class="table-title">Daily Production Plan</th></tr>
                        <tr>
                            <th>S.No.</th>
                            <th>Item code</th>
                            <th class="description-col">Description</th>
                            <th>Opening Due Trigger</th>
                            <th style="background-color: #f1f5f9; color: #64748b;">Next Pending</th> <th>Pending</th>

                            <th>Dispatch</th>
                            <th>FG</th>
                            <th>PC</th>
                            <th>Hydro</th>

                            <th id="failure-header-toggle" title="Click to Show/Hide Failure Buttons">Failure â–¾</th>
                        </tr>
                    </thead>
                    <tbody id="plan-table-body">
                        {% for plan in top_plans %}
                        {% set percent = plan.ItemAdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row draggable-item" draggable="true"
                            data-item-code="{{ plan['Item code '] }}"
                            data-filter-type="item_code"
                            data-filter-value="{{ plan['Item code '] }}">

                            <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                            <td class="align-left">{{ plan['Item code '] }}</td>
                            <td class="align-left description-col">{{ plan['Description'] }}</td>

                            <td style="{{ cell_style }}">{{ plan['Opening Trigger']|int }}</td>
                            <td style="color: #64748b;">{{ plan['Next Pending']|int }}</td> <td style="font-weight: bold; color: #d95319;">{{ plan['Pending']|int }}</td>

                            <td>{{ plan['Dispatch']|int }}</td>
                            <td>{{ plan['FG']|int }}</td>
                            <td>{{ plan['Powder coating']|int }}</td>
                            <td>{{ plan['Hydro Testing']|int }}</td>

                            <td class="reason-cell">
                                {% set failure_qty = plan.FailureInTrigger|int %}
                                {% if failure_qty > 0 and (show_failure_button == True) %}
                                    <button class="button reason-btn {% if plan.SavedReason %}has-reason{% endif %}"
                                            data-item-code="{{ plan['Item code '] }}"
                                            data-failed-qty="{{ failure_qty }}"
                                            data-saved-reason="{{ plan.SavedReason or '' }}"
                                            title="{{ plan.SavedReason or 'Log Reason' }}">
                                            {{ failure_qty }} Fail
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="11" class="placeholder">No plan data available.</td></tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

            {% if pagination and pagination.total > pagination.per_page %}
            <div class="pagination-container" id="plan-pagination" style="padding-top: 0px; padding-bottom: 5px;">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="#" data-page="{{ pagination.prev_num }}">&laquo;</a>
                        </li>
                        {% for page_num in range(1, pagination.total_pages + 1) %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                            </li>
                        {% endfor %}
                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                            <a class="page-link" href="#" data-page="{{ pagination.next_num }}">&raquo;</a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>

        <div class="table-wrapper overview-tables-wrapper">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th colspan="5" class="table-title">Vertical Wise Overview</th></tr>
                        <tr><th>Vertical</th><th>Opening Trigger</th><th>Pending</th><th>Dispatch</th><th>Action</th></tr>
                    </thead>
                    <tbody id="vertical-table-body">
                        {% for item in vertical_overview %}
                        {% set percent = item.AdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row" data-filter-type="vertical" data-filter-value="{{ item['Vertical'] }}">
                            <td class="align-left">{{ item['Vertical'] }}</td>
                            <td style="{{ cell_style }}">{{ item['Opening Trigger']|int }}</td>
                            <td style="font-weight: bold;">{{ item['Pending']|int }}</td>
                            <td>{{ item['Dispatch']|int }}</td>
                            <td><a href="{{ url_for('dashboard', view='details', type='vertical', value=item['Vertical']) }}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="placeholder">No data available.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>{{ vertical_overview|sum(attribute='Opening Trigger')|int }}</td>
                            <td>{{ vertical_overview|sum(attribute='Pending')|int }}</td>
                            <td>{{ vertical_overview|sum(attribute='Dispatch')|int }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="table-container" style="margin-top: 15px;">
                <table>
                    <thead>
                        <tr><th colspan="5" class="table-title">Category Wise Overview</th></tr>
                        <tr><th>Category</th><th>Opening Trigger</th><th>Pending</th><th>Dispatch</th><th>Action</th></tr>
                    </thead>
                    <tbody id="category-table-body">
                        {% for item in category_overview %}
                        {% set percent = item.AdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row" data-filter-type="category" data-filter-value="{{ item['Category'] }}">
                            <td class="align-left">{{ item['Category'] }}</td>
                            <td style="{{ cell_style }}">{{ item['Opening Trigger']|int }}</td>
                            <td style="font-weight: bold;">{{ item['Pending']|int }}</td>
                            <td>{{ item['Dispatch']|int }}</td>
                            <td><a href="{{ url_for('dashboard', view='details', type='category', value=item['Category']) }}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="placeholder">No data available.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>{{ category_overview|sum(attribute='Opening Trigger')|int }}</td>
                            <td>{{ category_overview|sum(attribute='Pending')|int }}</td>
                            <td>{{ category_overview|sum(attribute='Dispatch')|int }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
{% endif %}
<div id="failure-reason-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Log Failure Reason</h3>

        <div class="modal-info">
            Item Code: <strong id="reason-modal-item-code"></strong><br>
            Failed Quantity Today: <strong id="reason-modal-failed-qty"></strong>
        </div>

        <form id="failure-reason-form">
             <input type="hidden" id="reason-modal-item-code-hidden" name="item_code">
             <input type="hidden" id="reason-modal-failed-qty-hidden" name="failed_quantity">

            <div>
                <label for="reason-modal-select">Reason:</label>
                <select id="reason-modal-select" name="reason" class="modal-input" required>
                    <option value="">-- Select Reason --</option>
                    {% for reason in failure_reasons %}
                    <option value="{{ reason }}">{{ reason }}</option>
                    {% endfor %}
                 </select>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
                 <button type="button" id="reason-modal-clear-btn" class="button button-secondary" style="margin-right: 10px;">Clear Reason</button>
                 <button type="submit" class="button">Save Reason</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.dashboardConfig = {
        stages: {{ stages|tojson }},
        urls: {
            adherenceFiltered: "{{ url_for('api_adherence_filtered') }}",
            inventoryFiltered: "{{ url_for('api_inventory_filtered') }}",
            stageTotals: "{{ url_for('api_stage_totals') }}",
            adherenceTotals: "{{ url_for('api_adherence_totals') }}",
            planPage: "{{ url_for('api_plan_page') }}",
            verticalOverview: "{{ url_for('api_vertical_overview') }}",
            categoryOverview: "{{ url_for('api_category_overview') }}",
            logFailureReason: "{{ url_for('log_failure_reason') }}",
            dispatchItem: "{{ url_for('dispatch_item') }}",
            moveItem: "{{ url_for('move_item') }}"
        }
    };
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v=6"></script>
{% endblock %}