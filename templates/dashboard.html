{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    /* --- Layout & Grid --- */
    .dashboard-section { margin-top: -20px; margin-bottom: 10px; }

    .stage-cards-container {
        display: grid;
        grid-template-columns: repeat(13, minmax(0, 1fr));
        gap: 5px;
        margin-top: 10px;
    }

    .stage-card {
        background-color: #fff;
        border: 1px solid #000;
        border-radius: 6px;
        padding: 8px 4px;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        text-align: center;
        min-height: 55px;
    }
    .stage-card:first-child {
        grid-column: span 1;
        background-color: #e5e7eb;
        border: 1px solid #374151;
    }

    .stage-card .count {
        font-size: 1.5rem;
        font-weight: 600;
        line-height: 1;
        display: block;
        width: 100%;
    }
    .stage-card .stage-name {
        font-size: 0.65rem;
        text-align: center;
        white-space: normal;
        word-break: break-word;
        line-height: 1.1;
    }

    /* --- Tables --- */
    .dashboard-tables-container, .details-view-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        justify-content: center;
    }
    .dashboard-tables-container .table-wrapper, .details-view-wrapper .table-container {
        flex-shrink: 0;
    }

    /* Main Plan Table Font Size */
    .dashboard-tables-container table, .details-view-wrapper table {
        font-size: 0.75rem;
        width: auto;
        border-collapse: collapse;
    }

    /* Overview Tables (Vertical/Category) Font Size & Width */
    .dashboard-tables-container .table-wrapper:last-child table {
        font-size: 0.8rem;
        width: 100%;
    }
    .dashboard-tables-container .table-wrapper:last-child {
        flex-shrink: 1;
        min-width: 0;
    }

    .dashboard-tables-container th, .dashboard-tables-container td,
    .details-view-wrapper th, .details-view-wrapper td {
        padding: 0px 3px;
        font-size: 0.84rem;
        text-align: center;
        white-space: nowrap;
        border: 1px solid #000;
        line-height: 0.98;
    }

    /* Overview Table Padding Overrides */
    .dashboard-tables-container .table-wrapper:last-child th {
        padding: 8px 10px;
        white-space: normal;
        vertical-align: middle;
    }
    .dashboard-tables-container .table-wrapper:last-child td {
        padding: 7px 10px;
        white-space: normal;
        vertical-align: middle;
    }
    /* Fixed widths for Overview number columns */
    .dashboard-tables-container .table-wrapper:last-child th:nth-child(2),
    .dashboard-tables-container .table-wrapper:last-child th:nth-child(3),
    .dashboard-tables-container .table-wrapper:last-child th:nth-child(4) {
        max-width: 65px;
    }

    .dashboard-tables-container td.align-left, .details-view-wrapper td.align-left { text-align: left; }
    .description-col { max-width: 180px; white-space: normal; }
    .total-row td { font-weight: bold; border-top: 2px solid #000; background-color: #f8f9fa; }
    .table-title { font-size: 0.9rem; font-weight: 600; padding: 4px; background-color: #e9ecef; }

    /* --- Interaction --- */
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background-color: #e9ecef; }
    .selected-row { background-color: #dbeafe !important; font-weight: bold; }

    .draggable-item { cursor: grab; }
    .draggable-item:active { cursor: grabbing; }
    .draggable-item.dragging { opacity: 0.5; background-color: #f0f0f0; }
    .drop-target.drag-over { background-color: #d1e7dd !important; border: 2px dashed #0f5132; }

    /* --- Failure Reason Toggle Logic --- */

    /* 1. Header Button Style */
    #failure-header-toggle {
        cursor: pointer;
        user-select: none;
        background-color: #fee2e2; /* Light Red */
        color: #991b1b;
        transition: background-color 0.2s;
    }
    #failure-header-toggle:hover {
        background-color: #fecaca;
    }
    #failure-header-toggle.active {
        background-color: #ef4444;
        color: white;
    }

    /* 2. Cell & Button Style */
    .reason-cell {
        min-width: auto;
        width: 80px;
        padding: 2px !important;
        vertical-align: middle;
    }
    .reason-btn {
        padding: 3px 8px;
        font-size: 0.75em;
        width: 100%;
        background-color: #ffc107;
        color: #333;
        border: 1px solid #d39e00;
        display: none; /* HIDDEN BY DEFAULT */
    }
    .reason-btn.has-reason {
        background-color: #fffbeb;
        border-color: #fcd34d;
        color: #78350f;
    }
    .reason-btn:hover { background-color: #e0a800; }

    /* 3. SHOW ONLY WHEN CLASS IS PRESENT */
    #plan-table-body.show-failures .reason-btn {
        display: inline-block;
    }

    /* --- Modal --- */
    #failure-reason-modal label { display: block; margin-bottom: 5px; font-weight: 500; }
    #failure-reason-modal select { width: 100%; padding: 8px; }
    #failure-reason-modal .modal-info { margin-bottom: 15px; font-size: 0.9em; color: var(--text-secondary); }
    #failure-reason-modal .modal-info strong { color: var(--text-primary); }

    /* --- Fullscreen Icon --- */
    #fullscreen-toggle {
        position: fixed; top: 75px; right: 30px; cursor: pointer; color: #888; z-index: 1050;
    }
    #fullscreen-toggle:hover { color: #000; }

    .details-view-wrapper > div { width: fit-content; margin: 0 auto; }
    .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 15px; padding-right: 30px; }
    .details-header h2 { margin: 0; }
</style>

{% if current_view == 'details' %}
    <div id="fullscreen-toggle" title="Toggle Fullscreen">
        <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        <svg id="fullscreen-exit-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
    </div>
    <div class="details-view-wrapper">
        <div>
            <div class="details-header">
                <h2>Details for {{ filter_type|title }}: {{ filter_value }}</h2>
                <a href="{{ url_for('dashboard') }}" class="button">Back to Overview</a>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>S.No</th><th>Item code</th><th>Type</th><th>Category</th><th>Model</th>
                            <th>Opening Trigger</th><th>PDI</th><th>Powder coating</th>
                            <th>Hydro Testing</th><th>Dispatched</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in details_data %}
                        <tr>
                            <td>{{ item['S.No.'] }}</td><td class="align-left">{{ item['Item code '] }}</td><td>{{ item['Type'] }}</td>
                            <td>{{ item['Category'] }}</td><td>{{ item['Model'] }}</td><td>{{ item['Opening Trigger']|int }}</td>
                             <td>{{ item['PDI']|int }}</td><td>{{ item['Powder coating']|int }}</td>
                            <td>{{ item['Hydro Testing']|int }}</td><td>{{ item['Dispatched']|int }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="10" class="placeholder">No detailed data found for this filter.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

{% else %}
    <div class="dashboard-section">
        <div class="stage-cards-container">
            <div class="stage-card" data-stage="Total-Inv">
                <div class="count">0</div> <div class="stage-name">Total WIP Inv</div>
            </div>

{% for stage in stages %}
            <div class="stage-card drop-target" data-stage="{{ stage }}">
                <div class="count">{{ stage_totals.get(stage, 0)|int }}</div>
                <div class="stage-name">{{ stage }}</div>
            </div>
{% endfor %}

            <div class="stage-card monthly-dispatch-card" data-stage="MonthlyDispatch">
                <div class="count">{{ total_monthly_dispatch|int }}</div>
                <div class="stage-name">Monthly Dispatch</div>
            </div>
            {# --- Daily Adherence Card --- #}
            {% set daily_percent = daily_adherence|float %}
            {% if daily_percent > 100 %}{% set daily_percent = 100 %}{% endif %}
            {% if daily_percent < 0 %}{% set daily_percent = 0 %}{% endif %}
            {% set daily_hue = (daily_percent * 1.2)|int %}
            {% set daily_saturation = '80%' %}
            {% set daily_lightness = '85%' %}
            {% set daily_card_style = 'background-color: hsl(%d, %s, %s); color: #333;'|format(daily_hue, daily_saturation, daily_lightness) %}

            <div class="stage-card" data-metric="daily-adherence" style="{{ daily_card_style }}">
                <div class="count">{{ daily_adherence|round(1) }}%</div>
                <div class="stage-name">Daily Adherence</div>
            </div>

            {# --- Monthly Adherence Card --- #}
            {% set monthly_percent = monthly_adherence|float %}
            {% if monthly_percent > 100 %}{% set monthly_percent = 100 %}{% endif %}
            {% if monthly_percent < 0 %}{% set monthly_percent = 0 %}{% endif %}
            {% set monthly_hue = (monthly_percent * 1.2)|int %}
            {% set monthly_saturation = '80%' %}
            {% set monthly_lightness = '85%' %}
            {% set monthly_card_style = 'background-color: hsl(%d, %s, %s); color: #333;'|format(monthly_hue, monthly_saturation, monthly_lightness) %}

            <div class="stage-card" data-metric="monthly-adherence" style="{{ monthly_card_style }}">
                <div class="count">{{ monthly_adherence|round(1) }}%</div>
                <div class="stage-name">Monthly Adherence</div>
            </div>
        </div>
    </div>

    <div class="dashboard-tables-container">
        <div class="table-wrapper">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th colspan="10" class="table-title">Daily Production Plan</th></tr>
                        <tr>
                            <th>S.No.</th>
                            <th>Item code</th>
                            <th class="description-col">Description</th>
                            <th>Opening Trigger</th>
                            <th>Pending</th>

                            <th>Dispatch</th>
                            <th>FG</th>
                            <th>PC</th>
                            <th>Hydro</th>

                            <th id="failure-header-toggle" title="Click to Show/Hide Failure Buttons">Failure ▾</th>
                        </tr>
                    </thead>
                    <tbody id="plan-table-body">
                        {% for plan in top_plans %}
                        {% set percent = plan.ItemAdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row draggable-item" draggable="true"
                            data-item-code="{{ plan['Item code '] }}"
                            data-filter-type="item_code"
                            data-filter-value="{{ plan['Item code '] }}">

                            <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                            <td class="align-left">{{ plan['Item code '] }}</td>
                            <td class="align-left description-col">{{ plan['Description'] }}</td>

                            <td style="{{ cell_style }}">{{ plan['Opening Trigger']|int }}</td>

                            <td style="font-weight: bold; color: #d95319;">{{ plan['Pending']|int }}</td>

                            <td>{{ plan['Dispatch']|int }}</td>
                            <td>{{ plan['FG']|int }}</td>
                            <td>{{ plan['Powder coating']|int }}</td>
                            <td>{{ plan['Hydro Testing']|int }}</td>

                            <td class="reason-cell">
                                {% set failure_qty = plan.FailureInTrigger|int %}
                                {% if failure_qty > 0 and (show_failure_button == True) %}
                                    <button class="button reason-btn {% if plan.SavedReason %}has-reason{% endif %}"
                                            data-item-code="{{ plan['Item code '] }}"
                                            data-failed-qty="{{ failure_qty }}"
                                            data-saved-reason="{{ plan.SavedReason or '' }}"
                                            title="{{ plan.SavedReason or 'Log Reason' }}">
                                        {{ failure_qty }} Fail
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="10" class="placeholder">No plan data available.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if pagination and pagination.total > pagination.per_page %}
            <div class="pagination-container" id="plan-pagination" style="padding-top: 0px; padding-bottom: 5px;">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="#" data-page="{{ pagination.prev_num }}">&laquo;</a>
                        </li>
                        {% for page_num in range(1, pagination.total_pages + 1) %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                            </li>
                        {% endfor %}
                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                            <a class="page-link" href="#" data-page="{{ pagination.next_num }}">&raquo;</a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>

        <div class="table-wrapper overview-tables-wrapper">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th colspan="5" class="table-title">Vertical Wise Overview</th></tr>
                        <tr><th>Vertical</th><th>Opening Trigger</th><th>Pending</th><th>Dispatch</th><th>Action</th></tr>
                    </thead>
                    <tbody id="vertical-table-body">
                        {% for item in vertical_overview %}
                        {% set percent = item.AdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row" data-filter-type="vertical" data-filter-value="{{ item['Vertical'] }}">
                            <td class="align-left">{{ item['Vertical'] }}</td>
                            <td style="{{ cell_style }}">{{ item['Opening Trigger']|int }}</td>
                            <td style="font-weight: bold;">{{ item['Pending']|int }}</td>
                            <td>{{ item['Dispatch']|int }}</td>
                            <td><a href="{{ url_for('dashboard', view='details', type='vertical', value=item['Vertical']) }}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="placeholder">No data available.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>{{ vertical_overview|sum(attribute='Opening Trigger')|int }}</td>
                            <td>{{ vertical_overview|sum(attribute='Pending')|int }}</td>
                            <td>{{ vertical_overview|sum(attribute='Dispatch')|int }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="table-container" style="margin-top: 15px;">
                <table>
                    <thead>
                        <tr><th colspan="5" class="table-title">Category Wise Overview</th></tr>
                        <tr><th>Category</th><th>Opening Trigger</th><th>Pending</th><th>Dispatch</th><th>Action</th></tr>
                    </thead>
                    <tbody id="category-table-body">
                        {% for item in category_overview %}
                        {% set percent = item.AdherencePercent|float %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                        {% if percent < 0 %}{% set percent = 0 %}{% endif %}
                        {% set hue = (percent * 1.2)|int %}
                        {% set cell_style = 'background-color: hsl(%d, 80%%, 85%%); color: #333;'|format(hue) %}

                        <tr class="clickable-row" data-filter-type="category" data-filter-value="{{ item['Category'] }}">
                            <td class="align-left">{{ item['Category'] }}</td>
                            <td style="{{ cell_style }}">{{ item['Opening Trigger']|int }}</td>
                            <td style="font-weight: bold;">{{ item['Pending']|int }}</td>
                            <td>{{ item['Dispatch']|int }}</td>
                            <td><a href="{{ url_for('dashboard', view='details', type='category', value=item['Category']) }}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="placeholder">No data available.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td>{{ category_overview|sum(attribute='Opening Trigger')|int }}</td>
                            <td>{{ category_overview|sum(attribute='Pending')|int }}</td>
                            <td>{{ category_overview|sum(attribute='Dispatch')|int }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
{% endif %}
<div id="failure-reason-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Log Failure Reason</h3>

        <div class="modal-info">
            Item Code: <strong id="reason-modal-item-code"></strong><br>
            Failed Quantity Today: <strong id="reason-modal-failed-qty"></strong>
        </div>

        <form id="failure-reason-form">
             <input type="hidden" id="reason-modal-item-code-hidden" name="item_code">
             <input type="hidden" id="reason-modal-failed-qty-hidden" name="failed_quantity">

            <div>
                <label for="reason-modal-select">Reason:</label>
                <select id="reason-modal-select" name="reason" class="modal-input" required>
                    <option value="">-- Select Reason --</option>
                    {% for reason in failure_reasons %}
                    <option value="{{ reason }}">{{ reason }}</option>
                    {% endfor %}
                 </select>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
                 <button type="button" id="reason-modal-clear-btn" class="button button-secondary" style="margin-right: 10px;">Clear Reason</button>
                 <button type="submit" class="button">Save Reason</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- GLOBAL VARIABLES ---
    let currentPage = 1;
    const stages = {{ stages|tojson }};

    // Track selections for filtering
    let currentSelections = {
        item_code: new Set(),
        vertical: new Set(),
        category: new Set()
    };

    // DOM Elements
    const failureHeader = document.getElementById('failure-header-toggle');
    const planTableBody = document.getElementById('plan-table-body');
    const verticalTableBody = document.getElementById('vertical-table-body');
    const categoryTableBody = document.getElementById('category-table-body');

    // ---------------------------------------------------------
    // 1. DATA FETCHING (Real-Time Polling + Filtering)
    // ---------------------------------------------------------
    function refreshDashboardData() {
        if (!planTableBody) return;

        // Prepare Filter Payload
        const payload = {
            item_code: Array.from(currentSelections.item_code),
            vertical: Array.from(currentSelections.vertical),
            category: Array.from(currentSelections.category)
        };

        const hasFilters = payload.item_code.length > 0 || payload.vertical.length > 0 || payload.category.length > 0;

        // A. Update Top Cards (WIP & Adherence)
        // Switch between Standard API and Filtered API based on selection
        if (hasFilters) {
            // FILTERED FETCH (POST)
            fetch("{{ url_for('api_inventory_filtered') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(updateCards)
            .catch(console.error);

            fetch("{{ url_for('api_adherence_filtered') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(updateAdherenceCards)
            .catch(console.error);

        } else {
            // STANDARD FETCH (GET)
            fetch("{{ url_for('api_stage_totals') }}")
                .then(r => r.json())
                .then(updateCards)
                .catch(console.error);

            fetch("{{ url_for('api_adherence_totals') }}")
                .then(r => r.json())
                .then(updateAdherenceCards)
                .catch(console.error);
        }

        // B. Update Tables (These always show full lists, just highlighted)
        fetch(`{{ url_for('api_plan_page') }}?page=${currentPage}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    updatePlanTable(data.plans, data.per_page, data.current_page, data.show_failure_button);
                    updatePlanPagination(data.total_pages, data.current_page);
                    attachDragEvents();
                    restoreSelectionHighlights(); // Keep rows green
                }
            })
            .catch(console.error);

        fetch("{{ url_for('api_vertical_overview') }}")
            .then(r => r.json())
            .then(data => {
                updateOverviewTable(verticalTableBody, data, 'Vertical', 'vertical');
                restoreSelectionHighlights();
            })
            .catch(console.error);

        fetch("{{ url_for('api_category_overview') }}")
            .then(r => r.json())
            .then(data => {
                updateOverviewTable(categoryTableBody, data, 'Category', 'category');
                restoreSelectionHighlights();
            })
            .catch(console.error);
    }

    // ---------------------------------------------------------
    // 2. INTERACTION LOGIC (Clicking Rows)
    // ---------------------------------------------------------

    function handleRowClick(event) {
        // Ignore clicks on buttons/links
        if (event.target.closest('a.button, button.reason-btn')) return;

        const row = event.target.closest('tr.clickable-row');
        if (!row) return;

        const filterType = row.dataset.filterType;
        const filterValue = row.dataset.filterValue;
        const isCtrlClick = event.ctrlKey || event.metaKey;

        // Auto-clear other types (e.g., if clicking Vertical, clear Category selections)
        // This prevents confusing cross-filtering scenarios
        let switchingTypes = false;
        if (filterType === 'item_code' && (currentSelections.vertical.size > 0 || currentSelections.category.size > 0)) switchingTypes = true;
        if (filterType === 'vertical' && (currentSelections.item_code.size > 0 || currentSelections.category.size > 0)) switchingTypes = true;
        if (filterType === 'category' && (currentSelections.item_code.size > 0 || currentSelections.vertical.size > 0)) switchingTypes = true;

        if (switchingTypes) {
            currentSelections.item_code.clear();
            currentSelections.vertical.clear();
            currentSelections.category.clear();
        }

        // Toggle Selection
        if (isCtrlClick) {
            // Multi-select logic
            if (currentSelections[filterType].has(filterValue)) {
                currentSelections[filterType].delete(filterValue);
            } else {
                currentSelections[filterType].add(filterValue);
            }
        } else {
            // Single-select logic
            const alreadySelected = currentSelections[filterType].has(filterValue) && currentSelections[filterType].size === 1;
            currentSelections[filterType].clear();
            if (!alreadySelected) {
                currentSelections[filterType].add(filterValue);
            }
        }

        // Update UI immediately
        restoreSelectionHighlights();
        refreshDashboardData(); // Trigger data update for cards
    }

    // Helper: Re-applies the 'selected-row' class after table refresh
    function restoreSelectionHighlights() {
        document.querySelectorAll('tr.clickable-row').forEach(row => {
            const fType = row.dataset.filterType;
            const fVal = row.dataset.filterValue;
            if (currentSelections[fType] && currentSelections[fType].has(fVal)) {
                row.classList.add('selected-row');
            } else {
                row.classList.remove('selected-row');
            }
        });
    }

    // Attach Listeners
    if (planTableBody) planTableBody.addEventListener('click', handleRowClick);
    if (verticalTableBody) verticalTableBody.addEventListener('click', handleRowClick);
    if (categoryTableBody) categoryTableBody.addEventListener('click', handleRowClick);


    // ---------------------------------------------------------
    // 3. UPDATE FUNCTIONS (Render HTML)
    // ---------------------------------------------------------

    function updateCards(data) {
        let grandTotal = 0;
        stages.forEach(stage => {
            const count = parseInt(data[stage]) || 0;
            if (stage !== 'FG') grandTotal += count;
            const card = document.querySelector(`.stage-card[data-stage="${stage}"]`);
            if (card) card.querySelector('.count').textContent = count;
        });
        const totalCard = document.querySelector('.stage-card[data-stage="Total-Inv"] .count');
        if (totalCard) totalCard.textContent = grandTotal;
        const dispatchCard = document.querySelector('.stage-card.monthly-dispatch-card .count');
        if (dispatchCard && data['Dispatch'] !== undefined) dispatchCard.textContent = parseInt(data['Dispatch']);
    }

    function updateAdherenceCards(data) {
        updateSingleAdherenceCard('daily-adherence', data.daily_adherence);
        updateSingleAdherenceCard('monthly-adherence', data.monthly_adherence);
    }

    function updateSingleAdherenceCard(metric, value) {
        const card = document.querySelector(`.stage-card[data-metric="${metric}"]`);
        if (!card) return;
        let percent = parseFloat(value) || 0;
        percent = Math.max(0, Math.min(100, percent));
        const hue = Math.round(percent * 1.2);
        card.querySelector('.count').textContent = `${percent.toFixed(1)}%`;
        card.style.backgroundColor = `hsl(${hue}, 80%, 85%)`;
    }

    function updatePlanTable(plans, perPage, curPage, showFailureButton) {
         let html = '';
         if (!plans || plans.length === 0) {
             html = '<tr><td colspan="10" class="placeholder">No plan data available.</td></tr>';
         } else {
             plans.forEach((plan, index) => {
                 const serialNumber = (parseInt(curPage) - 1) * parseInt(perPage) + (index + 1);
                 let percent = parseFloat(plan['ItemAdherencePercent']) || 0;
                 percent = Math.max(0, Math.min(100, percent));
                 const hue = Math.round(percent * 1.2);
                 const openingTriggerStyle = `background-color: hsl(${hue}, 80%, 85%); color: #333;`;
                 const pendingStyle = `font-weight: bold; color: #d95319;`;

                 let reasonHtml = '';
                 const failureQty = parseInt(plan['FailureInTrigger']);
                 if (failureQty > 0 && showFailureButton) {
                     const reason = plan['SavedReason'] || '';
                     const escapedReason = reason.replace(/"/g, '&quot;');
                     const hasReasonClass = reason ? ' has-reason' : '';
                     reasonHtml = `<button class="button reason-btn${hasReasonClass}"
                                     data-item-code="${plan['Item code ']}"
                                     data-failed-qty="${failureQty}"
                                     data-saved-reason="${escapedReason}"
                                     title="${reason || 'Log Reason'}">
                                     ${failureQty} Fail
                                   </button>`;
                 }

                 html += `
                 <tr class="clickable-row draggable-item" draggable="true"
                     data-item-code="${plan['Item code ']}"
                     data-filter-type="item_code" data-filter-value="${plan['Item code ']}">
                    <td>${serialNumber}</td>
                    <td class="align-left">${plan['Item code ']}</td>
                    <td class="align-left description-col">${plan['Description']}</td>
                    <td style="${openingTriggerStyle}">${parseInt(plan['Opening Trigger'])}</td>
                    <td style="${pendingStyle}">${parseInt(plan['Pending'])}</td>
                    <td>${parseInt(plan['Dispatch'])}</td>
                    <td>${parseInt(plan['FG'])}</td>
                    <td>${parseInt(plan['Powder coating'])}</td>
                    <td>${parseInt(plan['Hydro Testing'])}</td>
                    <td class="reason-cell">${reasonHtml}</td>
                 </tr>`;
             });
         }
         planTableBody.innerHTML = html;
         if (failureHeader && failureHeader.classList.contains('active')) {
             planTableBody.classList.add('show-failures');
         } else {
             planTableBody.classList.remove('show-failures');
         }
    }

    function updateOverviewTable(tbody, data, keyName, filterType) {
        if (!tbody) return;
        let html = '';
        let totalOpen = 0, totalPend = 0, totalDisp = 0;

        if (!data || data.length === 0) {
            html = '<tr><td colspan="5" class="placeholder">No data available.</td></tr>';
        } else {
            data.forEach(item => {
                totalOpen += parseInt(item['Opening Trigger']);
                totalPend += parseInt(item['Pending']);
                totalDisp += parseInt(item['Dispatch']);
                let percent = parseFloat(item['AdherencePercent']) || 0;
                percent = Math.max(0, Math.min(100, percent));
                const hue = Math.round(percent * 1.2);
                const style = `background-color: hsl(${hue}, 80%, 85%); color: #333;`;

                html += `
                <tr class="clickable-row" data-filter-type="${filterType}" data-filter-value="${item[keyName]}">
                    <td class="align-left">${item[keyName]}</td>
                    <td style="${style}">${parseInt(item['Opening Trigger'])}</td>
                    <td style="font-weight: bold;">${parseInt(item['Pending'])}</td>
                    <td>${parseInt(item['Dispatch'])}</td>
                    <td><a href="/dashboard?view=details&type=${filterType}&value=${encodeURIComponent(item[keyName])}" class="button" style="padding: 1px 5px; font-size: 0.7rem;">Details</a></td>
                </tr>`;
            });
        }
        tbody.innerHTML = html;
        const tfoot = tbody.nextElementSibling;
        if (tfoot) {
            const cells = tfoot.querySelectorAll('td');
            if(cells.length >= 4) {
                cells[1].textContent = totalOpen;
                cells[2].textContent = totalPend;
                cells[3].textContent = totalDisp;
            }
        }
    }

    function updatePlanPagination(totalPages, curPage) {
        const paginationContainer = document.getElementById('plan-pagination');
        if(!paginationContainer) return;
        let html = '<nav aria-label="Page navigation"><ul class="pagination">';
        const prevDisabled = (curPage === 1) ? 'disabled' : '';
        html += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${curPage - 1}">&laquo;</a></li>`;
        for (let i = 1; i <= totalPages; i++) {
            const active = (i === curPage) ? 'active' : '';
            html += `<li class="page-item ${active}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        const nextDisabled = (curPage === totalPages) ? 'disabled' : '';
        html += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${curPage + 1}">&raquo;</a></li>`;
        html += `</ul></nav>`;
        paginationContainer.innerHTML = html;
    }

    // ---------------------------------------------------------
    // 4. EVENT LISTENERS & SETUP
    // ---------------------------------------------------------

    // Pagination
    const planPagination = document.getElementById('plan-pagination');
    if (planPagination) {
        planPagination.addEventListener('click', function(e) {
            e.preventDefault();
            const link = e.target.closest('.page-link');
            if (!link || link.parentElement.classList.contains('disabled')) return;
            currentPage = parseInt(link.dataset.page);
            refreshDashboardData();
        });
    }

    // Failure Toggle
    if (failureHeader && planTableBody) {
        failureHeader.addEventListener('click', function() {
            planTableBody.classList.toggle('show-failures');
            this.classList.toggle('active');
            this.innerHTML = this.classList.contains('active') ? 'Failure ▴' : 'Failure ▾';
        });
    }

    // Failure Modal
    const reasonModal = document.getElementById('failure-reason-modal');
    const reasonForm = document.getElementById('failure-reason-form');
    const reasonSelect = document.getElementById('reason-modal-select');
    const reasonModalItemCodeHidden = document.getElementById('reason-modal-item-code-hidden');
    const reasonModalFailedQtyHidden = document.getElementById('reason-modal-failed-qty-hidden');
    const reasonModalCloseBtn = reasonModal.querySelector('.close-button');
    const reasonModalClearBtn = document.getElementById('reason-modal-clear-btn');

    planTableBody.addEventListener('click', function(event) {
        const button = event.target.closest('button.reason-btn');
        if (button) {
            document.getElementById('reason-modal-item-code').textContent = button.dataset.itemCode;
            document.getElementById('reason-modal-failed-qty').textContent = button.dataset.failedQty;
            reasonModalItemCodeHidden.value = button.dataset.itemCode;
            reasonModalFailedQtyHidden.value = button.dataset.failedQty;
            reasonSelect.value = button.dataset.savedReason.replace(/&quot;/g, '"');
            reasonModal.style.display = 'block';
        }
    });

    reasonForm.addEventListener('submit', function(event) { event.preventDefault(); saveReason(reasonSelect.value); });
    reasonModalClearBtn.addEventListener('click', function() { saveReason(""); });

    function saveReason(reasonValue) {
        const postData = {
            item_code: reasonModalItemCodeHidden.value,
            failed_quantity: parseInt(reasonModalFailedQtyHidden.value),
            reason: reasonValue
        };
        fetch("{{ url_for('log_failure_reason') }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(postData)
        }).then(r => r.json()).then(data => {
            if (data.status === 'success') {
                reasonModal.style.display = 'none';
                refreshDashboardData();
            } else { alert(data.message); }
        });
    }

    if(reasonModalCloseBtn) reasonModalCloseBtn.onclick = () => reasonModal.style.display = 'none';
    window.onclick = (e) => { if(e.target == reasonModal) reasonModal.style.display = 'none'; };

    // Drag & Drop
    let draggedItemCode = null;
    function attachDragEvents() {
        document.querySelectorAll('.draggable-item').forEach(draggable => {
            draggable.addEventListener('dragstart', (e) => {
                draggedItemCode = draggable.getAttribute('data-item-code');
                draggable.classList.add('dragging');
                e.dataTransfer.effectAllowed = "move";
            });
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
                draggedItemCode = null;
            });
        });
    }

    function attachDropEvents() {
        document.querySelectorAll('.drop-target').forEach(target => {
            target.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
            target.addEventListener('dragleave', (e) => { e.currentTarget.classList.remove('drag-over'); });
            target.addEventListener('drop', handleDrop);
        });
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!draggedItemCode) return;
        let toStage = e.currentTarget.getAttribute('data-stage');
        if (e.currentTarget.classList.contains('monthly-dispatch-card')) toStage = 'Dispatch';
        const qty = prompt(`Moving ${draggedItemCode} to ${toStage}. Quantity:`, "1");
        if (qty && parseInt(qty) > 0) {
            const url = (toStage === 'Dispatch') ? '/dispatch_item' : '/move_item';
            const formData = new FormData();
            formData.append('item_code', draggedItemCode);
            formData.append('quantity', qty);
            if(toStage !== 'Dispatch') {
                formData.append('from_stage', 'FG');
                formData.append('to_stage', toStage);
            }
            fetch(url, { method: 'POST', body: formData }).then(() => refreshDashboardData());
        }
    }

    attachDropEvents();

    // Fullscreen
    const fullscreenToggle = document.getElementById('fullscreen-toggle');
    if (fullscreenToggle) {
        const enterIcon = document.getElementById('fullscreen-enter-icon');
        const exitIcon = document.getElementById('fullscreen-exit-icon');
        fullscreenToggle.addEventListener('click', () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => alert(err));
            else if (document.exitFullscreen) document.exitFullscreen();
        });
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) { enterIcon.style.display = 'none'; exitIcon.style.display = 'block'; }
            else { enterIcon.style.display = 'block'; exitIcon.style.display = 'none'; }
        });
    }

    // Init & Poll
    refreshDashboardData();
    if (planTableBody) setInterval(refreshDashboardData, 3000);
});
</script>
{% endblock %}