{% extends "layout.html" %}

{% block title %}Production Planning{% endblock %}
{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/productionpl.css') }}">

    {% set active_view = request.args.get('view', 'production') %}
    {% set has_plan = plans|length > 0 %}

    <div class="page-container">
        <div class="content-card">
            
            {# --- Unified Command Bar --- #}
            <div class="filter-toolbar">
                <div class="toolbar-section" style="display:flex; align-items:center; gap:20px;">
                    <h1 class="toolbar-title">
                        {% if request.args.get('view') == 'overdue' %}Overdue Triggers{% else %}Production Plan{% endif %}
                    </h1>

                    {# View Toggle #}
                    <div class="view-toggle">
                        <a href="{{ url_for('production_planning', view='production') }}" class="toggle-btn {% if request.args.get('view', 'production') == 'production' %}active{% endif %}">Plan</a>
                        <a href="{{ url_for('production_planning', view='overdue') }}" class="toggle-btn {% if request.args.get('view') == 'overdue' %}active{% endif %}">Overdue</a>
                    </div>
                </div>

                {# --- FILTERS FOR PRODUCTION PLAN --- #}
                {% if request.args.get('view', 'production') == 'production' and plan_generated_today %}
                <form action="{{ url_for('production_planning') }}" method="GET" class="toolbar-actions" style="display:flex; gap:10px; align-items:center;">
                    <input type="hidden" name="view" value="production">
                    
                    {# Rows per Page #}
                    <div class="rows-wrapper">
                        <input type="number" name="per_page" value="{{ current_per_page }}" min="1" max="1000" onchange="this.form.submit()" class="rows-input">
                        <span class="rows-label">Rows</span>
                    </div>

                    {# Server-Side Search + Client-Side Real-Time Filter #}
                    <input type="text" id="filter-search" name="search" value="{{ filter_search }}" placeholder="Search Item..." class="filter-input" oninput="filterTable()" autocomplete="off">

                    {# Vertical Dropdown #}
                    <select id="filter-vertical" name="vertical" onchange="this.form.submit()" class="filter-select">
                        <option value="">Vertical: All</option>
                        {% for v in all_verticals %}
                            <option value="{{ v }}" {% if filter_vertical == v %}selected{% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>

                    {# Category Dropdown #}
                    <select id="filter-category" name="category" onchange="this.form.submit()" class="filter-select">
                        <option value="">Category: All</option>
                        {% for c in all_categories %}
                            <option value="{{ c }}" {% if filter_category == c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                    
                    <button type="submit" style="display:none;">Search</button> {# Hidden submit for Enter key #}
                    <a href="{{ url_for('production_planning', view='production') }}" class="button button-text" style="height:30px; padding: 0 10px; line-height:30px;">Reset</a>
                </form>
                
                <div class="toolbar-actions">
                    <form action="{{ url_for('generate_plan') }}" method="POST">
                        <button type="submit" class="button button-primary">Generate</button>
                    </form>
                    <form action="{{ url_for('release_plan') }}" method="POST" onsubmit="return confirm('Release plan to Master?');">
                        <button type="submit" class="button button-success">Release</button>
                    </form>
                </div>

                {% elif request.args.get('view', 'production') == 'production' %}
                    {# Empty State Actions #}
                    <form action="{{ url_for('generate_plan') }}" method="POST">
                        <button type="submit" class="button button-primary">Generate Plan</button>
                    </form>

                {% elif request.args.get('view') == 'overdue' %}
                {# --- FILTERS FOR OVERDUE --- #}
                <div class="toolbar-actions">
                    <form method="GET" action="{{ url_for('production_planning') }}" style="display:flex; gap:8px;">
                        <input type="hidden" name="view" value="overdue">
                        <select name="trigger_type" class="filter-select">
                            <option value="All">Type: All</option>
                            {% for type in trigger_type_list %}
                                <option value="{{ type }}" {% if type == selected_trigger_type %}selected{% endif %}>{{ type }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" name="item_code" placeholder="Item Code..." value="{{ selected_item_code }}" class="filter-input">
                        <button type="submit" class="button button-secondary">Apply</button>
                    </form>
                </div>
                {% endif %}
            </div>

            {# --- Table Content --- #}
            <div class="table-wrapper">
                
                {# View: Production Plan #}
                <div id="production-plan-view" {% if active_view != 'production' %}style="display: none;"{% endif %}>
                    {% if not has_plan %}
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ“Š</div>
                            <h3>Ready to Plan</h3>
                            <p>Generate a plan to see items here.</p>
                        </div>
                    {% else %}
                    <form id="update-plan-form">
                        <table id="production-plan-table" class="modern-table">
                            <thead>
                                <tr>
                                    <th class="col-center" style="width: 40px;">#</th>
                                    <th style="width: 110px;">Item Code</th>
                                    <th>Description</th>
                                    <th class="col-center">Vertical</th>
                                    <th class="col-center">Cat</th>
                                    <th class="col-center">RPL</th>
                                    <th class="col-center">WIP</th>
                                    <th class="col-center">Pending</th>
                                    <th class="col-center bg-highlight">Suggested</th>
                                    <th class="col-center" style="width: 80px;">Modified</th>
                                </tr>
                            </thead>
                            <tbody id="plan-tbody">
                                {% for plan in plans %}
                                <tr class="plan-row group"
                                    data-code="{{ plan['Item code']|lower }}"
                                    data-desc="{{ plan['Description']|lower }}"
                                    data-vertical="{{ plan['Vertical'] }}"
                                    data-category="{{ plan['Category'] }}"
                                    data-type="{{ plan['Type'] }}">

                                    <td class="col-center" style="color: #94a3b8;">{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                                    
                                    <td class="col-code">{{ plan['Item code'] }}</td>
                                    
                                    <td class="col-desc" title="{{ plan['Description'] }}">
                                        {{ plan['Description'] }}
                                        <span style="display:block; font-size: 0.7rem; color: #94a3b8;">{{ plan['Type'] }}</span>
                                    </td>
                                    
                                    <td class="col-center"><span class="badge badge-blue">{{ plan['Vertical'] }}</span></td>
                                    <td class="col-center"><span class="badge badge-gray">{{ plan['Category'] }}</span></td>
                                    <td class="col-center" style="font-family: monospace;">{{ plan['RPL days to Delivery']|int }}</td>
                                    
                                    <td class="col-center" style="color: #0369a1;font-weight:bold">
                                        {{ plan['WIP']|int }}
                                    </td>

                                    <td class="col-center">
                                        {% if plan['Pending'] > 0 %}
                                            <span class="text-pending">{{ plan['Pending']|int }}</span>
                                        {% else %}
                                            <span class="text-good">-</span>
                                        {% endif %}
                                    </td>

                                    <td class="col-center bg-highlight">
                                        {{ plan['Daily Suggested Release Plan'] }}
                                    </td>
                                    
                                    <td class="col-center">
                                        <input type="number" name="modified_plan_{{ plan['Item code'] }}" 
                                            value="{{ plan['Modified Release plan'] }}" 
                                            class="plan-input"
                                            onfocus="this.select()">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </form>

                        <div id="no-results-msg" style="display:none; text-align:center; padding: 40px; color: #64748b;">No items match.</div>
                        
                        {# --- Pagination --- #}
                        {% if pagination and pagination.total_pages > 1 %}
                        <div class="pagination-container">
                            <ul class="pagination">
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('production_planning', page=pagination.prev_num, view='production', per_page=pagination.per_page, search=filter_search, vertical=filter_vertical, category=filter_category) }}">&laquo; Prev</a>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link" style="border: none;">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
                                </li>
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('production_planning', page=pagination.next_num, view='production', per_page=pagination.per_page, search=filter_search, vertical=filter_vertical, category=filter_category) }}">Next &raquo;</a>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>

                {# View: Overdue #}
                <div id="overdue-triggers-view" {% if active_view != 'overdue' %}style="display: none;"{% endif %}>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Trigger Date</th>
                                <th>Due Date</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in overdue_items %}
                            <tr>
                                <td class="col-code">{{ item['Item code'] }}</td>
                                <td class="col-desc">{{ item['ITEM DESCRIPTION'] }}</td>
                                <td class="text-pending">{{ item['Qty'] }}</td>
                                <td>{{ item['TRIGGER DT'] }}</td>
                                <td>{{ item['DUE DT'] }}</td>
                                <td><span class="badge badge-warning">{{ item['TRIGGER TYPE'] }}</span></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" style="text-align:center; padding:40px; color:#94a3b8;">No overdue items.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    window.productionConfig = {
        urls: { updateSinglePlan: "{{ url_for('update_single_plan') }}" }
    };
</script>
<script src="{{ url_for('static', filename='js/productionpl.js') }}"></script>
{% endblock %}